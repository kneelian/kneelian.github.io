<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="this is a devblog for th'ennemy">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>enn-devblog</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="canonical" href="https://example.com/">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark
bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href=".">

            <span id="blog-title">enn-devblog</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item dropdown">
<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">The Blog</a>
            <div class="dropdown-menu">
                    <a href="archive.html/" class="dropdown-item">Archived Posts</a>
                    <a href="posts/" class="dropdown-item">All Posts</a>
            </div>
            </li>
<li class="nav-item dropdown">
<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">About</a>
            <div class="dropdown-menu">
                    <a href="about-me/" class="dropdown-item">About me</a>
            </div>
                </li>
<li class="nav-item">
<a href="categories/index.html" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="pages/contact.html" class="nav-link">Contact</a>

                
            </li>
</ul>
<ul class="navbar-nav navbar-right">
<li>
            </li>
<li class="nav-item"><a href="ru/" rel="alternate" hreflang="ru" class="nav-link">Русский</a></li>

                
                    
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html" class="u-url">Thoughts about Memory Management on Bare Metal, pt. 1</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                enn
            </span></p>
            <p class="dateline">
            <a href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html" rel="bookmark">
            <time class="published dt-published" datetime="2025-04-07T16:10:30+02:00" itemprop="datePublished" title="2025-04-07 16:10">2025-04-07 16:10</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <section id="prelude"><h2>Prelude</h2>
<p>Recently I've been toying with some weird, cheap SBCs that offer
a lot for way too little money. You can actually get a device with
a pressure-sensitive 320x240 screen, 4M flash and 512K RAM for
under ten bucks <img alt="Moggers" src="emoji/moggers.png" style="width: 32px;"> so obviously what I did was that I did
get one of those and decided to see what I could do with it.</p>
<p>Enter the <strong>Cheap Yellow Display</strong> (or CYD for short), name courtesy of
<a class="reference external" href="https://github.com/witnessmenow/ESP32-Cheap-Yellow-Display/tree/main">Brian Lough</a>,
that's got one of those fancy Espressiv IoT SOCs, with a Bluetooth stack
and WiFi out of the box, Arduino integration, two cores (one of which
will run the RTOS in an Arduino setup by default, but you can hijack it
and run other code on it), easy interrupt registering (with per-core
control to boot), a decent amount of GPIO pins broken out, and a
resistive LCD touchscreen that's trivial to program for.</p>
<p>Its weakest points are its 520K RAM and 4M flash. This is probably
the one thing that can limit its usability in general, and there are other
ESP32 chips and boards with different configs (8M and 16M flash variants exist,
and many boards also integrate an extra 4/8M of PSRAM, absent on the CYD),
but this is already more than enough for a <em>lot</em> of things you'd want to do.
If you're crazy enough, <a class="reference external" href="https://community.element14.com/challenges-projects/element14-presents/project-videos/w/documents/28339/episode-623-how-to-run-linux-on-an-esp32">you can even run Linux on it</a>
(though the device in the link has 8M of PSRAM, you can probably trim it and make a godawful,
pained, miserable Linux with 512K as well, and it boots just "fine"),
but we're not going down this route because that just feels like hubris:
yes, the old UNIXes did run on hardware with 64-256K RAM, but that was more
than 50 years ago and those machines ate around 9 amps of current at
230V (or at least that's what I'm getting for the PDP-11/20 power
supply); the CYD works at a steady 3.3V/115mA, and is a quintillion times
faster <a class="footnote-reference brackets" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#footnote-1" id="footnote-reference-1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> with a much saner work environment and tools that don't
make you want to immediately <a class="footnote-reference brackets" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#footnote-2" id="footnote-reference-2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> kill yourself, and you can replace
it with basically infinite ease if one dies. Try replacing a PDP-11
on a budget.</p>
<p>Some good things about the lack of PSRAM, though, is that it
<strike> teaches you to use what you have and not be a pussy </strike>​ has
much slower access times and as such you'll want to fall back on fast
internal RAM anyhow; PSRAM would be good for memory you'd access intermittently
rather than hit every cycle. Or maybe this is all just cope. In any case,
520K RAM it is.</p>
<p>It's also a bit more muddied than that: the ESP32 divides its memory space
into two blocks, DRAM for data and IRAM for instructions. These are
asymmetric: DRAM covers some 320K and IRAM covers 200K. <a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32s2/api-guides/memory-types.html">The docs</a> helpfully
state that "[a]ny internal SRAM which is not used for Instruction RAM will
be made available as DRAM (Data RAM) for static data and dynamic allocation (heap)",
which means that if we need &gt;328K data we can claw it back from IRAM, which
helps our case a bit. The ability to execute things from RAM can also help with
hot-loading code from external memory (I've looked a lot into this and concluded
that just writing a parser for external code and then interpreting it is much,
<em>much</em> less painful than hotloading code into IRAM, and we're currently in the middle
of me musing how to implement that properly), so you can actually just drive a slim
OS in RAM and load programs off an SD card, and <a class="reference external" href="https://tactility.one/">one project</a> does
just that <a class="footnote-reference brackets" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#footnote-3" id="footnote-reference-3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a> with quite a bit of charm and polish to it.</p>
<p>The thing is, the ESP32 is powerful enough to run a RTOS (in this case it
bundles FreeRTOS <a class="footnote-reference brackets" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#footnote-4" id="footnote-reference-4" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a> by default and uses it for a bunch of shit), and this
RTOS reserves some memory for itself, and the WiFi and BT stacks can also
eat into this memory for their own purposes (this eats up a whole 64K of RAM
in case you're wondering). A default setup with Arduino
enabling the use of the <code class="docutils literal">Serial</code> library without any screen code
has the non-user code reserve 20080 bytes for global variables,
"leaving 307600 bytes for local variables". The astute reader will see
that this sums up to 327680B, i.e. 320K of RAM. A decent amount
of this is going to the RTOS task scheduler and internal states, and
a bit is going on facilitating dynamic memory allocation. <a class="reference external" href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32s2/api-guides/memory-types.html">The docs</a> also
tell us that there's a technical limitation to how much we can allocate in
what way: we're limited to 160K static allocation, and the remaining 160K
"can only be allocated at runtime as heap".</p>
<p>Loss to overhead isn't that bad, though, truth be told. A more full-featured
programme with a screen and touch driver and SD card code for both reading
and writing takes up 22560B, just under 2.5K more. This is not that awful
considering how much RAM we have, but it'd be proper deadly on a smaller
device like one of the actual Arduinos that <em>have</em> 2.5K RAM in total.</p>
<p>But this all also means that, if we want to use a lot of RAM in our thing,
we have to dynamically allocate more when we start touching the &gt;128K zone.
Dynamic memory allocation on microcontrollers <em>sucks</em>, though, and you'll
fragment the memory space in basically no time and won't be able to recover
from it because there's no actual OS to bail you out. People die when an MCU
upredictably returns <code class="docutils literal">nullptr</code> from a <code class="docutils literal">malloc()</code> call.</p>
<p>One of the solutions is to just allocate everything you can statically
ahead of time, and then 'dynamically' allocate during startup and then
<em>never clean up or call</em> <code class="docutils literal">free()</code> <em>again</em>. The fact that <code class="docutils literal">malloc()</code> can
only give us blocks up to the size of the largest contiguous memory
block and the fact that we're not doing any sophisticated memory mapping
on the fly, this really just means figuring out how big our maximum
memory blocks are and then allocating up to their size and then writing
management code ourselves on top of that. Several tactics for this
include <a class="reference external" href="https://en.wikipedia.org/wiki/Memory_pool">memory pools</a> and <a class="reference external" href="https://en.wikipedia.org/wiki/Slab_allocation">slab allocation</a>, both of which are
pretty neat ideas, and we'll be tapping into their concepts for our
purposes. Let's dive in.</p>
</section><section id="diving-in"><h2>Diving In</h2>
<p>There's something charming about the CYD. Like I've mentioned above, it's
a dual-core system with 520K RAM and whatnot. The ISA the chips are running
can be called <em>unusual</em>: it's called Xtensa and was developed by the IP company
Tensilica. The exact architecture here is the Xtensa LX6 configured to use
32-bit transfers/data buses, and is little-endian. The CYD has a core <em>without</em> vector
extensions, but there are Tensilica cores with SIMD (the ESP32-S3 is one
such example, with some <a class="reference external" href="https://bitbanksoftware.blogspot.com/2024/01/surprise-esp32-s3-has-few-simd.html">weird SIMD features</a> that are genuine nice-to-haves).
The chip offers some good features, a large number of pins broken out,
several serials, JTAG, all the good stuff. The CYD cuts into this a decent
bit by integrating an SD card module, multicoloured LED, a screen, a touch
interface for that screen, a micro-USB port, and a buzzer/speaker
two-wire/mono plug. The result is a still-decent package with 3 clusters of
4 pins exposed, one of which has a 3.3V line, and one of which doubles
as a serial port.</p>
<p>These memory investigations are basically me building up some infrastructure
to support an interpreted programming language running behind the scenes on
the CYD, as a sort of native BASIC-like. There is no practical use to this,
it's just me playing with my toys.</p>
<p>Given that the system has (at least) 320K of SRAM dedicated to data,
this is obviously a good place to start. As no more than 160K can be
statically allocated, and a decent amount of it will be eaten up
by libraries and other code, it becomes "natural" to me to think about
the CYD's RAM in terms of 64K blocks. This might be a problem <a class="footnote-reference brackets" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#footnote-5" id="footnote-reference-5" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a> later,
but currently it seems fine enough.</p>
<p>The screen itself will also want at least 75K of RAM (320 * 240 = 76800, so
if every pixel is one byte that's a clean 75K; though colour performance
might suffer obviously), and possibly more (the screen has 16-bit colour, so
150K RAM, eating up almost half of DRAM in one go). If I buffer the screen and
expose it as a memory zone, that is; this isn't required in any way, and is anyway not
something I care about right now.</p>
<p>In any case, it would be <em>prudent</em> to allocate as much memory as possible for
the application, then manage it manually later, writing an own allocator and deallocator.
It's also perfectly possible to write a kind of "memory mapper" that would provide
a flat contiguous memory space to user code obfuscating the bullshit underneath. One
pseudocode example of such a a remapper would be:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_3248d05c75f54f518e8bd3c43944a826-1" name="rest_code_3248d05c75f54f518e8bd3c43944a826-1" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-2" name="rest_code_3248d05c75f54f518e8bd3c43944a826-2" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-2"></a>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-3" name="rest_code_3248d05c75f54f518e8bd3c43944a826-3" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-3"></a><span class="k">struct</span><span class="w"> </span><span class="nc">memory</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-4" name="rest_code_3248d05c75f54f518e8bd3c43944a826-4" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-4"></a><span class="p">{</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-5" name="rest_code_3248d05c75f54f518e8bd3c43944a826-5" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-5"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">contents</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-6" name="rest_code_3248d05c75f54f518e8bd3c43944a826-6" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-6"></a>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-7" name="rest_code_3248d05c75f54f518e8bd3c43944a826-7" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-7"></a><span class="w">        </span><span class="n">memory</span><span class="p">()</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-8" name="rest_code_3248d05c75f54f518e8bd3c43944a826-8" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-8"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-9" name="rest_code_3248d05c75f54f518e8bd3c43944a826-9" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-9"></a><span class="w">                </span><span class="k">for</span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">contents</span><span class="p">)</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-10" name="rest_code_3248d05c75f54f518e8bd3c43944a826-10" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-10"></a><span class="w">                        </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-11" name="rest_code_3248d05c75f54f518e8bd3c43944a826-11" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-11"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-12" name="rest_code_3248d05c75f54f518e8bd3c43944a826-12" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-12"></a><span class="w">        </span><span class="o">~</span><span class="n">memory</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">delete</span><span class="p">;</span><span class="w"> </span><span class="c1">// must be static</span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-13" name="rest_code_3248d05c75f54f518e8bd3c43944a826-13" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-13"></a>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-14" name="rest_code_3248d05c75f54f518e8bd3c43944a826-14" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-14"></a><span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">address</span><span class="p">)</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-15" name="rest_code_3248d05c75f54f518e8bd3c43944a826-15" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-15"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-16" name="rest_code_3248d05c75f54f518e8bd3c43944a826-16" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-16"></a><span class="w">                </span><span class="kt">uint8_t</span><span class="w">  </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-17" name="rest_code_3248d05c75f54f518e8bd3c43944a826-17" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-17"></a><span class="w">                </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">address</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff'ff</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-18" name="rest_code_3248d05c75f54f518e8bd3c43944a826-18" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-18"></a>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-19" name="rest_code_3248d05c75f54f518e8bd3c43944a826-19" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-19"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">contents</span><span class="p">[</span><span class="n">page</span><span class="o">%</span><span class="mi">4</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="n">cell</span><span class="p">);</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-20" name="rest_code_3248d05c75f54f518e8bd3c43944a826-20" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-20"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-21" name="rest_code_3248d05c75f54f518e8bd3c43944a826-21" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-21"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">payload</span><span class="p">)</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-22" name="rest_code_3248d05c75f54f518e8bd3c43944a826-22" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-22"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-23" name="rest_code_3248d05c75f54f518e8bd3c43944a826-23" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-23"></a><span class="w">                </span><span class="kt">uint8_t</span><span class="w">  </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-24" name="rest_code_3248d05c75f54f518e8bd3c43944a826-24" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-24"></a><span class="w">                </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">address</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff'ff</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-25" name="rest_code_3248d05c75f54f518e8bd3c43944a826-25" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-25"></a>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-26" name="rest_code_3248d05c75f54f518e8bd3c43944a826-26" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-26"></a><span class="w">                </span><span class="n">contents</span><span class="p">[</span><span class="n">page</span><span class="o">%</span><span class="mi">4</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">payload</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-27" name="rest_code_3248d05c75f54f518e8bd3c43944a826-27" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-27"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="rest_code_3248d05c75f54f518e8bd3c43944a826-28" name="rest_code_3248d05c75f54f518e8bd3c43944a826-28" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_3248d05c75f54f518e8bd3c43944a826-28"></a><span class="p">};</span><span class="w"></span>
</pre></div>
<p>This kind of structure has sub-32 bytes of internal state, manages pages of 64K memory,
and translates accesses in a perceived continuous space to accesses in a discontinuous space.
Of course, this kind of code is unacceptable for embedded because using the STL in the first
place is what is called "rough luck", but it's not the worst thing ever, and the code scaffold
is good enough. This is downright primitive, but it serves the purpose of unifying a disparate
memory space into one field. A lot more can be added on top of this to make it a proper
manager unit that would provide virtual memory with memory safety features. This isn't
currently too important.</p>
<p>This feels like the wrong solution for specific problems, though. Some other things I've toyed
with include:</p>
<ul class="simple">
<li><p>Hash-maps</p></li>
<li><p>Slabs and pools (aforementioned)</p></li>
<li><p>Naïve constrained declaration and no dynamicity</p></li>
<li><p>other detritus and miscellanea</p></li>
</ul>
<p>The hash-map was probably my favourite idea, though.</p>
<section id="static-hashing-and-hashmaps"><h3>Static hashing and hashmaps</h3>
<p>A hashmap is a really neat data structure: it's an associative array where input keys
are used to look up locations in memory easily. These keys are put through a hashing
function, transforming them into a hash index or hash code, and this hash will point
to where the memory is stored in the corresponding target array. Since with fixed-width
input data hashing will 'always' take the same amount of operations, most hashmap designs
will feature amortised constant <code class="docutils literal">O(1)</code> access, though in practice this isn't really the case.</p>
<p>Since a typical hashmap will not run in an environment where each possible key has a unique
location corresponding to it, some kind of hash colision mitigation is unavoidable (thus
the average hashing process is not an injective operation), and since allocating the entire
space is also frequently uneconomic reallocation can end up being necessary at many points (and,
remember, reallocation and dynamic memory stuff is undesirable in bare metal).</p>
<p>The issue here is that we aren't really allowed to grow and shrink at will, and should aim to
take up as much memory as possible; that is, the initial storage allocation should aim to
give the subsystem the maximum amount of memory it would need during its whole runtime. This
becomes the memory ceiling of the datastructure. The hashmap, then, would either have to be
statically allocated in the flash binary, or will have to be <code class="docutils literal">malloc()</code>'d at startup and
never freed.</p>
<p>This still leaves the question of colisions open.</p>
<p>Let's add more context. As I mentioned before, I started thinking about all of these things
in the context of developing a BASIC-like running on the ESP32, and so some structures and
requirements tend to emerge spontaneously without me having to do much deciding. In a typical
BASIC, variables are stored onto a stack or on a table and then every time they're referenced
the interpreter trawls this structure (<code class="docutils literal">O(n)</code> as a function of table size) to find the variable,
and if it's not present it pushes it onto the structure (e.g. in <a class="reference external" href="https://github.com/mist64/msbasic/blob/master/var.s">Microsoft BASIC for the 6502</a> you
can use variables without declaring them, which automatically implicitly declares them there). This
trawl is repeated every time a variable is referenced, absolutely nuking performance. It's not like
it's much of a space-saving thing, either: MS-BASIC used a weird 5-byte format for floating point
data (fine), as well as integers (what) that were treated as 16-bit numbers (what?) with
24 padding bits (<cite>what!?</cite>), plus two bytes for the name, meaning that each variable took up
seven bytes of space.</p>
<p>Arrays, as far as I know, need 4+2n bytes of bookkeeping on top of
their actual memory footprint: 1 for the name, 2 for the address, 1 for the number of dimensions,
and 2n for the length of the dimensions for n dimensions <a class="footnote-reference brackets" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#footnote-6" id="footnote-reference-6" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a> give or take.
As you'll probably recognise, arrays go onto the heap of the BASIC, but it's important
to note that once you <code class="docutils literal">DIM</code>/declare an array, it can't be deallocated or resized (for details, see <a class="reference external" href="https://www.c64-wiki.com/wiki/DIM">here</a>),
which is a recurring theme in the low-power space. More modern BASICs like the beautiful
QB64 allow <a class="reference external" href="https://qb64phoenix.com/qb64wiki/index.php/REDIM">resizing and reallocating arrays</a> as enabled by running on top of a fat OS
that can handle moving a lot of memory around for them <a class="footnote-reference brackets" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#footnote-7" id="footnote-reference-7" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a> without having to
think too much about it themselves.</p>
<p>While for arrays this trawl is pretty 'cheap' (it's still <code class="docutils literal">O(n)</code> but with n ≤ 255), for
variables it can get nasty pretty quick (realistically you can input up to 26*36 = 936 variables,
but the interpreter can be reading bytecode that would use 'syntactically inappropriate' variable
names going into thousands of combinations; a theoretical maximum of around 4000 variables based
on memory constraints is an example of such a large number). This is a big performance sink, but
solutions to the problem are tough to come up with. I believe that a statically allocated hashmap
is in fact a solution to this.</p>
<p>Simply using a 16-bit key, it's possible to effortlessly index into a 64K table without any
further adjustments. This would mean that a 2-character name would just point to the address
in the code table without requiring any bookkeeping; this would be an example of a 'perfect
hashing table'. My first musings, thus, involved using 2 CJK characters as possible
variable names. Encoded as UTF-16 and then somewhat adjusted, this means that both
are ∈ <code class="docutils literal">[0x0000, 0x6bff]</code> which, when concatenated together, produces a ~30-bit key, which
would somehow have to be mapped onto a 64K table in some way; every single possible key
would have to compete with ~16K other keys for its slot in the table.</p>
<p>The naïve way to resolve this would be to add the top and bottom hanzi together. This is
awful, because it'll make a lot of small collisions easy: let's say that we name one variable
女王 ('queen', <code class="docutils literal">0x5973'738B</code> - the sum of the two hanzi is <code class="docutils literal">0xCCFE</code>); it will immediately collide
with 女王 ('princess', <code class="docutils literal">0x738B'0x5973</code>). This extends to all anagrams, of which there is
a large amount in e.g. Japanese (本日 'today' vs. 日本 'Japan' is another neat example). While
it's tempting to tell the user to Never Ever use anagram variable names, I felt that I needed
to mitigate this in some way. So, addition is not a good hashing function.</p>
<p>What I did was use a <a class="reference external" href="https://github.com/skeeto/hash-prospector">hash prospector</a> to find good 16-bit hashes and incorporate that
into the thing. It spat out quite a few functions; what I settled on was the following:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_9a179bfc60b148c38cbab73effc3e379-1" name="rest_code_9a179bfc60b148c38cbab73effc3e379-1" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-1"></a><span class="c1">// bias = 0.0049752954186705221</span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-2" name="rest_code_9a179bfc60b148c38cbab73effc3e379-2" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-2"></a><span class="kt">uint16_t</span><span class="w"> </span><span class="nf">hash1</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-3" name="rest_code_9a179bfc60b148c38cbab73effc3e379-3" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-3"></a><span class="p">{</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-4" name="rest_code_9a179bfc60b148c38cbab73effc3e379-4" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-4"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">11</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-5" name="rest_code_9a179bfc60b148c38cbab73effc3e379-5" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-5"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mh">0x104bU</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-6" name="rest_code_9a179bfc60b148c38cbab73effc3e379-6" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-6"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-7" name="rest_code_9a179bfc60b148c38cbab73effc3e379-7" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-7"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mh">0xcd1bU</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-8" name="rest_code_9a179bfc60b148c38cbab73effc3e379-8" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-8"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-9" name="rest_code_9a179bfc60b148c38cbab73effc3e379-9" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-9"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mh">0x42a5U</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-10" name="rest_code_9a179bfc60b148c38cbab73effc3e379-10" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-10"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">11</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-11" name="rest_code_9a179bfc60b148c38cbab73effc3e379-11" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-11"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mh">0x258dU</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-12" name="rest_code_9a179bfc60b148c38cbab73effc3e379-12" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-12"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-13" name="rest_code_9a179bfc60b148c38cbab73effc3e379-13" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-14" name="rest_code_9a179bfc60b148c38cbab73effc3e379-14" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-14"></a><span class="p">}</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-15" name="rest_code_9a179bfc60b148c38cbab73effc3e379-15" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-15"></a>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-16" name="rest_code_9a179bfc60b148c38cbab73effc3e379-16" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-16"></a><span class="c1">// bias = 0.0046809801814303642</span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-17" name="rest_code_9a179bfc60b148c38cbab73effc3e379-17" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-17"></a><span class="kt">uint16_t</span><span class="w"> </span><span class="nf">hash2</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-18" name="rest_code_9a179bfc60b148c38cbab73effc3e379-18" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-18"></a><span class="p">{</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-19" name="rest_code_9a179bfc60b148c38cbab73effc3e379-19" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-19"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-20" name="rest_code_9a179bfc60b148c38cbab73effc3e379-20" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-20"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mh">0xb257U</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-21" name="rest_code_9a179bfc60b148c38cbab73effc3e379-21" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-21"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-22" name="rest_code_9a179bfc60b148c38cbab73effc3e379-22" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-22"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mh">0x8829U</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-23" name="rest_code_9a179bfc60b148c38cbab73effc3e379-23" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-23"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-24" name="rest_code_9a179bfc60b148c38cbab73effc3e379-24" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-24"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mh">0x0af7U</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-25" name="rest_code_9a179bfc60b148c38cbab73effc3e379-25" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-25"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-26" name="rest_code_9a179bfc60b148c38cbab73effc3e379-26" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-26"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mh">0x504dU</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-27" name="rest_code_9a179bfc60b148c38cbab73effc3e379-27" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-27"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-28" name="rest_code_9a179bfc60b148c38cbab73effc3e379-28" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-28"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_9a179bfc60b148c38cbab73effc3e379-29" name="rest_code_9a179bfc60b148c38cbab73effc3e379-29" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_9a179bfc60b148c38cbab73effc3e379-29"></a><span class="p">}</span><span class="w"></span>
</pre></div>
<p>Bias here represents how strongly correlated toggling a bit of input is with specific
bits of output (low hash, meaning less correlation, is good). These two are chained together, operating
on separate halves of the variable name; a simplified code example:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-1" name="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-1" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_4bcbb2111bca43b6ade9d56104c5baf7-1"></a><span class="kt">uint16_t</span><span class="w"> </span><span class="nf">hash</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"></span>
<a id="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-2" name="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-2" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_4bcbb2111bca43b6ade9d56104c5baf7-2"></a><span class="p">{</span><span class="w"></span>
<a id="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-3" name="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-3" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_4bcbb2111bca43b6ade9d56104c5baf7-3"></a><span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-4" name="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-4" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_4bcbb2111bca43b6ade9d56104c5baf7-4"></a><span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash1</span><span class="p">(</span><span class="n">input</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff'ff</span><span class="p">);</span><span class="w"></span>
<a id="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-5" name="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-5" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_4bcbb2111bca43b6ade9d56104c5baf7-5"></a><span class="w">        </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash2</span><span class="p">(</span><span class="n">input</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span><span class="w"></span>
<a id="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-6" name="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-6" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_4bcbb2111bca43b6ade9d56104c5baf7-6"></a><span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash1</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<a id="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-7" name="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-7" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_4bcbb2111bca43b6ade9d56104c5baf7-7"></a>
<a id="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-8" name="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-8" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_4bcbb2111bca43b6ade9d56104c5baf7-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-9" name="rest_code_4bcbb2111bca43b6ade9d56104c5baf7-9" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_4bcbb2111bca43b6ade9d56104c5baf7-9"></a><span class="p">}</span><span class="w"></span>
</pre></div>
<p>This provides surprisingly decent hash performance. Using a collision measurement script I wrote, I
found that for a table of size <cite>n</cite>, there is on average fewer than <cite>n/2</cite> collision events, and that
around half of that is a single collision; iteratively adding mitigations shows that after around 50%
population, the hash table starts getting more and more collisions, and that beyond around 80% population,
the table practically becomes unusable performance-wise; insertion changes from <code class="docutils literal">O(1)</code> in a theoretically
optimal table to <code class="docutils literal">O(n)</code> in a static one. Average-case performance is still pretty good, but worst-case
performance isn't good at all. Still, this beats iterating through a table of variables to extract the
named one.</p>
<p>To mitigate collisions during insertion, I simply opted for the following simple algorithm:</p>
<ol class="arabic simple">
<li><p>If there is no collision, insert; stop.</p></li>
<li><p>If there is a collision, rehash <code class="docutils literal">c</code> once. If there is no collision, insert; stop.</p></li>
<li><p>If there is still a collision, increment <code class="docutils literal">c = c+1</code>. If there is no collision, insert; stop.</p></li>
<li><p>If there is still a collision, go to #3</p></li>
</ol>
<p>In pseudocode:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-1" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-1" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">hash_insert</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-2" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-2" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-2"></a><span class="p">{</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-3" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-3" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-3"></a><span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-4" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-4" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-4"></a><span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash1</span><span class="p">(</span><span class="n">input</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff'ff</span><span class="p">);</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-5" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-5" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-5"></a><span class="w">        </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash2</span><span class="p">(</span><span class="n">input</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-6" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-6" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-6"></a><span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash1</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-7" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-7" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-7"></a>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-8" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-8" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-8"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">collides</span><span class="p">(</span><span class="n">c</span><span class="p">))</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-9" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-9" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-9"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-10" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-10" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-10"></a><span class="w">                </span><span class="n">insert_at</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-11" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-11" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-11"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-12" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-12" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-12"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-13" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-13" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-13"></a><span class="w">        </span><span class="k">else</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-14" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-14" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-14"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-15" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-15" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-15"></a><span class="w">                </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash2</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-16" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-16" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-16"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">collides</span><span class="p">(</span><span class="n">c</span><span class="p">))</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-17" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-17" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-17"></a><span class="w">                </span><span class="p">{</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-18" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-18" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-18"></a><span class="w">                        </span><span class="n">insert_at</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-19" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-19" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-19"></a><span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-20" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-20" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-20"></a><span class="w">                </span><span class="p">}</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-21" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-21" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-21"></a><span class="w">                </span><span class="k">else</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-22" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-22" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-22"></a><span class="w">                </span><span class="p">{</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-23" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-23" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-23"></a><span class="w">                        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-24" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-24" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-24"></a><span class="w">                        </span><span class="p">{</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-25" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-25" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-25"></a><span class="w">                                </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-26" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-26" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-26"></a>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-27" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-27" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-27"></a><span class="w">                                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">collides</span><span class="p">(</span><span class="n">c</span><span class="p">))</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-28" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-28" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-28"></a><span class="w">                                </span><span class="p">{</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-29" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-29" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-29"></a><span class="w">                                        </span><span class="n">insert_at</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-30" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-30" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-30"></a><span class="w">                                        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-31" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-31" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-31"></a><span class="w">                                </span><span class="p">}</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-32" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-32" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-32"></a><span class="w">                        </span><span class="p">}</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-33" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-33" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-33"></a><span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-34" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-34" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-34"></a><span class="w">                </span><span class="p">}</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-35" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-35" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-35"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="rest_code_71be15f48db14e45b5aa625f0fae7d41-36" name="rest_code_71be15f48db14e45b5aa625f0fae7d41-36" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_71be15f48db14e45b5aa625f0fae7d41-36"></a><span class="p">}</span><span class="w"></span>
</pre></div>
<p>Of course, <code class="docutils literal">c</code> should not be allowed to hit the map out of bounds, but otherwise it's a surprisingly
simple principle.</p>
<p>Unfortunately, because we mitigate collisions in this way, a table of names must be maintained separately
from the data map, so that indexing into the table will tell us if mitigations were applied or not, so we
know whether we've found the variable we want or if it's <strike> in another castle </strike>​ in a different memory
location. This means the table should have a structure like:</p>
<div class="code"><pre class="code cpp"><a id="rest_code_35b7706a71b9454a9b73877692e6e432-1" name="rest_code_35b7706a71b9454a9b73877692e6e432-1" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_35b7706a71b9454a9b73877692e6e432-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">entry_t</span><span class="w"></span>
<a id="rest_code_35b7706a71b9454a9b73877692e6e432-2" name="rest_code_35b7706a71b9454a9b73877692e6e432-2" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_35b7706a71b9454a9b73877692e6e432-2"></a><span class="p">{</span><span class="w"></span>
<a id="rest_code_35b7706a71b9454a9b73877692e6e432-3" name="rest_code_35b7706a71b9454a9b73877692e6e432-3" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_35b7706a71b9454a9b73877692e6e432-3"></a><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">          </span><span class="c1">// 4</span>
<a id="rest_code_35b7706a71b9454a9b73877692e6e432-4" name="rest_code_35b7706a71b9454a9b73877692e6e432-4" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_35b7706a71b9454a9b73877692e6e432-4"></a><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w">          </span><span class="c1">// +4</span>
<a id="rest_code_35b7706a71b9454a9b73877692e6e432-5" name="rest_code_35b7706a71b9454a9b73877692e6e432-5" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_35b7706a71b9454a9b73877692e6e432-5"></a><span class="p">};</span><span class="w"></span>
<a id="rest_code_35b7706a71b9454a9b73877692e6e432-6" name="rest_code_35b7706a71b9454a9b73877692e6e432-6" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_35b7706a71b9454a9b73877692e6e432-6"></a>
<a id="rest_code_35b7706a71b9454a9b73877692e6e432-7" name="rest_code_35b7706a71b9454a9b73877692e6e432-7" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#rest_code_35b7706a71b9454a9b73877692e6e432-7"></a><span class="k">static</span><span class="w"> </span><span class="n">entry_t</span><span class="w"> </span><span class="n">name_table</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span><span class="w"></span>
</pre></div>
<p>The astute reader will notice that this is one byte more than the MS-BASIC variable table, <cite>without</cite> the
performance hit of having to loop through an array to find what we want every time a variable is ever used.
Such a table would eat 8K of memory for 1K variables (totalling 4K data) with longer names (four ASCII
characters, or 2 CJK characters). It feels a <em>bit</em> like defeat having to still store the name in the
thing, but it's essential to disambiguating between two identically hashed names; basically, we're using
the name as a way to gauge whether the accessor should do a mitigation or not, without wasting too much space and
still preserving some onomastics. As the names are stored as one integer made from concatenated characters,
checking whether it's the right name is a simple single-instruction comparsion, and we're avoiding
complex string routines that would basically be obligatory with a longer variable name. Checking whether anything's been
allocated is also pretty easy: since we know names won't have the highest bit set (remember, we have a ~30-bit key),
simply setting the name to <code class="docutils literal">0xffff'ffff</code> ensures that it's easy to check for whether a 'spot' is taken by simply
doing <code class="docutils literal">if(int32_t(name) &lt; 0) { /* ... */ }</code> without having to worry much. Using a larger table than 1024 is likewise
pretty easy to a point: at 16K entries, the table reaches 128K of memory use, which is near our upper static
allocation limit and should be avoided.</p>
</section><section id="slabs-and-pools"><h3>Slabs and pools</h3>
<p>I haven't really dug deep into slab and pooling because we really don't have too much memory
to work with in general, so doing stuff in this space would not be quite as efficient
as it could be if we had more memory to manage. Generally speaking, slab allocation is
most effective when you have an OS that manages memory tightly. Since spinning up and
destroying pages can be costly, and finding free memory can sometimes be a chore, the kernel
instead allocates a bunch of chunks that can fit a certain object type, and then hands that
memory out when requested and reclaims it when freed, all by adjusting a bookkeeping structure
that shows which parts of slabs are free to use and which occupied. Freeing and allocating memory
in this case is an illusion: it means just rewriting the appropriate part of the bookkeeping table.
When something is 'destroyed' or reclaimed in a slab allocator, the object structure is kept
cached, so that when another instance is requested there is no set-up involved and the cached
object can be returned basically intact. The objects are usually also constructed ahead of time
and in one go.</p>
<p>Memory pooling is a similar concept, where a large swath of memory is preallocated and then
divided up by a pool allocator. There's bookkeeping and all that jazz, but what separates
it from a slab (though neither is really extremely well-defined) is that there are no
premade objects in pools, and they can store heterogenous data. It's basically a microcosmos
of memory management.</p>
<p>Memory pooling could perhaps work here, but in a way the <cite>idea</cite> of a memory pool is superfluous because
there's no real OS for us to request a lot of memory from and then subdivide it to avoid
the overhead because we're that OS and we have to manage the memory we have in this manner anyway.
That is, all our memory is in memory pools to begin with. Nobody's there to reclaim leaked memory.</p>
<p>The same principles apply, though: we want to keep a small bookkeeping structure that would indicate
which parts of memory are free to use and which are taken.</p>
<p>As there's very little memory to go around,
a very light bookkeeping structure would be not just optimal, but really necessary. This is balanced
out by the need for space savings and very fine memory granularity. For example, we can
assume that the smallest unit of memory that can be handed out like this would be 8 bytes;
to keep track of every unit, a 64K memory space would need 8K locations keeping storage
status. If we use a bitmap, this means the bookkeeping structure would only have an overhead
of 1K (8 locations per byte for 8 bytes of space per location) plus anything on top (like a
pointer to the structure and whatnot) that would add a handful of extra bytes. Computationally,
this would suck to manage a bit, but if space savings were the main concern this would probably
be the way to go. Less fine-grained memory allocation would in turn allow for more metadata
in the bookkeeping structure while keeping to the same space concerns: if each space manages
16B of data, then 2 bits per location would allow for a total of 4 states to be stored
per item, possibly facilitating things like access control; if each space manages
64B of data, then a full byte is available for this purpose.</p>
<p>Another bookkeeping approach would be to keep a table of what's been allocated, a pointer
to it, and the length. Several other approaches (such as a linked list) also exist, and are,
in my opinion, all better suited for more memory-rich platforms.</p>
</section><section id="naive-without-dynamicity"><h3>Naïve without dynamicity</h3>
<p>Most of the stuff an embedded programme will need will be
statically allocated ahead of time anyway. In this case,
when I say <cite>naïve</cite> I mean that there's no magic behind the
scenes and nothing is playing musical chairs with the memory.
Everything is baked in at compilation time and no deviation
is allowed. This is how most of the "important data" will
live on the chip anyway. A screen buffer, for example, will
be statically allocated as 75K or 150K of RAM with no manager,
and resources like fonts or images or sprites or whatnot
that would be statically burnt to flash are likewise going
to just be this kind of memory: it's basically handling
unmanaged, unscoped static memory with bare code-hands.
There's nothing to talk about in terms of management here,
strictly speaking.</p>
</section></section><section id="what-else"><h2>What else?</h2>
<p>Really, it's just me staring at the screen blarting out words as they come,
without a coherent idea of where it's going. I'm going to be designing
the BASIC-like over the next few weeks/months (depending on how hard it
holds my attention, really), and will probably be writing some kind of static
hashmap (more sophisticated than the pseudocode above), a stack (possibly
templated for type and depth), and a rudimentary array allocator that would
implement a basic (hehe) heap. I'm not actually sure how useful multi-dimensional
arrays were back in the olden days, though; I can imagine a 2D or 3D array
doing just fine, but do you really need a 37D array when you're not doing
some fancy linear algebra churning vectors (which you shouldn't be doing
on an ESP32 anyway)?</p>
<hr class="docutils">
<aside class="footnote-list brackets"><aside class="footnote brackets" id="footnote-1" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#footnote-reference-1">1</a><span class="fn-bracket">]</span></span>
<p>I'm not even exaggerating that much, believe it or not;
we have a very good idea of the
<a class="reference external" href="http://www.roylongbottom.org.uk/whetstone.htm">historical performance of the computers of the era</a>,
with a PDP-11/34 giving 0.204 MWIPS (million Whetstone instructions per second),
whereas an ESP32 clocked at 240MHz (the default in the CYD) hits
<a class="reference external" href="https://github.com/nopnop2002/esp-idf-benchmark">around 50 MWIPS</a>, for
around 250x the floating point performance by this crude benchmark comparsion. Given
how thoroughly the ESP32's floating point unit can suck, the performance gap
is probably much, much greater on integer data, which is what
most stuff on the CYD would be anyway. My personal benchmarks
give floating point arithmetic around a 12x worse performance
on the CYD's ESP32 chip (it takes appx. 4.6 ticks to do i32
addition, compared to appx. 53.5 ticks for f32 addition), if
we don't account for division (~5.5 / ~ <strong>270</strong> ≈ 50x worse), but
division is known to be a jagged edge in arithmetic algorithmics.
It doesn't quite matter what the ticks are, they're the same measure
for all operations giving a decent baseline to compare these by
(but if you're wondering what these ticks are, they're a measure of
appx. how many ticks, on average, of a GHz clock are needed
for an operation to finish; a ballpark of 1GHz/4.6 gives us
the processor's clocked speed at ≈220MHz, which means that
arithmetic ops have an average throughput of one per cycle,
while float ops have an average throughput of around one
per 12 clock cycles).</p>
</aside><aside class="footnote brackets" id="footnote-2" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#footnote-reference-2">2</a><span class="fn-bracket">]</span></span>
<p>Not immediately, but I do have to say how ESP's development platform,
called the ESP-IDF (unrelated to the child killer club), is a bit of a
nuisance to work with and has fairly brittle versioning. It's a shame that
this is the only way to access more sophisticated tooling for the chips, such
as partition table editing and (easy) core assignment (you can still do it,
but it'll be a bit harder in Arduino IDE).</p>
</aside><aside class="footnote brackets" id="footnote-3" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#footnote-reference-3">3</a><span class="fn-bracket">]</span></span>
<p>Tactility is cool, although it only serves the capacitative boards and doesn't support
resistive screen boards. I assume modifying it to work on R-variants would be pretty easy;
I just haven't bothered, seeing as it wants at least 4MB of PSRAM to make usage not
miserable; but the project is nonetheless really cool. Building executables for it is also
not going to be a pleasant experience as it requires a lot of fiddling with ESP-IDF, which
I've already been burnt twice on. Might be worth looking into further down the line as I explore
making this into a worthwhile little computer rather than just treating it as a toy as I
have until now.</p>
</aside><aside class="footnote brackets" id="footnote-4" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#footnote-reference-4">4</a><span class="fn-bracket">]</span></span>
<p>I know I said 'bare metal', but it's probably better to think of the ESP32 running a RTOS
kernel as 'skimpy metal' wearing an inappropriately revealing bikini with no top. You're still
basically as close to the metal as you can be, and you can certainly just take control over the
device pretty easily and 'usurp' the kernel and the task manager and do your own thing (and there
are other kernels available other than RTOS, via ESP-IDF), but the convenience here is that at least
your <em>whole</em> ass isn't out, just both cheeks. It's difficult to overstate how useful it is to
be handed a codebase that will manage your multitasking on its own! Some drawbacks include the
watchdog, which will kill any process taking too much time, which may end up killing some code of yours
running in a loop, so some code pathe engineering won't hurt.</p>
</aside><aside class="footnote brackets" id="footnote-5" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#footnote-reference-5">5</a><span class="fn-bracket">]</span></span>
<p>The block sizes and types that we can see
<a class="reference external" href="https://github.com/espressif/arduino-esp32/issues/6777#issuecomment-1131658098">in this Github issue</a>
point to a bit more difficult heap situation. In terms of Po2 block sizes, it seems like we can allocate
4 blocks of 64K, 3 blocks of 32K, and so on, in increasingly smaller chunks. This might be something to
work around in the future.</p>
</aside><aside class="footnote brackets" id="footnote-6" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#footnote-reference-6">6</a><span class="fn-bracket">]</span></span>
<p>I didn't really take a look at how MS-BASIC stores the size of each dimension in the array table,
so this is an estimate, but it's nonetheless documented behaviour that array dimensions can have different
sizes and that each dimension's length is ∈ [0, 32767], so they obviously must be stored separately.</p>
</aside><aside class="footnote brackets" id="footnote-7" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/thoughts-about-memory-management-on-bare-metal-pt-1.html#footnote-reference-7">7</a><span class="fn-bracket">]</span></span>
<p>for QB64, this is stuff inherited
from QuickBASIC, which was a significant step up from MS-BASIC for the 6502 in terms of
hardware and software capabilities alike. Even though it feels properly rudimentary now,
MS-DOS (and other DOSes of the time) were proper operating systems with a lot of bells and whistles
compared to things like the Commodore for which BASIC was the closest it got to an OS at all.
Even further, QB64 transpiles to C++, which is then piped through GCC, so its dynamic memory
features depend on code in the STL, predominantly the use of <code class="docutils literal"><span class="pre">std::vector</span></code></p>
</aside></aside></section>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/kernel-configuration-pt-one.html" class="u-url">Kernel Configuration, Part One</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                enn
            </span></p>
            <p class="dateline">
            <a href="posts/kernel-configuration-pt-one.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-07-29T15:38:39+02:00" itemprop="datePublished" title="2022-07-29 15:38">2022-07-29 15:38</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>It's time to formally come out of the Hello World sphere of things. We've
set up the UART, talked to the user in several different ways, and even
cobbled together an input system for the user to communicate with the
device. We'll be expanding on I/O later, but for now I'm content with what
we've got.</p>
<p>Now is the time to start thinking about whether the code we're writing
can run on "all" devices in the family, and not just the exact configuration
we're running at one specific moment in time. This means that we need to check
for processor and device features, and integrate fallbacks wherever possible,
and gracefully exit if not.</p>
<p>Fundamentally, this means we can write code for a number of different processors
that QEMU will accept for the <code class="docutils literal">virt</code> board, and expect more-or-less the same
functionality.</p>
<section id="target-analysis"><h2>Target Analysis</h2>
<p>Just because we're bitchin programmers doesn't mean we can just write our code
for all the processors out there and expect it to work: we're
working strictly in Aarch64 land, and this means we have actually
a very limited set of platforms we can ever dare to support without
spinning up a whole new codebase and toolkit. Apart from that, we're
coding for the <code class="docutils literal">virt</code> board (or, well, "board", you know) that has
its own quirks and peculiarities that other boards don't have, and in
turn the other boards have their kinks to be ironed out (like the Pi
actually booting from the GPU and not CPU).</p>
<p>Since we're writing and targetting Aarch64, the ARM CPU core designs
we can think of are:</p>
<ul class="simple">
<li><p>ARMv8.1-A: A34, A35, A53, A57, A72, A73</p></li>
<li><p>ARMv8.2-A: A55, A65, A75, A76, A77, A78, X1, Neoverse N1</p></li>
<li><p>ARMv8.4-A: A65AE (partial), V1</p></li>
<li><p>ARMv9.0-A: A510, A710, X2, Neoverse N2</p></li>
</ul>
<p>QEMU gives us a number of other options, of which only the Fujitsu <code class="docutils literal">A64FX</code>
core has any merit—it's an ARMv8.2-A core with the 512-bit SVE extension.</p>
<p>There's also the option of using the QEMU <code class="docutils literal">max</code> CPU—a pseudo-core
that has the maximum featureset possible implemented in QEMU's codebase.
This does not correspond to any core, and has a number of extensions
that aren't in any of the currently emulated cores. For example, while
the Fujitsu core is emulated with 512-bit SVE, you can set your <code class="docutils literal">max</code>
core to work with 1024-bit SVE registers 'out of the box'.</p>
<p>The QEMU codebase is, of course, incomplete. Some things are just
not emulated yet, but you can get close enough. For example, there's
no support for Apple chips, but they're running ARMv8.5-A; there's
also no support for ARMv9.0-A cores but their features are more-less
completely implemented and we're just waiting for an actual core
such as the A510 to be written.</p>
<p>If we are going to write truly board-independent Aarch64 code, that
means we're going to have to write peripheral detection routines
and whatnot, and that's also a pain in the ass to do compared
to just reading the device tree and pointing the CPU in the right
direction, so we're avoiding that for now as well. The UART on
a <code class="docutils literal">virt</code> is in a totally different place compared to the
<em>two</em> UARTs on a Pi3, for example, though the setup code is
much the same.</p>
<p>But even within our <code class="docutils literal">virt</code> garden there's a number of things
that can change based on what core we're using. Today we're gonna
take a look at two such features, see how they're implemented
or left unimplemented, and handle them in two different ways.</p>
</section><section id="random-numbers"><h2>Random Numbers</h2>
<p>The first feature I wanna take a look at is the hardware RNG
that some Arm cores have and some don't. There's a processor
feature that determines whether there's a RNG accessible
through <code class="docutils literal">mrs</code> instructions, and that's <code class="docutils literal">FEAT_RNG</code> that's
expressed in the top four bits of the <code class="docutils literal">ID_AA64ISAR0_EL1</code>
register.</p>
<p>Since we're gonna write a function that returns random
numbers on the stack, we're gonna want to set up a check in
the bootloader to see whether we have this feature enabled, and
if not to rewrite the function address to the alternative code
path.</p>
<p>The subroutine which we'll rely on to get random numbers from
is going to be called <code class="docutils literal">_rng_64</code>, and we'll use this same alias
for both the hardware RNG and our fallback implementation.</p>
<p>Somewhere in our code, we're gonna add the following stub:</p>
<div class="code"><pre class="code asm"><a id="rest_code_05c2ae96dea14506ac19f94c3601081c-1" name="rest_code_05c2ae96dea14506ac19f94c3601081c-1" href="posts/kernel-configuration-pt-one.html#rest_code_05c2ae96dea14506ac19f94c3601081c-1"></a><span class="nl">_rng_64_branch:</span><span class="w"> </span><span class="na">.quad</span><span class="w"> </span><span class="no">_rng_64_fallback</span><span class="w"></span>
<a id="rest_code_05c2ae96dea14506ac19f94c3601081c-2" name="rest_code_05c2ae96dea14506ac19f94c3601081c-2" href="posts/kernel-configuration-pt-one.html#rest_code_05c2ae96dea14506ac19f94c3601081c-2"></a><span class="nl">_rng_64:</span><span class="w"></span>
<a id="rest_code_05c2ae96dea14506ac19f94c3601081c-3" name="rest_code_05c2ae96dea14506ac19f94c3601081c-3" href="posts/kernel-configuration-pt-one.html#rest_code_05c2ae96dea14506ac19f94c3601081c-3"></a><span class="w">        </span><span class="nf">sub</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="rest_code_05c2ae96dea14506ac19f94c3601081c-4" name="rest_code_05c2ae96dea14506ac19f94c3601081c-4" href="posts/kernel-configuration-pt-one.html#rest_code_05c2ae96dea14506ac19f94c3601081c-4"></a><span class="w">        </span><span class="nf">str</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_05c2ae96dea14506ac19f94c3601081c-5" name="rest_code_05c2ae96dea14506ac19f94c3601081c-5" href="posts/kernel-configuration-pt-one.html#rest_code_05c2ae96dea14506ac19f94c3601081c-5"></a><span class="w">        </span><span class="nf">adr</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="err">=</span><span class="no">_rng_64_branch</span><span class="w"></span>
<a id="rest_code_05c2ae96dea14506ac19f94c3601081c-6" name="rest_code_05c2ae96dea14506ac19f94c3601081c-6" href="posts/kernel-configuration-pt-one.html#rest_code_05c2ae96dea14506ac19f94c3601081c-6"></a><span class="w">        </span><span class="nf">ldr</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_05c2ae96dea14506ac19f94c3601081c-7" name="rest_code_05c2ae96dea14506ac19f94c3601081c-7" href="posts/kernel-configuration-pt-one.html#rest_code_05c2ae96dea14506ac19f94c3601081c-7"></a><span class="w">        </span><span class="nf">br</span><span class="w">  </span><span class="no">x0</span><span class="w"></span>
<a id="rest_code_05c2ae96dea14506ac19f94c3601081c-8" name="rest_code_05c2ae96dea14506ac19f94c3601081c-8" href="posts/kernel-configuration-pt-one.html#rest_code_05c2ae96dea14506ac19f94c3601081c-8"></a><span class="nl">_rng_64_hardware:</span><span class="w"></span>
<a id="rest_code_05c2ae96dea14506ac19f94c3601081c-9" name="rest_code_05c2ae96dea14506ac19f94c3601081c-9" href="posts/kernel-configuration-pt-one.html#rest_code_05c2ae96dea14506ac19f94c3601081c-9"></a><span class="w">        </span><span class="nf">ldr</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">],</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="rest_code_05c2ae96dea14506ac19f94c3601081c-10" name="rest_code_05c2ae96dea14506ac19f94c3601081c-10" href="posts/kernel-configuration-pt-one.html#rest_code_05c2ae96dea14506ac19f94c3601081c-10"></a><span class="w">        </span><span class="nf">ret</span><span class="w"></span>
<a id="rest_code_05c2ae96dea14506ac19f94c3601081c-11" name="rest_code_05c2ae96dea14506ac19f94c3601081c-11" href="posts/kernel-configuration-pt-one.html#rest_code_05c2ae96dea14506ac19f94c3601081c-11"></a><span class="nl">_rng_64_fallback:</span><span class="w"></span>
<a id="rest_code_05c2ae96dea14506ac19f94c3601081c-12" name="rest_code_05c2ae96dea14506ac19f94c3601081c-12" href="posts/kernel-configuration-pt-one.html#rest_code_05c2ae96dea14506ac19f94c3601081c-12"></a><span class="w">        </span><span class="nf">ldr</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">],</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="rest_code_05c2ae96dea14506ac19f94c3601081c-13" name="rest_code_05c2ae96dea14506ac19f94c3601081c-13" href="posts/kernel-configuration-pt-one.html#rest_code_05c2ae96dea14506ac19f94c3601081c-13"></a><span class="w">        </span><span class="nf">ret</span><span class="w"></span>
</pre></div>
<p>We're going to use this stub as our jump location, and
use the boot code to change the fallback branch to the
hardware RNG branch if we have the RNG enabled.</p>
<p>In the boot sequence we'll then add this:</p>
<div class="code"><pre class="code asm"><a id="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-1" name="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-1" href="posts/kernel-configuration-pt-one.html#rest_code_abafc7d7b8de4f4c86aff215815a5d5d-1"></a><span class="nf">mrs</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">ID_AA64ISAR0_EL1</span><span class="w"></span>
<a id="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-2" name="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-2" href="posts/kernel-configuration-pt-one.html#rest_code_abafc7d7b8de4f4c86aff215815a5d5d-2"></a><span class="nf">lsr</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="w"></span>
<a id="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-3" name="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-3" href="posts/kernel-configuration-pt-one.html#rest_code_abafc7d7b8de4f4c86aff215815a5d5d-3"></a><span class="nf">and</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-4" name="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-4" href="posts/kernel-configuration-pt-one.html#rest_code_abafc7d7b8de4f4c86aff215815a5d5d-4"></a>
<a id="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-5" name="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-5" href="posts/kernel-configuration-pt-one.html#rest_code_abafc7d7b8de4f4c86aff215815a5d5d-5"></a><span class="nf">cbz</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">_skip_rng_fallback</span><span class="w"></span>
<a id="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-6" name="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-6" href="posts/kernel-configuration-pt-one.html#rest_code_abafc7d7b8de4f4c86aff215815a5d5d-6"></a>
<a id="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-7" name="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-7" href="posts/kernel-configuration-pt-one.html#rest_code_abafc7d7b8de4f4c86aff215815a5d5d-7"></a><span class="nf">adr</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">_rng_64_branch</span><span class="w"></span>
<a id="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-8" name="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-8" href="posts/kernel-configuration-pt-one.html#rest_code_abafc7d7b8de4f4c86aff215815a5d5d-8"></a><span class="nf">adr</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">_rng_64_hardware</span><span class="w"></span>
<a id="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-9" name="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-9" href="posts/kernel-configuration-pt-one.html#rest_code_abafc7d7b8de4f4c86aff215815a5d5d-9"></a><span class="nf">str</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-10" name="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-10" href="posts/kernel-configuration-pt-one.html#rest_code_abafc7d7b8de4f4c86aff215815a5d5d-10"></a>
<a id="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-11" name="rest_code_abafc7d7b8de4f4c86aff215815a5d5d-11" href="posts/kernel-configuration-pt-one.html#rest_code_abafc7d7b8de4f4c86aff215815a5d5d-11"></a><span class="nl">_skip_rng_fallback:</span><span class="w"></span>
</pre></div>
<p>We're overwriting the pointer if the hardwarve feature is
enabled, since its default value is <code class="docutils literal">_rng_64_fallback</code>.
The hardware RNG is then used like this:</p>
<blockquote>
<div class="code"><pre class="code asm"><a id="rest_code_90eaa1258b9b42fda637291a9ee13be1-1" name="rest_code_90eaa1258b9b42fda637291a9ee13be1-1" href="posts/kernel-configuration-pt-one.html#rest_code_90eaa1258b9b42fda637291a9ee13be1-1"></a><span class="nl">_rng_64_hardware:</span><span class="w"></span>
<a id="rest_code_90eaa1258b9b42fda637291a9ee13be1-2" name="rest_code_90eaa1258b9b42fda637291a9ee13be1-2" href="posts/kernel-configuration-pt-one.html#rest_code_90eaa1258b9b42fda637291a9ee13be1-2"></a><span class="w"> </span><span class="nf">mrs</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">s3_3_c2_c4_0</span><span class="w">           </span><span class="c1">// rndr</span>
<a id="rest_code_90eaa1258b9b42fda637291a9ee13be1-3" name="rest_code_90eaa1258b9b42fda637291a9ee13be1-3" href="posts/kernel-configuration-pt-one.html#rest_code_90eaa1258b9b42fda637291a9ee13be1-3"></a><span class="w"> </span><span class="nf">str</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_90eaa1258b9b42fda637291a9ee13be1-4" name="rest_code_90eaa1258b9b42fda637291a9ee13be1-4" href="posts/kernel-configuration-pt-one.html#rest_code_90eaa1258b9b42fda637291a9ee13be1-4"></a><span class="w"> </span><span class="nf">ldr</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">],</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="rest_code_90eaa1258b9b42fda637291a9ee13be1-5" name="rest_code_90eaa1258b9b42fda637291a9ee13be1-5" href="posts/kernel-configuration-pt-one.html#rest_code_90eaa1258b9b42fda637291a9ee13be1-5"></a><span class="w"> </span><span class="nf">ret</span><span class="w"></span>
</pre></div>
</blockquote>
<p>Since we're using the same convention as with other
functions, branching into the subroutine using the <code class="docutils literal">bl</code>
instruction, returning arguments on the stack, here we read
the hardware register into <code class="docutils literal">x0</code>, store it on the
preallocated stack space, restore the <code class="docutils literal">x0</code> register
and <code class="docutils literal">ret</code>.</p>
<hr class="docutils">
<p>framebuffer</p>
<p>linker edits</p>
<p>kernel time</p>
<p>and we are gonna set up the framebuffer
here, allocating it in ram and doing all
sorts of funny shit</p>
<dl>
<dt>..code-block::</dt>
<dd><dl>
<dt>the memory map is as follows:</dt>
<dd>
<p>0x40000000        -- QEMU virt ram and kernel start here
STK               -- depending on the size of the kernel</p>
<aside class="system-message"><p class="system-message-title">System Message: ERROR/3 (<span class="docutils literal">&lt;string&gt;</span>, line 164)</p>
<p>Unexpected indentation.</p>
</aside><blockquote>
<p>the bottom of the stack can move around</p>
</blockquote>
<aside class="system-message"><p class="system-message-title">System Message: WARNING/2 (<span class="docutils literal">&lt;string&gt;</span>, line 165)</p>
<p>Block quote ends without a blank line; unexpected unindent.</p>
</aside><p>STK + 0x00100000  -- top of stack (1mb space), bottom of vectors
STK + 0x00101000  -- top of vectors, bottom of ramfb config
STK + 0x00101080  -- top of ramfb config (128b), bottom of ramfb itself
STK + 0x00501080  -- top of ramfb (4mb space), bottom of heap
STK + 0x10501080  -- top of heap</p>
</dd>
</dl></dd>
</dl>
<p>Keep in mind that the entire kernel
and all memory above it are all rewritable
code, and thus we must handle everything with
care in order to not rewrite ourselves.
We are still working with a flat memory model,
and there are no MMU-based safety features; the
code is fully privileged since we're still operating
in kernel mode.
The framebuffer device is basically just
a chunk of RAM we dedicate that QEMU will read
out of and blit to the screen. Framebuffers
are the simplest model of graphical output
you can get on any modern hardware, and they're
also the least powerful and tend to be performance suckers.
To configure the framebuffer, we must first communicate
with QEMU itself, by trawling the QEMU config tree
in the device's memory, figuring out if we can use the DMA
interface, then writing the configuration through
DMA to QEMU's config in big-endian order (!!), and
only then can we use the framebuffer.
Note that the framebuffer <em>requires</em> fw_cfg
to have an enabled DMA, so our first step would be
to check if DMA is enabled and, if not, to skip
framebuffer setup completely and only work with
UART down the line.
see: <a class="reference external" href="https://github.com/qemu/qemu/blob/e93ded1bf6c94ab95015b33e188bc8b0b0c32670/hw/display/ramfb.c#L124">https://github.com/qemu/qemu/blob/e93ded1bf6c94ab95015b33e188bc8b0b0c32670/hw/display/ramfb.c#L124</a>
We'll do this by setting a flag if the DMA is not available,
and later if we write applications that require
the framebuffer we'll check whether it's enabled
and gracefully exit informing the user that the
functionality isn't available instead of writing to
memory that doesn't have any visible effect.</p>
</section>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/baremetal-part-three.html" class="u-url">Baremetal Aarch64: Pt 3, Hello World Ultimate</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                enn
            </span></p>
            <p class="dateline">
            <a href="posts/baremetal-part-three.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-07-26T22:32:54+02:00" itemprop="datePublished" title="2022-07-26 22:32">2022-07-26 22:32</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Last time around I said I was gonna do input but then
totally forgot about it <img alt="BroFrustration" src="emoji/brofrustration.png" style="width: 32px;"> so today's gonna
be a short one on getting input via UART into the
machine and then making it dance like a little
monkey for us.</p>
<section id="uart-revisited"><h2>UART revisited</h2>
<p>The UART interface, like we covered, is dead simple. As
with our output code, our input code is going to be
fully blocking on the CPU until the UART flags change.
Unlike the output, this means that we're going to be
eating CPU time until the user provides with input, which
could take a while. Cheap, nonblocking IO would take
much more of a stack than we have going for us.</p>
<p>Our function will return a single character from input,
and take no arguments. We will need to check if the
<code class="docutils literal">RXFE</code> flag is set (that is, that the receive stack
is empty) on the UART, and wait until it's cleared.</p>
<p>Thankfully, the UART is buffered, so we don't need to
time our reads from the data register to the exact moment
the user writes something.</p>
<div class="code"><pre class="code asm"><a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-1" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-1" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-1"></a><span class="c1">// our input function</span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-2" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-2" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-2"></a><span class="c1">// takes 0 arg on stack, returns 1</span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-3" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-3" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-3"></a><span class="c1">// trashes 2 registers</span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-4" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-4" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-4"></a><span class="nl">_ugetc:</span><span class="w"></span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-5" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-5" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-5"></a><span class="w">        </span><span class="nf">str</span><span class="w">  </span><span class="no">xzr</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-6" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-6" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-6"></a><span class="w">        </span><span class="nf">stp</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-16</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-7" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-7" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-7"></a>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-8" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-8" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-8"></a><span class="w">        </span><span class="nf">adrp</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">UART_BASE</span><span class="w"></span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-9" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-9" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-9"></a><span class="w">        </span><span class="nf">add</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">:</span><span class="no">lo12</span><span class="p">:</span><span class="no">UART_BASE</span><span class="w"></span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-10" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-10" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-10"></a><span class="w">        </span><span class="nf">ldr</span><span class="w">  </span><span class="no">w0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-11" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-11" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-11"></a><span class="w">                        </span><span class="c1">// now x0 has the UART_BASE location</span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-12" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-12" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-12"></a>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-13" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-13" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-13"></a><span class="w">        </span><span class="nf">add</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x18</span><span class="w">    </span><span class="c1">// UART_FLAG address</span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-14" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-14" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-14"></a>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-15" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-15" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-15"></a><span class="w">        </span><span class="nl">_ugetc_loop1:</span><span class="w"></span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-16" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-16" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-16"></a><span class="w">                </span><span class="nf">ldr</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-17" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-17" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-17"></a><span class="w">                </span><span class="nf">and</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x10</span><span class="w"></span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-18" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-18" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-18"></a><span class="w">                </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">_ugetc_loop1</span><span class="w"></span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-19" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-19" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-19"></a>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-20" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-20" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-20"></a><span class="w">        </span><span class="nf">sub</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x18</span><span class="w"></span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-21" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-21" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-21"></a><span class="w">        </span><span class="nf">ldr</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-22" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-22" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-22"></a><span class="w">        </span><span class="nf">str</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-23" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-23" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-23"></a><span class="w">        </span><span class="nf">ldp</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_9ffe45a862ed44cab1e950b25d011d50-24" name="rest_code_9ffe45a862ed44cab1e950b25d011d50-24" href="posts/baremetal-part-three.html#rest_code_9ffe45a862ed44cab1e950b25d011d50-24"></a><span class="w">        </span><span class="nf">ret</span><span class="w"></span>
</pre></div>
<p>We reserved a place on the stack for the return argument,
then stored the return there, while popping everything else.</p>
<p>Some fun code to play around with in the main code path:</p>
<div class="code"><pre class="code asm"><a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-1" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-1" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-1"></a><span class="nl">PLEASE_WRITE:</span><span class="w">   </span><span class="na">.asciz</span><span class="w"> </span><span class="s">"Please input a key and I'll do my best to repeat it and tell you if it's odd or even: "</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-2" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-2" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-2"></a>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-3" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-3" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-3"></a><span class="err">3:</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-4" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-4" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-4"></a><span class="w">        </span><span class="nf">ldr</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="err">=</span><span class="no">EXAMPLE_STRING</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-5" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-5" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-5"></a><span class="w">        </span><span class="nf">str</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-6" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-6" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-6"></a><span class="w">        </span><span class="nf">bl</span><span class="w"> </span><span class="no">_uputs</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-7" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-7" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-7"></a><span class="w">                </span><span class="c1">// and Hello World, finally!</span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-8" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-8" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-8"></a>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-9" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-9" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-9"></a><span class="w">        </span><span class="nf">ldr</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="err">=</span><span class="no">PLEASE_WRITE</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-10" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-10" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-10"></a><span class="w">        </span><span class="nf">str</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-11" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-11" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-11"></a><span class="w">        </span><span class="nf">bl</span><span class="w"> </span><span class="no">_uputs</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-12" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-12" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-12"></a>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-13" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-13" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-13"></a><span class="w">        </span><span class="nl">_parity_loop:</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-14" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-14" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-14"></a><span class="w">                </span><span class="nf">bl</span><span class="w">  </span><span class="no">_ugetc</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-15" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-15" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-15"></a><span class="w">                </span><span class="nf">ldr</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-16" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-16" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-16"></a><span class="w">                </span><span class="nf">and</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0xff</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-17" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-17" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-17"></a>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-18" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-18" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-18"></a><span class="w">                </span><span class="nf">sub</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0x40</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-19" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-19" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-19"></a><span class="w">                </span><span class="nf">cbz</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="no">f</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-20" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-20" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-20"></a><span class="w">                </span><span class="nf">add</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0x40</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-21" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-21" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-21"></a>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-22" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-22" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-22"></a><span class="w">                </span><span class="nf">bl</span><span class="w">  </span><span class="no">_uputc</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-23" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-23" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-23"></a>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-24" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-24" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-24"></a><span class="w">                </span><span class="nf">sub</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0x30</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-25" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-25" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-25"></a><span class="w">                </span><span class="nf">and</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-26" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-26" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-26"></a><span class="w">                </span><span class="nf">cbz</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">_is_even</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-27" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-27" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-27"></a>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-28" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-28" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-28"></a><span class="w">                        </span><span class="nl">_is_odd:</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-29" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-29" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-29"></a><span class="w">                        </span><span class="nf">mov</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0x4f</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-30" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-30" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-30"></a><span class="w">                        </span><span class="nf">b</span><span class="w"> </span><span class="no">_parity_loop_end</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-31" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-31" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-31"></a>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-32" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-32" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-32"></a><span class="w">                        </span><span class="nl">_is_even:</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-33" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-33" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-33"></a><span class="w">                        </span><span class="nf">mov</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0x45</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-34" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-34" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-34"></a>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-35" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-35" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-35"></a><span class="w">                </span><span class="nl">_parity_loop_end:</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-36" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-36" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-36"></a><span class="w">                </span><span class="nf">str</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-37" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-37" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-37"></a><span class="w">                </span><span class="nf">bl</span><span class="w"> </span><span class="no">_uputc</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-38" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-38" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-38"></a><span class="w">                </span><span class="nf">b</span><span class="w">  </span><span class="no">_parity_loop</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-39" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-39" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-39"></a>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-40" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-40" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-40"></a><span class="err">4:</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-41" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-41" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-41"></a><span class="w">        </span><span class="nf">add</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0x40</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-42" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-42" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-42"></a><span class="w">        </span><span class="nf">str</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-43" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-43" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-43"></a><span class="w">        </span><span class="nf">bl</span><span class="w"> </span><span class="no">_uputc</span><span class="w"></span>
<a id="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-44" name="rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-44" href="posts/baremetal-part-three.html#rest_code_1a8f6fc0be3c46f98cf814e68ac4fbf5-44"></a><span class="w">        </span><span class="nf">b</span><span class="w"> </span><span class="p">.</span><span class="w"></span>
</pre></div>
<p>This program tests your input whether it's even or odd,
prints E or O depending on the case, and halts when it
encounters <code class="docutils literal">0x40</code>—that is, <code class="docutils literal">@</code>.</p>
<p>To get the input working correctly, I had to pipe it
to a serial device, and use PuTTY to link to the other side.
If your input isn't working, it's probably due to that.
My own experience here is that the code is somehow extremely
sluggish; there's up to a full second of delay between
my input and the device's response, and I'm not sure
if that's a quirk of using virtual COM ports and PuTTY
to interface with QEMU or a failing of my code. I might
want to write some sort of device driver for input later
on to alleviate that and avoid serial TTY, so we'll see.</p>
</section>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/baremetal-part-two.html" class="u-url">Baremetal Aarch64: Pt 2, Hello World Advanced</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                enn
            </span></p>
            <p class="dateline">
            <a href="posts/baremetal-part-two.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-07-25T17:17:01+02:00" itemprop="datePublished" title="2022-07-25 17:17">2022-07-25 17:17</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>So we set up the UART device and we are going to use it as
the main way to talk to the outside world for now. The UART
is dead simple to set up and use, especially when compared
with writing a driver for more conventional communication
methods. Apart from console output, which we tested last time,
we're also going to use it as our (unbuffered) input method.
I'm not gonna go through the effort of writing a PS/2 or
USB stack for a Hello World kind of deal, UART is sufficient.</p>
<section id="cleaning-up"><h2>Cleaning up</h2>
<p><a class="reference external" href="posts/baremetal-part-one.html">Last time</a> I cut some corners in that I hardcoded the
UART memory address but now we're gonna properly load it from a
label that we can conveniently change if, somewhere down the
line, the UART base changes or if something else happens that
we gotta take care of. The start of label 1 will now be:</p>
<div class="code"><pre class="code asm"><a id="rest_code_1af1f35977ab459294ab6d0037791581-1" name="rest_code_1af1f35977ab459294ab6d0037791581-1" href="posts/baremetal-part-two.html#rest_code_1af1f35977ab459294ab6d0037791581-1"></a><span class="w">        </span><span class="nl">UART_BASE:</span><span class="w"> </span><span class="na">.word</span><span class="w"> </span><span class="mi">0x09000000</span><span class="w"></span>
<a id="rest_code_1af1f35977ab459294ab6d0037791581-2" name="rest_code_1af1f35977ab459294ab6d0037791581-2" href="posts/baremetal-part-two.html#rest_code_1af1f35977ab459294ab6d0037791581-2"></a><span class="c1">//      UART_DATA: .byte 0x00</span>
<a id="rest_code_1af1f35977ab459294ab6d0037791581-3" name="rest_code_1af1f35977ab459294ab6d0037791581-3" href="posts/baremetal-part-two.html#rest_code_1af1f35977ab459294ab6d0037791581-3"></a><span class="c1">//      UART_FLAG: .byte 0x18</span>
<a id="rest_code_1af1f35977ab459294ab6d0037791581-4" name="rest_code_1af1f35977ab459294ab6d0037791581-4" href="posts/baremetal-part-two.html#rest_code_1af1f35977ab459294ab6d0037791581-4"></a><span class="c1">//      UART_CNTL: .byte 0x30</span>
<a id="rest_code_1af1f35977ab459294ab6d0037791581-5" name="rest_code_1af1f35977ab459294ab6d0037791581-5" href="posts/baremetal-part-two.html#rest_code_1af1f35977ab459294ab6d0037791581-5"></a><span class="c1">//      UART_FIFO: .byte 0x34</span>
<a id="rest_code_1af1f35977ab459294ab6d0037791581-6" name="rest_code_1af1f35977ab459294ab6d0037791581-6" href="posts/baremetal-part-two.html#rest_code_1af1f35977ab459294ab6d0037791581-6"></a><span class="c1">//      UART_INTC: .byte 0x44</span>
<a id="rest_code_1af1f35977ab459294ab6d0037791581-7" name="rest_code_1af1f35977ab459294ab6d0037791581-7" href="posts/baremetal-part-two.html#rest_code_1af1f35977ab459294ab6d0037791581-7"></a>
<a id="rest_code_1af1f35977ab459294ab6d0037791581-8" name="rest_code_1af1f35977ab459294ab6d0037791581-8" href="posts/baremetal-part-two.html#rest_code_1af1f35977ab459294ab6d0037791581-8"></a><span class="w">        </span><span class="na">.section</span><span class="w"> </span><span class="no">.text</span><span class="w"></span>
<a id="rest_code_1af1f35977ab459294ab6d0037791581-9" name="rest_code_1af1f35977ab459294ab6d0037791581-9" href="posts/baremetal-part-two.html#rest_code_1af1f35977ab459294ab6d0037791581-9"></a><span class="w">        </span><span class="err">1:</span><span class="w"></span>
<a id="rest_code_1af1f35977ab459294ab6d0037791581-10" name="rest_code_1af1f35977ab459294ab6d0037791581-10" href="posts/baremetal-part-two.html#rest_code_1af1f35977ab459294ab6d0037791581-10"></a><span class="w">                </span><span class="nf">adrp</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">UART_BASE</span><span class="w"></span>
<a id="rest_code_1af1f35977ab459294ab6d0037791581-11" name="rest_code_1af1f35977ab459294ab6d0037791581-11" href="posts/baremetal-part-two.html#rest_code_1af1f35977ab459294ab6d0037791581-11"></a><span class="w">                </span><span class="nf">add</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">:</span><span class="no">lo12</span><span class="p">:</span><span class="no">UART_BASE</span><span class="w"></span>
<a id="rest_code_1af1f35977ab459294ab6d0037791581-12" name="rest_code_1af1f35977ab459294ab6d0037791581-12" href="posts/baremetal-part-two.html#rest_code_1af1f35977ab459294ab6d0037791581-12"></a><span class="w">                </span><span class="nf">ldr</span><span class="w">  </span><span class="no">w0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_1af1f35977ab459294ab6d0037791581-13" name="rest_code_1af1f35977ab459294ab6d0037791581-13" href="posts/baremetal-part-two.html#rest_code_1af1f35977ab459294ab6d0037791581-13"></a>
<a id="rest_code_1af1f35977ab459294ab6d0037791581-14" name="rest_code_1af1f35977ab459294ab6d0037791581-14" href="posts/baremetal-part-two.html#rest_code_1af1f35977ab459294ab6d0037791581-14"></a><span class="w">                </span><span class="nf">add</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x30</span><span class="w">               </span><span class="c1">// UART_CNTL</span>
</pre></div>
<p>Not much has changed, except we're now loading the address.
You'll note that it's a federal fucking issue to load from
memory in Aarch64. We're first loading the page address of
where the <code class="docutils literal">UART_BASE</code> label is located into <code class="docutils literal">x0</code> via the
<code class="docutils literal">adrp</code> instruction; this loads the higher 56 bits of the
address into the register, which then forces us to add the
offset separately using <code class="docutils literal">add</code> and the <code class="docutils literal"><span class="pre">:lo12:(name)</span></code>
specifier, where the assembler helpfully extracts the lower
12 bits (hence the name) of the label for us and generates
a normal <code class="docutils literal">add</code> instruction with the offset as an immediate.</p>
<p>Two pits I fell into while playing with this:</p>
<blockquote>
<ol class="arabic simple">
<li><p>sometimes the assembler fails to error on unaligned access and will joyfully read instructions one byte off</p></li>
<li><p><code class="docutils literal">ldr x0, [x0]</code> was a big headache since reading from a word into a dword register reads the word <em>twice</em>, once in low and once in high bits</p></li>
</ol>
</blockquote>
<p>The second one I keep forgetting about every now and then,
I'm 100% sure I'll encounter it again. It's not mentioned in
the official online docs, and I don't even see it mentioned in
the 5200 (!) page architecture reference manual, though that
might be my own search fuckup.</p>
<p>When you <code class="docutils literal">make</code> and run this, it should do the same thing
as before. We're not gonna load the offsets from memory because
they're tiny (meaning it's much more of a chore to load them and
add them to the base) <a class="footnote-reference brackets" href="posts/baremetal-part-two.html#footnote-1" id="footnote-reference-1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> and, more importantly, they're guaranteed
to never change relative to base and each other. We're also going
to set UART up only once and won't change anything in the
control register in the foreseeable future.</p>
</section><section id="uart-safety-printing-and-you"><h2>UART Safety, Printing and You!</h2>
<p>The PL011 UART is equipped with a flag register that can tell us
what the UART is doing right now and how it's going, so we can
poll it to see whether it's ready to take a byte from us to print
or not. From a quick look at the docs we see that we need to
test for whether <code class="docutils literal">UARTFR &amp; 0x28</code> returns true and wait until
it isn't.</p>
<p>We'll also want to compartmentalise the print into a procedure
or function. This is going to mean we'll have to think about
how to pass arguments to functions, since our <code class="docutils literal">putchar()</code>
lookalike will consume a single byte that its caller will pass
into it. Remember that spiel about calling conventions?</p>
<p>We'll call the routine <code class="docutils literal">_uputc</code>, standing for "U(ART)-put-c(har)".</p>
<p>We can write the function out in high-level pseudocode to see
exactly what's going to have to happen:</p>
<div class="code"><pre class="code c"><a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-1" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-1" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">_uputc</span><span class="p">(</span><span class="n">byte</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-2" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-2" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-2"></a><span class="p">{</span><span class="w"></span>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-3" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-3" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-3"></a><span class="w">        </span><span class="n">REGISTER</span><span class="w">  </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-4" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-4" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-4"></a><span class="w">        </span><span class="n">REGISTER</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UARTDR</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-5" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-5" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-5"></a>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-6" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-6" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-6"></a><span class="w">        </span><span class="n">b</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mh">0x18</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-7" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-7" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-7"></a>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-8" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-8" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-8"></a><span class="w">        </span><span class="k">do</span><span class="w"></span>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-9" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-9" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-9"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-10" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-10" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-10"></a><span class="w">                </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-11" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-11" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-11"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x28</span><span class="p">);</span><span class="w"></span>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-12" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-12" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-12"></a>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-13" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-13" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-13"></a><span class="w">        </span><span class="n">b</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mh">0x18</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-14" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-14" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-14"></a>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-15" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-15" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-15"></a><span class="w">        </span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-16" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-16" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-16"></a>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-17" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-17" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-17"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_a851b2ca1b3e4035b7067acdeb529c60-18" name="rest_code_a851b2ca1b3e4035b7067acdeb529c60-18" href="posts/baremetal-part-two.html#rest_code_a851b2ca1b3e4035b7067acdeb529c60-18"></a><span class="p">}</span><span class="w"></span>
</pre></div>
<p>This immediately tells us we need three registers to store
the UART flags (<code class="docutils literal">a</code>), the UART address (<code class="docutils literal">b</code>), and the
argument to send to the UART data register (<code class="docutils literal">x</code>).</p>
<section id="aarch64-specifics"><h3>Aarch64 specifics</h3>
<p>Though massively simpler than the clusterfuck that is x86,
Aarch64 has a lot of very unfunny specifics that are
not documented in any user-friendly way. Just the Arm A-profile
architecture reference manual is (as of right now) 11 530
A4 pages, and going through dozens of thousands of pages
looking for relevant info is not the easiest thing, especially
if you have to repeat it.</p>
<p>We're working with a more sophisticated Arm processor than the
average embedded board has. This means there are significant
memory and exception safety features that can be toggled on
or off, and you can do about the same things in a Cortex-A that
you can with x86 privilege rings. There are four rings in
the standard, and not all devices need to implement all the
levels—a CPU needs to have at least <code class="docutils literal">EL0</code> and <code class="docutils literal">EL1</code>.
The higher the number, the more privilege we have executing
code and shit.  We'll be staying in Exception Level One (<code class="docutils literal">EL1</code>),
which is the highest QEMU provides normally. <a class="footnote-reference brackets" href="posts/baremetal-part-two.html#footnote-2" id="footnote-reference-2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a></p>
<p>One of the main funnies here is that Aarch64 really
wants to enforce <em>stack alignment</em> to sixteen bytes, and if
you try to access the <code class="docutils literal">SP</code> while it's unaligned you will,
in most cases, brick your CPU for the time being since
you can't recover from exceptions. To make sure this
doesn't happen, you can either always align to 16 bytes, or
disable this. We want to disable memory alignment fault
exceptions in general, and we do this by playing with the
<code class="docutils literal">SCTLR_EL1</code> system register.</p>
<p>The instruction that reads from a system reg is <code class="docutils literal">mrs</code> and
the one that writes to a system reg is <code class="docutils literal">msr</code>.
Each takes one named register and one numbered
general-purpose register as arguments, in a destination-source
order.</p>
<p>To disable these fault exceptions, we will use:</p>
<div class="code"><pre class="code asm"><a id="rest_code_3998eed367834c4f8ab88d10001f3089-1" name="rest_code_3998eed367834c4f8ab88d10001f3089-1" href="posts/baremetal-part-two.html#rest_code_3998eed367834c4f8ab88d10001f3089-1"></a><span class="nf">mrs</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">SCTLR_EL1</span><span class="w"></span>
<a id="rest_code_3998eed367834c4f8ab88d10001f3089-2" name="rest_code_3998eed367834c4f8ab88d10001f3089-2" href="posts/baremetal-part-two.html#rest_code_3998eed367834c4f8ab88d10001f3089-2"></a><span class="nf">mov</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1a</span><span class="w"></span>
<a id="rest_code_3998eed367834c4f8ab88d10001f3089-3" name="rest_code_3998eed367834c4f8ab88d10001f3089-3" href="posts/baremetal-part-two.html#rest_code_3998eed367834c4f8ab88d10001f3089-3"></a><span class="nf">neg</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w"></span>
<a id="rest_code_3998eed367834c4f8ab88d10001f3089-4" name="rest_code_3998eed367834c4f8ab88d10001f3089-4" href="posts/baremetal-part-two.html#rest_code_3998eed367834c4f8ab88d10001f3089-4"></a><span class="nf">and</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w"></span>
<a id="rest_code_3998eed367834c4f8ab88d10001f3089-5" name="rest_code_3998eed367834c4f8ab88d10001f3089-5" href="posts/baremetal-part-two.html#rest_code_3998eed367834c4f8ab88d10001f3089-5"></a><span class="nf">msr</span><span class="w"> </span><span class="no">SCTLR_EL1</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="w"></span>
</pre></div>
<p>This disables unaligned stack access faults, and
register load/store misalignment faults, which makes
working with the stack and with the heap quite a bit less
headache-inducing.</p>
<p>Unaligned stack access faults are especially annoying
because this funny processor feature means that storing
a single register on stack means you unknowingly get to
brick the CPU very very easily. Programmer wisdom and
developer references from the likes of Apple and wise
guys from StackOverflow even tell you that you <em>must</em>
keep the stack aligned and that there's no way around
this, which is totally untrue. I don't know who thought
this was a good idea.</p>
<hr class="docutils">
<p>We can't use the stack out of the box, though. Upon
cold reset, the value of the SP <em>should</em> be zero, and
on a warm reset it's 'an architecturally UNKNOWN value'
as per the manual. This means that you just gotta set
the stack up yourself every time you boot—though you
have to do that in x86 as well so it's no big deal.</p>
<p>Configuring the stack is not really that Big of a Deal.
If you recall our linker script, we allocated an extra
<code class="docutils literal">0x100000</code> bytes above our <code class="docutils literal">.data</code> and <code class="docutils literal">.bss</code> sections
and assigned that to <code class="docutils literal">stack_top</code>. To set the stack pointer up
we need to load this location's address into memory, then
add four (since we will predecrement on push and postincrement
on pop) to ensure we push to the very top of the space. This
new value we'll then load into the <code class="docutils literal">sp</code> register, and the rest
is handled by the assembler. The code is as simple as it gets:</p>
<div class="code"><pre class="code asm"><a id="rest_code_7ea98b0232224a5d97bd85148267d5e7-1" name="rest_code_7ea98b0232224a5d97bd85148267d5e7-1" href="posts/baremetal-part-two.html#rest_code_7ea98b0232224a5d97bd85148267d5e7-1"></a><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="err">=</span><span class="no">stack_top</span><span class="w"></span>
<a id="rest_code_7ea98b0232224a5d97bd85148267d5e7-2" name="rest_code_7ea98b0232224a5d97bd85148267d5e7-2" href="posts/baremetal-part-two.html#rest_code_7ea98b0232224a5d97bd85148267d5e7-2"></a><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x4</span><span class="w"></span>
<a id="rest_code_7ea98b0232224a5d97bd85148267d5e7-3" name="rest_code_7ea98b0232224a5d97bd85148267d5e7-3" href="posts/baremetal-part-two.html#rest_code_7ea98b0232224a5d97bd85148267d5e7-3"></a><span class="nf">mov</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="w"></span>
</pre></div>
<p>We gave the kernel stack 1MB of memory to do what it
wants with it. This is a relatively crude approach, but it gets
the job done for now.</p>
<p>Though for now it doesn't matter, we have to be careful
with memory management way down the line. Because we're not
using the MMU to its full capacity, our memory model is essentially
flat as far as code and data are concerned. Aside from the memory-mapped
devices below the <code class="docutils literal">0x40000000</code> address, where the device
has mapped all the fancy stuff like UARTs and whatever,
the MMU gave us the <code class="docutils literal">memory</code> device (RAM) starting at
address <code class="docutils literal">0x40000000</code> and going on for <code class="docutils literal">0x10000000</code> bytes
(configured through the commandline), and the <code class="docutils literal">flash</code> device
starting at <code class="docutils literal">0x0</code> and ending at <code class="docutils literal">0x04000000</code>, which should
store ROM but <em>we're not using it</em>. Our program code
and data are all in the same flat memory space, with no
mem management or segmentation, which means our code is
writable, which means pushing too much onto the stack will mean
actually overwriting the kernel.</p>
<p>There's several ways of solving this, such as putting the stack below
the kernel or at the top of RAM growing downwards into the heap, but
neither of those are necessary right now really, because we won't
be getting a megabyte of stack exhausted any time soon anyway.</p>
</section><section id="back-to-uputc-byte-x"><h3>Back to <code class="docutils literal">_uputc(byte x)</code>
</h3>
<p>Fact is that, if we want to do any kind of compartmentalisation
and shunting code off into subroutines, we have to be aware
that we're now responsible for making a generic subroutine that
will work independently of what called it, and that the code
doesn't disrupt its caller's operation in any way.</p>
<p>When you're generating a bunch of assembly automatically,
this is where calling conventions come in handy: the compiler
has a list of what it must, can and cannot do when getting two
chunks of code to interact.</p>
<p>Generally, calling conventions prioritise passing data through
the register bank, since that's much faster than using memory
for data transfers. When you run out of registers, you usually
have to <em>spill</em> data onto the stack, and getting data to and from
the stack is a lot slower than just working with RAM. Sometimes
you see this in professional code (the Go compiler didn't know
about register transfer until like 2020 I think), but generally
you spill only when you have to.</p>
<p>This convention starts mattering a little bit less when you're
hand-writing both the callers and the subroutines: you can tune
the data transfer mechanism per pair very accurately to reflect
your needs in a way that compilers (still?) can't. Perhaps
this one function will use registers <code class="docutils literal">x7</code> through <code class="docutils literal">x11</code>, while
another will want <code class="docutils literal">q0</code> through <code class="docutils literal">q3</code> because of their larger
size.</p>
<p>The one constant is that the subroutine will always have to be
called in a specific way. If you want to change how it's called,
you have to either write boilerplate that maps this new
call to what the subroutine understands, or write a new
routine wholesale.</p>
<p>This is a sacrifice that you <em>can</em> make very
easily, and the way this works out for you is much like how C
does it: you don't get overloading, name-mangling and resolution
like in C++, and you'll have to give separate names to routines
with the same functionality but different parameter schemes.</p>
<p>On the other hand, we can just pass things in and out of
routines using the stack. This simplifies the register saving
dance at the expense of losing at least a few cycles here and
there. Accessing cache is pretty fast, but still slower than
accessing registers (I feel it's a factor of 4 kind of deal),
so we gotta make it worth it.</p>
<p>Luckily for us, Aarch64 gives us an unusually meaty powerful tool
here. Despite actually lacking dedicated push and pop instructions
that are around in 32-bit Arm, Aarch64 lets us load and store
registers in pairs in a single instruction. We're thus gonna
be using <code class="docutils literal">ldp</code> and <code class="docutils literal">stp</code> (and their variants where necessary)
for this, in addition to using <code class="docutils literal">ldr</code> and <code class="docutils literal">str</code> for the generic
register storage option.</p>
<p>The load and store pair instructions work on all the registers,
both integers (e.g. <code class="docutils literal">stp x1, x2, [sp, <span class="pre">#-16]!</span></code>) and vectors/floats
(so, <code class="docutils literal">ldp q1, q2, [sp], #32</code>). This lets us transfer up to 256
bits of memory in one go (assuming your CPU uses 128-bit NEON and
not the bigger SVE registers that can go beyond 1024 bits), and
not lose (m)any cycles doing it if the chunk is in cache. <a class="footnote-reference brackets" href="posts/baremetal-part-two.html#footnote-3" id="footnote-reference-3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a></p>
<p>So for this subroutine, we'll be saving the trashed registers
to the stack and getting the argument from the stack.</p>
<p>Let's revisit the pseudocode:</p>
<div class="code"><pre class="code c"><a id="rest_code_d783a19713084175b0b9b481d8b9a040-1" name="rest_code_d783a19713084175b0b9b481d8b9a040-1" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">_uputc</span><span class="p">(</span><span class="n">byte</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-2" name="rest_code_d783a19713084175b0b9b481d8b9a040-2" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-2"></a><span class="p">{</span><span class="w"></span>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-3" name="rest_code_d783a19713084175b0b9b481d8b9a040-3" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-3"></a><span class="w">        </span><span class="n">REGISTER</span><span class="w">  </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-4" name="rest_code_d783a19713084175b0b9b481d8b9a040-4" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-4"></a><span class="w">        </span><span class="n">REGISTER</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UARTDR</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-5" name="rest_code_d783a19713084175b0b9b481d8b9a040-5" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-5"></a>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-6" name="rest_code_d783a19713084175b0b9b481d8b9a040-6" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-6"></a><span class="w">        </span><span class="n">b</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mh">0x18</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-7" name="rest_code_d783a19713084175b0b9b481d8b9a040-7" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-7"></a>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-8" name="rest_code_d783a19713084175b0b9b481d8b9a040-8" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-8"></a><span class="w">        </span><span class="k">do</span><span class="w"></span>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-9" name="rest_code_d783a19713084175b0b9b481d8b9a040-9" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-9"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-10" name="rest_code_d783a19713084175b0b9b481d8b9a040-10" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-10"></a><span class="w">                </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-11" name="rest_code_d783a19713084175b0b9b481d8b9a040-11" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-11"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x28</span><span class="p">);</span><span class="w"></span>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-12" name="rest_code_d783a19713084175b0b9b481d8b9a040-12" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-12"></a>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-13" name="rest_code_d783a19713084175b0b9b481d8b9a040-13" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-13"></a><span class="w">        </span><span class="n">b</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mh">0x18</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-14" name="rest_code_d783a19713084175b0b9b481d8b9a040-14" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-14"></a>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-15" name="rest_code_d783a19713084175b0b9b481d8b9a040-15" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-15"></a><span class="w">        </span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-16" name="rest_code_d783a19713084175b0b9b481d8b9a040-16" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-16"></a>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-17" name="rest_code_d783a19713084175b0b9b481d8b9a040-17" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-17"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_d783a19713084175b0b9b481d8b9a040-18" name="rest_code_d783a19713084175b0b9b481d8b9a040-18" href="posts/baremetal-part-two.html#rest_code_d783a19713084175b0b9b481d8b9a040-18"></a><span class="p">}</span><span class="w"></span>
</pre></div>
<p>For this, we'll obviously need two registers to do
the logic work for us, and one to store our argument.
Since we have to save three registers, stack alignment
has to be off—but we've luckily disabled it.</p>
<p>In our caller code we'll have:</p>
<div class="code"><pre class="code asm"><a id="rest_code_0f23570f8dc644818354f401f91a17da-1" name="rest_code_0f23570f8dc644818354f401f91a17da-1" href="posts/baremetal-part-two.html#rest_code_0f23570f8dc644818354f401f91a17da-1"></a><span class="nf">mov</span><span class="w"> </span><span class="no">x17</span><span class="p">,</span><span class="w"> </span><span class="mi">0x48</span><span class="w">        </span><span class="c1">// the character 'H'</span>
<a id="rest_code_0f23570f8dc644818354f401f91a17da-2" name="rest_code_0f23570f8dc644818354f401f91a17da-2" href="posts/baremetal-part-two.html#rest_code_0f23570f8dc644818354f401f91a17da-2"></a><span class="nf">str</span><span class="w"> </span><span class="no">x17</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w">   </span><span class="c1">// our output argument</span>
<a id="rest_code_0f23570f8dc644818354f401f91a17da-3" name="rest_code_0f23570f8dc644818354f401f91a17da-3" href="posts/baremetal-part-two.html#rest_code_0f23570f8dc644818354f401f91a17da-3"></a><span class="nf">bl</span><span class="w"> </span><span class="no">_uputc</span><span class="w"></span>
</pre></div>
<p>Essentially, it doesn't matter which register we get
the argument from, so that the subroutine will always
see the argument on the stack and the caller won't
have to bend over backwards to get the argument
into a specific register.</p>
<p>The subroutine will then look like this:</p>
<div class="code"><pre class="code asm"><a id="rest_code_c02acb32844e46228ff11168191d121c-1" name="rest_code_c02acb32844e46228ff11168191d121c-1" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-1"></a><span class="c1">// our print function</span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-2" name="rest_code_c02acb32844e46228ff11168191d121c-2" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-2"></a><span class="c1">// takes 1 arg on stack, returns 0</span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-3" name="rest_code_c02acb32844e46228ff11168191d121c-3" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-3"></a><span class="c1">// trashes 3 registers</span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-4" name="rest_code_c02acb32844e46228ff11168191d121c-4" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-4"></a><span class="nl">_uputc:</span><span class="w"></span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-5" name="rest_code_c02acb32844e46228ff11168191d121c-5" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-5"></a><span class="w">        </span><span class="nf">stp</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-16</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-6" name="rest_code_c02acb32844e46228ff11168191d121c-6" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-6"></a><span class="w">        </span><span class="nf">str</span><span class="w">  </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-7" name="rest_code_c02acb32844e46228ff11168191d121c-7" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-7"></a>
<a id="rest_code_c02acb32844e46228ff11168191d121c-8" name="rest_code_c02acb32844e46228ff11168191d121c-8" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-8"></a><span class="w">        </span><span class="nf">ldr</span><span class="w">  </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="p">]</span><span class="w">    </span><span class="c1">// this is where we first pushed</span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-9" name="rest_code_c02acb32844e46228ff11168191d121c-9" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-9"></a><span class="w">                             </span><span class="c1">// the argument in the caller</span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-10" name="rest_code_c02acb32844e46228ff11168191d121c-10" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-10"></a>
<a id="rest_code_c02acb32844e46228ff11168191d121c-11" name="rest_code_c02acb32844e46228ff11168191d121c-11" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-11"></a><span class="w">        </span><span class="nf">adrp</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">UART_BASE</span><span class="w"></span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-12" name="rest_code_c02acb32844e46228ff11168191d121c-12" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-12"></a><span class="w">        </span><span class="nf">add</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">:</span><span class="no">lo12</span><span class="p">:</span><span class="no">UART_BASE</span><span class="w"></span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-13" name="rest_code_c02acb32844e46228ff11168191d121c-13" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-13"></a><span class="w">        </span><span class="nf">ldr</span><span class="w">  </span><span class="no">w0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-14" name="rest_code_c02acb32844e46228ff11168191d121c-14" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-14"></a><span class="w">                        </span><span class="c1">// now x0 has the UART_BASE location</span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-15" name="rest_code_c02acb32844e46228ff11168191d121c-15" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-15"></a>
<a id="rest_code_c02acb32844e46228ff11168191d121c-16" name="rest_code_c02acb32844e46228ff11168191d121c-16" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-16"></a><span class="w">        </span><span class="nf">add</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x18</span><span class="w">    </span><span class="c1">// UART_FLAG address</span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-17" name="rest_code_c02acb32844e46228ff11168191d121c-17" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-17"></a>
<a id="rest_code_c02acb32844e46228ff11168191d121c-18" name="rest_code_c02acb32844e46228ff11168191d121c-18" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-18"></a><span class="w">        </span><span class="nl">_uputc_loop1:</span><span class="w"></span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-19" name="rest_code_c02acb32844e46228ff11168191d121c-19" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-19"></a><span class="w">                </span><span class="nf">ldr</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w">          </span><span class="c1">// read from UART_FLAG</span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-20" name="rest_code_c02acb32844e46228ff11168191d121c-20" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-20"></a><span class="w">                </span><span class="nf">and</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0xff</span><span class="w">      </span><span class="c1">// 0010 1000 = busy &amp; transmit full</span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-21" name="rest_code_c02acb32844e46228ff11168191d121c-21" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-21"></a><span class="w">                </span><span class="nf">bic</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0xc0</span><span class="w">      </span><span class="c1">// but we gotta do it the long way</span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-22" name="rest_code_c02acb32844e46228ff11168191d121c-22" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-22"></a><span class="w">                </span><span class="nf">bic</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x10</span><span class="w"></span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-23" name="rest_code_c02acb32844e46228ff11168191d121c-23" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-23"></a><span class="w">                </span><span class="nf">bic</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x07</span><span class="w"></span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-24" name="rest_code_c02acb32844e46228ff11168191d121c-24" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-24"></a><span class="w">        </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">_uputc_loop1</span><span class="w"></span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-25" name="rest_code_c02acb32844e46228ff11168191d121c-25" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-25"></a>
<a id="rest_code_c02acb32844e46228ff11168191d121c-26" name="rest_code_c02acb32844e46228ff11168191d121c-26" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-26"></a><span class="w">        </span><span class="nf">sub</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x18</span><span class="w">      </span><span class="c1">// back to BASE / DATA</span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-27" name="rest_code_c02acb32844e46228ff11168191d121c-27" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-27"></a><span class="w">        </span><span class="nf">str</span><span class="w">  </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-28" name="rest_code_c02acb32844e46228ff11168191d121c-28" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-28"></a>
<a id="rest_code_c02acb32844e46228ff11168191d121c-29" name="rest_code_c02acb32844e46228ff11168191d121c-29" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-29"></a><span class="w">        </span><span class="nf">ldr</span><span class="w">  </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">],</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-30" name="rest_code_c02acb32844e46228ff11168191d121c-30" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-30"></a><span class="w">        </span><span class="nf">ldp</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">],</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<a id="rest_code_c02acb32844e46228ff11168191d121c-31" name="rest_code_c02acb32844e46228ff11168191d121c-31" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-31"></a>
<a id="rest_code_c02acb32844e46228ff11168191d121c-32" name="rest_code_c02acb32844e46228ff11168191d121c-32" href="posts/baremetal-part-two.html#rest_code_c02acb32844e46228ff11168191d121c-32"></a><span class="w">        </span><span class="nf">ret</span><span class="w"></span>
</pre></div>
<p>You'll note that Aarch64 is especially retarded when it
comes to immediates for bitwise operations, in that they have
to be a mask with a bit pattern of some sort, and not actual
immediates like in arithmetic operations. The block of four
logical ops basically performs the check <code class="docutils literal">and x1, x1, 0x28</code>
but that will not fit into the immediate field here. The
<code class="docutils literal">bic</code> instruction is basically a form of <code class="docutils literal">a &amp; ~b</code> that's
convenient for toggling some specific bits off.</p>
<p>We can actually do some optimisation here and save
one register, though the stack will still be unaligned:</p>
<div class="code"><pre class="code asm"><a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-1" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-1" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-1"></a><span class="c1">// our print function</span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-2" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-2" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-2"></a><span class="c1">// takes 1 arg on stack, returns 0</span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-3" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-3" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-3"></a><span class="c1">// trashes 2 registers</span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-4" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-4" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-4"></a><span class="nl">_uputc:</span><span class="w"></span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-5" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-5" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-5"></a><span class="w">        </span><span class="nf">stp</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-16</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-6" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-6" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-6"></a>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-7" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-7" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-7"></a><span class="w">        </span><span class="nf">adrp</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">UART_BASE</span><span class="w"></span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-8" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-8" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-8"></a><span class="w">        </span><span class="nf">add</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">:</span><span class="no">lo12</span><span class="p">:</span><span class="no">UART_BASE</span><span class="w"></span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-9" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-9" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-9"></a><span class="w">        </span><span class="nf">ldr</span><span class="w">  </span><span class="no">w0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-10" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-10" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-10"></a><span class="w">                        </span><span class="c1">// now x0 has the UART_BASE location</span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-11" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-11" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-11"></a>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-12" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-12" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-12"></a><span class="w">        </span><span class="nf">add</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x18</span><span class="w">    </span><span class="c1">// UART_FLAG address</span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-13" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-13" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-13"></a>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-14" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-14" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-14"></a><span class="w">        </span><span class="nl">_uputc_loop1:</span><span class="w"></span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-15" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-15" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-15"></a><span class="w">                </span><span class="nf">ldr</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w">          </span><span class="c1">// read from UART_FLAG</span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-16" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-16" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-16"></a><span class="w">                </span><span class="nf">and</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0xff</span><span class="w">      </span><span class="c1">// 0010 1000 = busy &amp; transmit full</span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-17" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-17" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-17"></a><span class="w">                </span><span class="nf">bic</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0xc0</span><span class="w">      </span><span class="c1">// but we gotta do it the long way</span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-18" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-18" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-18"></a><span class="w">                </span><span class="nf">bic</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x10</span><span class="w"></span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-19" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-19" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-19"></a><span class="w">                </span><span class="nf">bic</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x07</span><span class="w"></span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-20" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-20" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-20"></a><span class="w">        </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">_uputc_loop1</span><span class="w"></span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-21" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-21" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-21"></a>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-22" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-22" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-22"></a><span class="w">        </span><span class="nf">sub</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x18</span><span class="w">      </span><span class="c1">// back to BASE / DATA</span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-23" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-23" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-23"></a><span class="w">        </span><span class="nf">ldr</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-24" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-24" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-24"></a><span class="w">        </span><span class="nf">str</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-25" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-25" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-25"></a>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-26" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-26" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-26"></a><span class="w">        </span><span class="nf">ldp</span><span class="w">  </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">],</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-27" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-27" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-27"></a><span class="w">        </span><span class="nf">add</span><span class="w">  </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">         </span><span class="c1">// pop the argument off the stack</span>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-28" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-28" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-28"></a>
<a id="rest_code_4cbb2f5c25c54af2be123c358f573a80-29" name="rest_code_4cbb2f5c25c54af2be123c358f573a80-29" href="posts/baremetal-part-two.html#rest_code_4cbb2f5c25c54af2be123c358f573a80-29"></a><span class="w">        </span><span class="nf">ret</span><span class="w"></span>
</pre></div>
<p>An optimisation assembly affords us that we can't
intentionally get in C is the ability to destructively
reuse registers when their data's lifetime's up. A half-decent
C compiler would do this optimisation for you automatically,
but this isn't something you can specify through the language
itself.</p>
</section></section><section id="nested-function-calls"><h2>Nested function calls</h2>
<p>A peculiarity of the Aarch64 ISA is that the <code class="docutils literal">bl</code> instruction
lets us do branches to subroutines without any memory access,
which is extremely good. The way it works is that it stores
the address of the instruction it's accessing + 4 into the
register <code class="docutils literal">x30</code>, then jumping to the label we give it.
Correspondingly, we return from the subroutine we jumped
to using the <code class="docutils literal">ret</code> instruction, which jumps to the address
stored in <code class="docutils literal">x30</code> (i.e. it's an alias).</p>
<p>Predictably, this means that you can only <code class="docutils literal">bl</code> exactly once
before you trash your original return address.</p>
<p>This pair of instructions has its advantages over the x86
<code class="docutils literal">call</code> and <code class="docutils literal">ret</code> pair—no stack access is performed and
things are kept fast, but you have to write the nesting code yourself
and that gets kind of nasty kind of quickly.</p>
<p>We can thus absolutely avoid having to use the stack for
subroutine calls that are one-deep, which saves on memory
at the expense of losing a register.</p>
<p>The next function we'll write will have to call another function
and so we'll have to write nesting code.</p>
<section id="extending-into-uputs-byte-x"><h3>Extending into <code class="docutils literal">_uputs(byte* x)</code>
</h3>
<p>Printing one byte at a time is definitely something we <em>can</em>
but <em>shouldn't</em> do. It's inconvenient on its own, really. To
exemplify function call nesting and to clear up this mess, we
will write a <code class="docutils literal">_uputs</code> function—that is, "U(ART)-put-s(tring)".
The function will take one argument, a zero-terminated C-style
string of bytes from memory, and print it out byte by byte until
we reach zero.</p>
<p>We'll try to minimalise memory accesses as much as possible,
which means doing funny shit with registers. For example, the following
pseudocode would be a good scheme to implement:</p>
<div class="code"><pre class="code c"><a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-1" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-1" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">_uputs</span><span class="p">(</span><span class="n">byte</span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-2" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-2" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-2"></a><span class="p">{</span><span class="w"></span>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-3" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-3" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-3"></a><span class="w">        </span><span class="n">REGISTER</span><span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-4" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-4" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-4"></a><span class="w">        </span><span class="n">REGISTER</span><span class="w">  </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-5" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-5" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-5"></a>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-6" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-6" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-6"></a><span class="w">        </span><span class="k">do</span><span class="w"></span>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-7" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-7" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-7"></a><span class="w">        </span><span class="p">{</span><span class="w"></span>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-8" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-8" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-8"></a><span class="w">                </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-9" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-9" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-9"></a><span class="w">                </span><span class="n">_uputc</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-10" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-10" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-10"></a><span class="w">                </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-11" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-11" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-11"></a><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-12" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-12" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-12"></a><span class="w">                </span><span class="p">{</span><span class="w"></span>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-13" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-13" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-13"></a><span class="w">                        </span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-14" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-14" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-14"></a><span class="w">                        </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-15" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-15" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-15"></a><span class="w">                </span><span class="p">}</span><span class="w"></span>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-16" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-16" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-16"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span><span class="w"></span>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-17" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-17" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-17"></a>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-18" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-18" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-18"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_16557150c76b4b8e92da736e8fd2cf28-19" name="rest_code_16557150c76b4b8e92da736e8fd2cf28-19" href="posts/baremetal-part-two.html#rest_code_16557150c76b4b8e92da736e8fd2cf28-19"></a><span class="p">}</span><span class="w"></span>
</pre></div>
<p>We'll be reading memory in 8-byte chunks
at a time, meaning we'll need to do only one
access per 8 characters (remember, the UART is
an 8-bit interface). If we haven't
reached a zero character, we call the <code class="docutils literal">_uputc</code>
and let it handle the print on its own, abstracted
away from our eyes.</p>
<p>In assembly, we have some more things to think of,
such as storing the <code class="docutils literal">x30</code> on the stack alongside
the other registers in use. We <em>don't</em> have to
think about how long our string is, though.</p>
<p>Reading 64-bit chunks of memory at once could be
"potentially dangerous" i.e. we could be leaking
secret memory or whatever if someone checks
register states when they're not supposed to,
but since the memory model is flat and unprotected,
there won't be any <em>hardware</em> faults to think about
too hard.</p>
<p>Our code should now look like this:</p>
<div class="code"><pre class="code asm"><a id="rest_code_fbbe3dc33646427899d6cf8752886af9-1" name="rest_code_fbbe3dc33646427899d6cf8752886af9-1" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-1"></a><span class="c1">// handler for string printing</span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-2" name="rest_code_fbbe3dc33646427899d6cf8752886af9-2" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-2"></a><span class="c1">// takes 1 arg on stack, returns 0</span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-3" name="rest_code_fbbe3dc33646427899d6cf8752886af9-3" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-3"></a><span class="c1">// trashes 4 registers</span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-4" name="rest_code_fbbe3dc33646427899d6cf8752886af9-4" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-4"></a><span class="nl">_uputs:</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-5" name="rest_code_fbbe3dc33646427899d6cf8752886af9-5" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-5"></a><span class="w">        </span><span class="nf">stp</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-16</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-6" name="rest_code_fbbe3dc33646427899d6cf8752886af9-6" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-6"></a><span class="w">        </span><span class="nf">stp</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-16</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-7" name="rest_code_fbbe3dc33646427899d6cf8752886af9-7" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-7"></a><span class="w">        </span><span class="nf">ldr</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="w">    </span><span class="c1">// the string address</span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-8" name="rest_code_fbbe3dc33646427899d6cf8752886af9-8" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-8"></a><span class="w">        </span><span class="nl">_uputs_loop1:</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-9" name="rest_code_fbbe3dc33646427899d6cf8752886af9-9" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-9"></a><span class="w">                </span><span class="nf">ldr</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w">                  </span><span class="c1">// the initial memory read</span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-10" name="rest_code_fbbe3dc33646427899d6cf8752886af9-10" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-10"></a><span class="w">                </span><span class="nf">cbz</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">_uputs_loop1_end</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-11" name="rest_code_fbbe3dc33646427899d6cf8752886af9-11" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-11"></a><span class="w">                </span><span class="nf">and</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0xff</span><span class="w">              </span><span class="c1">// extract byte</span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-12" name="rest_code_fbbe3dc33646427899d6cf8752886af9-12" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-12"></a><span class="w">                </span><span class="nf">cbz</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">_uputs_loop1_end</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-13" name="rest_code_fbbe3dc33646427899d6cf8752886af9-13" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-13"></a><span class="w">                </span><span class="nf">str</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-14" name="rest_code_fbbe3dc33646427899d6cf8752886af9-14" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-14"></a><span class="w">                </span><span class="nf">bl</span><span class="w">  </span><span class="no">_uputc</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-15" name="rest_code_fbbe3dc33646427899d6cf8752886af9-15" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-15"></a>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-16" name="rest_code_fbbe3dc33646427899d6cf8752886af9-16" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-16"></a><span class="w">                </span><span class="nf">asr</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-17" name="rest_code_fbbe3dc33646427899d6cf8752886af9-17" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-17"></a><span class="w">                </span><span class="nf">and</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0xff</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-18" name="rest_code_fbbe3dc33646427899d6cf8752886af9-18" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-18"></a><span class="w">                </span><span class="nf">cbz</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">_uputs_loop1_end</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-19" name="rest_code_fbbe3dc33646427899d6cf8752886af9-19" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-19"></a><span class="w">                </span><span class="nf">str</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-20" name="rest_code_fbbe3dc33646427899d6cf8752886af9-20" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-20"></a><span class="w">                </span><span class="nf">bl</span><span class="w">  </span><span class="no">_uputc</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-21" name="rest_code_fbbe3dc33646427899d6cf8752886af9-21" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-21"></a>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-22" name="rest_code_fbbe3dc33646427899d6cf8752886af9-22" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-22"></a><span class="w">                </span><span class="nf">asr</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-23" name="rest_code_fbbe3dc33646427899d6cf8752886af9-23" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-23"></a><span class="w">                </span><span class="nf">and</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0xff</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-24" name="rest_code_fbbe3dc33646427899d6cf8752886af9-24" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-24"></a><span class="w">                </span><span class="nf">cbz</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">_uputs_loop1_end</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-25" name="rest_code_fbbe3dc33646427899d6cf8752886af9-25" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-25"></a><span class="w">                </span><span class="nf">str</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-26" name="rest_code_fbbe3dc33646427899d6cf8752886af9-26" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-26"></a><span class="w">                </span><span class="nf">bl</span><span class="w">  </span><span class="no">_uputc</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-27" name="rest_code_fbbe3dc33646427899d6cf8752886af9-27" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-27"></a>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-28" name="rest_code_fbbe3dc33646427899d6cf8752886af9-28" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-28"></a><span class="w">                </span><span class="nf">asr</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-29" name="rest_code_fbbe3dc33646427899d6cf8752886af9-29" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-29"></a><span class="w">                </span><span class="nf">and</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0xff</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-30" name="rest_code_fbbe3dc33646427899d6cf8752886af9-30" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-30"></a><span class="w">                </span><span class="nf">cbz</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">_uputs_loop1_end</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-31" name="rest_code_fbbe3dc33646427899d6cf8752886af9-31" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-31"></a><span class="w">                </span><span class="nf">str</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-32" name="rest_code_fbbe3dc33646427899d6cf8752886af9-32" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-32"></a><span class="w">                </span><span class="nf">bl</span><span class="w">  </span><span class="no">_uputc</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-33" name="rest_code_fbbe3dc33646427899d6cf8752886af9-33" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-33"></a>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-34" name="rest_code_fbbe3dc33646427899d6cf8752886af9-34" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-34"></a><span class="w">                </span><span class="nf">asr</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-35" name="rest_code_fbbe3dc33646427899d6cf8752886af9-35" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-35"></a><span class="w">                </span><span class="nf">and</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0xff</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-36" name="rest_code_fbbe3dc33646427899d6cf8752886af9-36" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-36"></a><span class="w">                </span><span class="nf">cbz</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">_uputs_loop1_end</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-37" name="rest_code_fbbe3dc33646427899d6cf8752886af9-37" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-37"></a><span class="w">                </span><span class="nf">str</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-38" name="rest_code_fbbe3dc33646427899d6cf8752886af9-38" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-38"></a><span class="w">                </span><span class="nf">bl</span><span class="w">  </span><span class="no">_uputc</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-39" name="rest_code_fbbe3dc33646427899d6cf8752886af9-39" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-39"></a>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-40" name="rest_code_fbbe3dc33646427899d6cf8752886af9-40" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-40"></a><span class="w">                </span><span class="nf">asr</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-41" name="rest_code_fbbe3dc33646427899d6cf8752886af9-41" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-41"></a><span class="w">                </span><span class="nf">and</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0xff</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-42" name="rest_code_fbbe3dc33646427899d6cf8752886af9-42" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-42"></a><span class="w">                </span><span class="nf">cbz</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">_uputs_loop1_end</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-43" name="rest_code_fbbe3dc33646427899d6cf8752886af9-43" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-43"></a><span class="w">                </span><span class="nf">str</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-44" name="rest_code_fbbe3dc33646427899d6cf8752886af9-44" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-44"></a><span class="w">                </span><span class="nf">bl</span><span class="w">  </span><span class="no">_uputc</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-45" name="rest_code_fbbe3dc33646427899d6cf8752886af9-45" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-45"></a>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-46" name="rest_code_fbbe3dc33646427899d6cf8752886af9-46" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-46"></a><span class="w">                </span><span class="nf">asr</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-47" name="rest_code_fbbe3dc33646427899d6cf8752886af9-47" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-47"></a><span class="w">                </span><span class="nf">and</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0xff</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-48" name="rest_code_fbbe3dc33646427899d6cf8752886af9-48" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-48"></a><span class="w">                </span><span class="nf">cbz</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">_uputs_loop1_end</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-49" name="rest_code_fbbe3dc33646427899d6cf8752886af9-49" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-49"></a><span class="w">                </span><span class="nf">str</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-50" name="rest_code_fbbe3dc33646427899d6cf8752886af9-50" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-50"></a><span class="w">                </span><span class="nf">bl</span><span class="w">  </span><span class="no">_uputc</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-51" name="rest_code_fbbe3dc33646427899d6cf8752886af9-51" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-51"></a>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-52" name="rest_code_fbbe3dc33646427899d6cf8752886af9-52" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-52"></a><span class="w">                </span><span class="nf">asr</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-53" name="rest_code_fbbe3dc33646427899d6cf8752886af9-53" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-53"></a><span class="w">                </span><span class="nf">and</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0xff</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-54" name="rest_code_fbbe3dc33646427899d6cf8752886af9-54" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-54"></a><span class="w">                </span><span class="nf">cbz</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">_uputs_loop1_end</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-55" name="rest_code_fbbe3dc33646427899d6cf8752886af9-55" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-55"></a><span class="w">                </span><span class="nf">str</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-56" name="rest_code_fbbe3dc33646427899d6cf8752886af9-56" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-56"></a><span class="w">                </span><span class="nf">bl</span><span class="w">  </span><span class="no">_uputc</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-57" name="rest_code_fbbe3dc33646427899d6cf8752886af9-57" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-57"></a>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-58" name="rest_code_fbbe3dc33646427899d6cf8752886af9-58" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-58"></a><span class="w">                </span><span class="nf">add</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">             </span><span class="c1">// shift pointer by 8, and loop</span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-59" name="rest_code_fbbe3dc33646427899d6cf8752886af9-59" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-59"></a><span class="w">                </span><span class="nf">b</span><span class="w"> </span><span class="no">_uputs_loop1</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-60" name="rest_code_fbbe3dc33646427899d6cf8752886af9-60" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-60"></a><span class="w">        </span><span class="nl">_uputs_loop1_end:</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-61" name="rest_code_fbbe3dc33646427899d6cf8752886af9-61" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-61"></a><span class="w">        </span><span class="nf">ldp</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">],</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-62" name="rest_code_fbbe3dc33646427899d6cf8752886af9-62" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-62"></a><span class="w">        </span><span class="nf">ldp</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="no">sp</span><span class="p">],</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-63" name="rest_code_fbbe3dc33646427899d6cf8752886af9-63" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-63"></a><span class="w">        </span><span class="nf">add</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="rest_code_fbbe3dc33646427899d6cf8752886af9-64" name="rest_code_fbbe3dc33646427899d6cf8752886af9-64" href="posts/baremetal-part-two.html#rest_code_fbbe3dc33646427899d6cf8752886af9-64"></a><span class="nf">ret</span><span class="w"></span>
</pre></div>
<p>Instead of reading a byte at a time, we're
reading eight, and then doing a call on each
byte of the register at a time. This reduces
the number of memory accesses by 7 (every eighth
step instead of every step of the loop), which
is helpful when <code class="docutils literal">_uputc</code> already does
at least 6 memory ops (and potentially more) every single call.
I even unrolled a loop manually to save
a register that would otherwise have
gone to waste as a counter. You don't need
to do this, but it saves us a few instructions
and, despite being longer code, will run in fewer
cycles because we avoided two more stack accesses.</p>
<p>This function is called more or less the same
as the previous one, except now you need
to get the address instead of just passing the argument
raw on the stack:</p>
<div class="code"><pre class="code asm"><a id="rest_code_aef9231fe2054fa5ad8ce18c00d21620-1" name="rest_code_aef9231fe2054fa5ad8ce18c00d21620-1" href="posts/baremetal-part-two.html#rest_code_aef9231fe2054fa5ad8ce18c00d21620-1"></a><span class="nl">EXAMPLE_STRING:</span><span class="w"> </span><span class="na">.asciz</span><span class="w"> </span><span class="s">"Hello, world! "</span><span class="w"></span>
<a id="rest_code_aef9231fe2054fa5ad8ce18c00d21620-2" name="rest_code_aef9231fe2054fa5ad8ce18c00d21620-2" href="posts/baremetal-part-two.html#rest_code_aef9231fe2054fa5ad8ce18c00d21620-2"></a><span class="w">        </span><span class="na">.align</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="rest_code_aef9231fe2054fa5ad8ce18c00d21620-3" name="rest_code_aef9231fe2054fa5ad8ce18c00d21620-3" href="posts/baremetal-part-two.html#rest_code_aef9231fe2054fa5ad8ce18c00d21620-3"></a>
<a id="rest_code_aef9231fe2054fa5ad8ce18c00d21620-4" name="rest_code_aef9231fe2054fa5ad8ce18c00d21620-4" href="posts/baremetal-part-two.html#rest_code_aef9231fe2054fa5ad8ce18c00d21620-4"></a><span class="w">        </span><span class="na">...</span><span class="w"></span>
<a id="rest_code_aef9231fe2054fa5ad8ce18c00d21620-5" name="rest_code_aef9231fe2054fa5ad8ce18c00d21620-5" href="posts/baremetal-part-two.html#rest_code_aef9231fe2054fa5ad8ce18c00d21620-5"></a>
<a id="rest_code_aef9231fe2054fa5ad8ce18c00d21620-6" name="rest_code_aef9231fe2054fa5ad8ce18c00d21620-6" href="posts/baremetal-part-two.html#rest_code_aef9231fe2054fa5ad8ce18c00d21620-6"></a><span class="nf">ldr</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="err">=</span><span class="no">EXAMPLE_STRING</span><span class="w"></span>
<a id="rest_code_aef9231fe2054fa5ad8ce18c00d21620-7" name="rest_code_aef9231fe2054fa5ad8ce18c00d21620-7" href="posts/baremetal-part-two.html#rest_code_aef9231fe2054fa5ad8ce18c00d21620-7"></a><span class="nf">str</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">]!</span><span class="w"></span>
<a id="rest_code_aef9231fe2054fa5ad8ce18c00d21620-8" name="rest_code_aef9231fe2054fa5ad8ce18c00d21620-8" href="posts/baremetal-part-two.html#rest_code_aef9231fe2054fa5ad8ce18c00d21620-8"></a><span class="nf">bl</span><span class="w"> </span><span class="no">_uputs</span><span class="w"></span>
</pre></div>
<hr class="docutils">
<p>You can avoid this nested call by writing the
<code class="docutils literal">_uputs()</code> function so that it itself
writes to UART without having to call a
subroutine to do that work. This would both
be more efficient and go faster (think of it
like inlining a function manually), but I feel
like it suffers from readability.</p>
<p>Ultimately, we're not squeezing cycles from a
dry stone, there's much more we could do to
optimise these things that we aren't doing because
the tradeoffs are too severe.</p>
</section></section><section id="extra-features"><h2>Extra features</h2>
<p>There's a few more things we can do to make
the environment a bit more fully-featured. For
example, the floating-point unit is by default disabled
on boot, so we have to enable it by fiddling with
the built-in system control registers:</p>
<div class="code"><pre class="code asm"><a id="rest_code_863301c97c9c479fb9d5ae8512030165-1" name="rest_code_863301c97c9c479fb9d5ae8512030165-1" href="posts/baremetal-part-two.html#rest_code_863301c97c9c479fb9d5ae8512030165-1"></a><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">0x3</span><span class="w"> </span><span class="err">&lt;&lt;</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"></span>
<a id="rest_code_863301c97c9c479fb9d5ae8512030165-2" name="rest_code_863301c97c9c479fb9d5ae8512030165-2" href="posts/baremetal-part-two.html#rest_code_863301c97c9c479fb9d5ae8512030165-2"></a>
<a id="rest_code_863301c97c9c479fb9d5ae8512030165-3" name="rest_code_863301c97c9c479fb9d5ae8512030165-3" href="posts/baremetal-part-two.html#rest_code_863301c97c9c479fb9d5ae8512030165-3"></a><span class="c1">// msr cptr_el3, xzr</span>
<a id="rest_code_863301c97c9c479fb9d5ae8512030165-4" name="rest_code_863301c97c9c479fb9d5ae8512030165-4" href="posts/baremetal-part-two.html#rest_code_863301c97c9c479fb9d5ae8512030165-4"></a><span class="c1">// msr cptr_el2, xzr</span>
<a id="rest_code_863301c97c9c479fb9d5ae8512030165-5" name="rest_code_863301c97c9c479fb9d5ae8512030165-5" href="posts/baremetal-part-two.html#rest_code_863301c97c9c479fb9d5ae8512030165-5"></a><span class="nf">msr</span><span class="w"> </span><span class="no">cpacr_el1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w"></span>
</pre></div>
<p>We don't have EL3 and EL2 support in our CPU, it only
goes up to EL1, but I'm including the higher EL code
anyway for your convenience for when you play with
real hardware.</p>
<p>In QEMU, you can now type <code class="docutils literal">info registers</code> to see
a whole new table of vector regs has just appeared
and is initialised to zero.</p>
<p>One other interesting feature that the Aarch64 platform
provides in Cortex-A CPUs, mostly the newer ones, is the
ability to generate random numbers in the hardware.</p>
<p>To see whether you have RNG capability or not you're
supposed to read from the <code class="docutils literal">ID_AA64ISAR0_EL1</code> register.
If <code class="docutils literal">mrs x10, ID_AA64ISAR0_EL1; and x10, x10, 0x1000000000000000</code>
returns true, your CPU has the registers <code class="docutils literal">RNDR</code> and <code class="docutils literal">RNDRRS</code>
implemented. The CPU will then provide you with a
random number when you do <code class="docutils literal">mrs x10, RNDR</code>—or at least, it
theoretically should!</p>
<p>But <img alt="BroFrustration" src="emoji/brofrustration.png" style="width: 32px;"> the GNU <code class="docutils literal">binutils</code> don't even fucking work,
they don't recognise some register names and error out for
<em>no fucking reason</em>, so you have to actually poll that register
using its internal encoding name, which in this case is going to be
<code class="docutils literal">mrs x10, s3_3_c2_c4_0</code>. This should provide you with a
random number in <code class="docutils literal">x10</code>, which QEMU in turn sources from the OS.</p>
<hr class="docutils">
<aside class="footnote-list brackets"><aside class="footnote brackets" id="footnote-1" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/baremetal-part-two.html#footnote-reference-1">1</a><span class="fn-bracket">]</span></span>
<p>To load them you need to use up at least one more register
and will need three more instructions; you're looking at something
at least like <code class="docutils literal">adrp x2, UART_CNTL; add x2, x2, :lo12:UART_CNTL;
ldrb x2, [x2]; add x0, x0, x2</code> while you could just do
<code class="docutils literal">add x0, x0, 0x30</code> instead.</p>
</aside><aside class="footnote brackets" id="footnote-2" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/baremetal-part-two.html#footnote-reference-2">2</a><span class="fn-bracket">]</span></span>
<p>You can check your exception level by doing <code class="docutils literal">msr x1, CurrentEL</code>
to get the value and <code class="docutils literal">lsr x1, x1, 2</code> to extract it since it's not
in the lowest two bits. There's a whole bunch of these unmapped
internal registers on Cortex-A CPUs, and you can read more about
them here: <a class="reference external" href="https://developer.arm.com/documentation/ddi0595/2021-12/AArch64-Registers">https://developer.arm.com/documentation/ddi0595/2021-12/AArch64-Registers</a></p>
</aside><aside class="footnote brackets" id="footnote-3" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/baremetal-part-two.html#footnote-reference-3">3</a><span class="fn-bracket">]</span></span>
<p>There's a
further trick with the vector instructions, which is to use
the <code class="docutils literal">st1</code> and <code class="docutils literal">ld1</code> instructions, to load up to four vector
registers (512 bits!) from memory at once (<code class="docutils literal">ld1 {v0.2d, v1.2d, v2.2d, v3.2d}, [sp, <span class="pre">#-64]!</span></code>),
or even the SVE/SVE2 junk with <code class="docutils literal">addvl sp, sp, <span class="pre">#-4;</span> str z1, [sp, #4, MUL VL]</code> which
can net you 1024 bits of storage at once,
but that's quite overkill for us right now. According to the manual
the <code class="docutils literal">ld1</code> of four NEON regs takes 8 cycles, and the <code class="docutils literal">ldp</code> of two NEON regs takes
6 cycles, which means you can save 4 cycles if you use the other kind of store. This kind of
microoptimisation is not necessary when working in QEMU, but remember that usually
the less code you write, the better your code will be.</p>
</aside></aside></section>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/baremetal-part-one.html" class="u-url">Baremetal Aarch64: Pt 1, Hello World</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                enn
            </span></p>
            <p class="dateline">
            <a href="posts/baremetal-part-one.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-07-11T02:42:21+02:00" itemprop="datePublished" title="2022-07-11 02:42">2022-07-11 02:42</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>If you want to start doing <em>anything</em> at all in baremetal Aarch64
land, you need a chart and a lot of supplies, because the road is
wild and unkempt. I'll be assuming you know what the 'path' is
and how to install software (duh), but also I'll assume you can
learn the Aarch64 ISA and GNU assembler instructions and whatever
on your own; don't disappoint me. You'll probably have to adapt
these guidelines to your system; I'm working on Windows 10 so
all the filenames will be local, but you'll have no issue with the
needed changes.</p>
<section id="the-tools"><h2>The Tools</h2>
<p>We'll be programming in Aarch64, the 64-bit instruction set for Arm
CPUs. Specifically, we'll be targetting some variety of Armv8-A
instruction set, the specifics of which we'll hone in on a bit down
the line. We'll be working on <em>totally</em> fake 'hardware', on an emulated
board, since this is just about the most convenient thing we can do: no
flashing, no actual electronics work, no cost, nothing but programming.
We'll be doing this inside QEMU's emulation suite, since it does a
<em>pretty</em> good job of emulating most of the things we'll ever need. It
will provide us with peripherals we'll want to use, such as a serial
device we'll get data from on the console.</p>
<p><a class="reference external" href="https://www.qemu.org/download">QEMU</a> is easy to install, it comes with a convenient installer for
whatever platform you're on. Make absolutely sure you installed the
Aarch64 <a class="footnote-reference brackets" href="posts/baremetal-part-one.html#footnote-1" id="footnote-reference-1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> emulator; once you've added it to your path, it should give
you something like <code class="docutils literal"><span class="pre">qemu-system-aarch64.exe</span></code> and its <code class="docutils literal"><span class="pre">-aarch64w.exe</span></code>
equivalent. For now, we want the first one; the difference between
these two is that the second one doesn't open a console window, and
we want one (for now?). You can get it <a class="reference external" href="https://www.qemu.org/download">straight from the website</a>
there; I'm using QEMU 7 <a class="footnote-reference brackets" href="posts/baremetal-part-one.html#footnote-2" id="footnote-reference-2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> and I suggest you use that too since
things like memory offsets might change between versions and you'll
be stuck pulling your hair out.</p>
<p>The files you'll want from QEMU include this tiny pair:</p>
<ul class="simple">
<li><p><code class="docutils literal"><span class="pre">qemu-system-aarch64.exe</span></code></p></li>
<li><p><code class="docutils literal"><span class="pre">qemu-img.exe</span></code></p></li>
</ul>
<p>We'll also be using a cross compiler. You'll be all on your own setting
this one up. The <em>target triplet</em> <a class="footnote-reference brackets" href="posts/baremetal-part-one.html#footnote-3" id="footnote-reference-3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a> for our machine will be the fairly
specific <code class="docutils literal"><span class="pre">aarch64-none-elf</span></code>. <a class="footnote-reference brackets" href="posts/baremetal-part-one.html#footnote-4" id="footnote-reference-4" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a> You want your compiler to be able
to emit object code for <code class="docutils literal">aarch64</code> targets, to have no specific vendor
and no OS it produces this object code for (hence the <code class="docutils literal">none</code>), and you
want it to produce ELF executables because ELF is really cool and awesome.</p>
<p>The GCC tools you'll want are:</p>
<ul class="simple">
<li><p><code class="docutils literal"><span class="pre">aarch64-none-elf-ld.exe</span></code></p></li>
<li><p><code class="docutils literal"><span class="pre">aarch64-none-elf-as.exe</span></code></p></li>
<li><p><code class="docutils literal"><span class="pre">aarch64-none-elf-objcopy.exe</span></code></p></li>
<li><p><code class="docutils literal"><span class="pre">aarch64-none-elf-gcc.exe</span></code></p></li>
</ul>
<p>You probably also want <code class="docutils literal"><span class="pre">aarch64-none-elf-gdb.exe</span></code> but honestly I'm
not much of a <code class="docutils literal">gdb</code> fan and so far in the project I haven't really
felt a need for it.</p>
<p>You'll also want the following things:</p>
<ul class="simple">
<li><p><code class="docutils literal">dtc.exe</code> (Device tree compiler)</p></li>
<li><p><code class="docutils literal">make.exe</code></p></li>
<li><p>anything capable of running simple scripts (Batch, Powershell, Bash, ...)</p></li>
</ul></section><section id="qemu-and-platform"><h2>QEMU and Platform</h2>
<p>QEMU is pretty good at what it does. What it isn't good at is documentation
of pretty much anything inside it. Some parts are amazingly well documented,
others just blatantly suck. You'll have to learn to cope with that.</p>
<p>We'll be developing for the fakest of the emulated boards; our emu target
is going to be the <code class="docutils literal">virt</code>, which is a platform 'which does not correspond
to any real hardware; it is designed for use in virtual machines.
It is the recommended board type if you simply want to run a guest
such as Linux and do not care about reproducing the idiosyncrasies
and limitations of a particular bit of real-world hardware', <a class="footnote-reference brackets" href="posts/baremetal-part-one.html#footnote-5" id="footnote-reference-5" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a>
which means it's ideal for us.</p>
<p>QEMU emulates just under 50 Arm-based boards which have a more or
less fixed design and component layout, but the <code class="docutils literal">virt</code> lets
you pick and choose components. I appreciate that a lot, since I'm
more or less window shopping for the component that implements
what I need in the least obnoxious way (it's much easier to just
put a framebuffer down into RAM than handle a VGA interface, for
example).</p>
<p>Eventually, we'll fire our system up using the following incantation:
<code class="docutils literal"><span class="pre">qemu-system-aarch64.exe</span> <span class="pre">-M</span> virt <span class="pre">-cpu</span> <span class="pre">cortex-a57</span> <span class="pre">-m</span> 256 <span class="pre">-kernel</span> kernel.elf <span class="pre">-serial</span> mon:stdio <span class="pre">-drive</span> id=first,file=disk.img,format=raw,if=none <span class="pre">-device</span> <span class="pre">virtio-blk-device,drive=first</span> <span class="pre">-device</span> ramfb</code>,
but we'll get to all of this slowly.</p>
<p>There is a <em>lot</em> to QEMU, so if you want to quickly get
overwhelmed by it, go ahead and type in <code class="docutils literal"><span class="pre">qemu-system-aarch64.exe</span> <span class="pre">--help</span></code>
for a massive wall of pain. I have no idea what half of these even
are, but it's good to go through them and read whatever it gives you.</p>
<p>The option <code class="docutils literal"><span class="pre">-M</span></code> specifies which machine/board we want QEMU to emulate
for us, and so we'll tell it <code class="docutils literal"><span class="pre">-M</span> virt</code> to give us our desired
target. The default CPU of this board is actually going to be the
Arm Cortex-A15, which is a 32-bit CPU running on Armv7, and not
what we want; so we have to change the default CPU by passing the
option <code class="docutils literal"><span class="pre">-cpu</span> <span class="pre">cortex-a57</span></code> which <em>is</em> a 64-bit CPU. <a class="footnote-reference brackets" href="posts/baremetal-part-one.html#footnote-6" id="footnote-reference-6" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a></p>
<p>We top off our incantation by telling the emulator to give us
256 megabytes of memory (<code class="docutils literal"><span class="pre">-m</span> 256</code>), that we want
to boot from a specific kernel we provide (<code class="docutils literal"><span class="pre">-kernel</span> kernel.elf</code>),
that we <em>don't</em> want graphical output at all (<code class="docutils literal"><span class="pre">-nographic</span></code>)
and that we want it to redirect the virtual serial port
to standard output (<code class="docutils literal"><span class="pre">-serial</span> stdio</code>). The final thing
won't look almost anything alike what I gave you up there,
but we're working towards it.</p>
<p>To sum up, our first incantation will be:
<code class="docutils literal"><span class="pre">qemu-system-aarch64.exe</span> <span class="pre">-M</span> virt <span class="pre">-cpu</span> <span class="pre">cortex-a57</span> <span class="pre">-m</span> 256 <span class="pre">-kernel</span> kernel.elf <span class="pre">-nographic</span> <span class="pre">-serial</span> stdio</code></p>
<p>Congrats, you got your first QEMU error! We have no kernel to boot.</p>
</section><section id="minimum"><h2>Minimum</h2>
<p>First, we want to make sure that our toolchain is in order and that
we're assembling our code right. To do this, we'll need to know
<em>how</em> to even assemble and link our code. Tough situation. Before we
even assemble our first program, the linker needs to know where in
memory to put our code, and we need to write a makefile to automate
this process. Since the <code class="docutils literal">virt</code> board with our chosen CPU supports
a MMU and emulates a bunch of memory foolishnesses, we'll actually
be putting our kernel in RAM, and so we need to know just where this
RAM exactly is.</p>
<p>We'll do this adding the following to our previous invocation:
<code class="docutils literal"><span class="pre">-machine</span> dumpdtb=out.dtb</code>. This will dump a device tree blob
to disk, and we'll have to convert it to a readable format using
<code class="docutils literal">dtc</code> that I mentioned earlier, by invoking it as
<code class="docutils literal">dtc.exe <span class="pre">-I</span> dtb <span class="pre">-O</span> dts <span class="pre">-o</span> out.txt out.dtb</code>. My own blob generates
the following device tree:</p>
<div class="code"><pre class="code text"><a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-1" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-1" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-1"></a>/dts-v1/;
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-2" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-2" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-2"></a>
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-3" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-3" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-3"></a>/ {
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-4" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-4" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-4"></a>        interrupt-parent = &lt;0x8002&gt;;
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-5" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-5" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-5"></a>        #size-cells = &lt;0x02&gt;;
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-6" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-6" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-6"></a>        #address-cells = &lt;0x02&gt;;
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-7" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-7" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-7"></a>        compatible = "linux,dummy-virt";
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-8" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-8" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-8"></a>
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-9" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-9" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-9"></a>        psci {
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-10" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-10" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-10"></a>                migrate = &lt;0xc4000005&gt;;
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-11" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-11" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-11"></a>                cpu_on = &lt;0xc4000003&gt;;
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-12" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-12" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-12"></a>                cpu_off = &lt;0x84000002&gt;;
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-13" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-13" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-13"></a>                cpu_suspend = &lt;0xc4000001&gt;;
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-14" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-14" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-14"></a>                method = "hvc";
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-15" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-15" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-15"></a>                compatible = "arm,psci-1.0\0arm,psci-0.2\0arm,psci";
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-16" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-16" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-16"></a>        };
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-17" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-17" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-17"></a>
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-18" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-18" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-18"></a>        memory@40000000 {
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-19" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-19" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-19"></a>                reg = &lt;0x00 0x40000000 0x00 0x10000000&gt;;
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-20" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-20" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-20"></a>                device_type = "memory";
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-21" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-21" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-21"></a>        };
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-22" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-22" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-22"></a>        .
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-23" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-23" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-23"></a>        .
<a id="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-24" name="rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-24" href="posts/baremetal-part-one.html#rest_code_c18206a6fcce4f4da0ac84cf5818f2dd-24"></a>        .
</pre></div>
<p>Of course, I trimmed it since the output is ~9kb long, but we have what
we need right now right at the start of the tree. We see that
our device's memory starts at the 1GB mark (<code class="docutils literal">0x40000000</code>), which
means this is where we'll put our kernel.</p>
<p>We are going to need a loader script, and I'm using this stub for
the time being:</p>
<div class="code"><pre class="code text"><a id="rest_code_7990e2d29101471fa238511190b93757-1" name="rest_code_7990e2d29101471fa238511190b93757-1" href="posts/baremetal-part-one.html#rest_code_7990e2d29101471fa238511190b93757-1"></a>ENTRY(_reset)
<a id="rest_code_7990e2d29101471fa238511190b93757-2" name="rest_code_7990e2d29101471fa238511190b93757-2" href="posts/baremetal-part-one.html#rest_code_7990e2d29101471fa238511190b93757-2"></a>SECTIONS
<a id="rest_code_7990e2d29101471fa238511190b93757-3" name="rest_code_7990e2d29101471fa238511190b93757-3" href="posts/baremetal-part-one.html#rest_code_7990e2d29101471fa238511190b93757-3"></a>{
<a id="rest_code_7990e2d29101471fa238511190b93757-4" name="rest_code_7990e2d29101471fa238511190b93757-4" href="posts/baremetal-part-one.html#rest_code_7990e2d29101471fa238511190b93757-4"></a>        . = 0x40000000;
<a id="rest_code_7990e2d29101471fa238511190b93757-5" name="rest_code_7990e2d29101471fa238511190b93757-5" href="posts/baremetal-part-one.html#rest_code_7990e2d29101471fa238511190b93757-5"></a>        .startup . : { kernel.o(.text.startup) }
<a id="rest_code_7990e2d29101471fa238511190b93757-6" name="rest_code_7990e2d29101471fa238511190b93757-6" href="posts/baremetal-part-one.html#rest_code_7990e2d29101471fa238511190b93757-6"></a>        .text : { *(.text) }
<a id="rest_code_7990e2d29101471fa238511190b93757-7" name="rest_code_7990e2d29101471fa238511190b93757-7" href="posts/baremetal-part-one.html#rest_code_7990e2d29101471fa238511190b93757-7"></a>        .data : { *(.data) }
<a id="rest_code_7990e2d29101471fa238511190b93757-8" name="rest_code_7990e2d29101471fa238511190b93757-8" href="posts/baremetal-part-one.html#rest_code_7990e2d29101471fa238511190b93757-8"></a>        .bss : { *(.bss COMMON) }
<a id="rest_code_7990e2d29101471fa238511190b93757-9" name="rest_code_7990e2d29101471fa238511190b93757-9" href="posts/baremetal-part-one.html#rest_code_7990e2d29101471fa238511190b93757-9"></a>        . = ALIGN(16);
<a id="rest_code_7990e2d29101471fa238511190b93757-10" name="rest_code_7990e2d29101471fa238511190b93757-10" href="posts/baremetal-part-one.html#rest_code_7990e2d29101471fa238511190b93757-10"></a>        . = . + 0x100000; /* 1MB of stack atop of BSS */
<a id="rest_code_7990e2d29101471fa238511190b93757-11" name="rest_code_7990e2d29101471fa238511190b93757-11" href="posts/baremetal-part-one.html#rest_code_7990e2d29101471fa238511190b93757-11"></a>        stack_top = .;
<a id="rest_code_7990e2d29101471fa238511190b93757-12" name="rest_code_7990e2d29101471fa238511190b93757-12" href="posts/baremetal-part-one.html#rest_code_7990e2d29101471fa238511190b93757-12"></a>}
</pre></div>
<p>Did I mention you'll have to wrangle with writing your own
linker scripts? You'll have to wrangle with writing yur own
linker scripts. The above script will suffice for now, though
we might want to expand it later. I've also taken the liberty
of naming our entry point <code class="docutils literal">_reset</code>; I particularly like
using underscores for label names and allcaps for constants,
but your mileage may vary. Save it as <code class="docutils literal">kernel.ld</code> for now.</p>
<p>For our makefile, we have the most rudimentary thing known to
man for now:</p>
<div class="code"><pre class="code make"><a id="rest_code_b5111f8b578c4959a1c90f5bb901a660-1" name="rest_code_b5111f8b578c4959a1c90f5bb901a660-1" href="posts/baremetal-part-one.html#rest_code_b5111f8b578c4959a1c90f5bb901a660-1"></a><span class="nv">CROSS</span><span class="o">=</span>aarch64-none-elf-
<a id="rest_code_b5111f8b578c4959a1c90f5bb901a660-2" name="rest_code_b5111f8b578c4959a1c90f5bb901a660-2" href="posts/baremetal-part-one.html#rest_code_b5111f8b578c4959a1c90f5bb901a660-2"></a>
<a id="rest_code_b5111f8b578c4959a1c90f5bb901a660-3" name="rest_code_b5111f8b578c4959a1c90f5bb901a660-3" href="posts/baremetal-part-one.html#rest_code_b5111f8b578c4959a1c90f5bb901a660-3"></a><span class="nf">all</span><span class="o">:</span> <span class="n">kernel</span>.<span class="n">elf</span>
<a id="rest_code_b5111f8b578c4959a1c90f5bb901a660-4" name="rest_code_b5111f8b578c4959a1c90f5bb901a660-4" href="posts/baremetal-part-one.html#rest_code_b5111f8b578c4959a1c90f5bb901a660-4"></a>
<a id="rest_code_b5111f8b578c4959a1c90f5bb901a660-5" name="rest_code_b5111f8b578c4959a1c90f5bb901a660-5" href="posts/baremetal-part-one.html#rest_code_b5111f8b578c4959a1c90f5bb901a660-5"></a><span class="nf">kernel.o</span><span class="o">:</span> <span class="n">kernel</span>.<span class="n">s</span>
<a id="rest_code_b5111f8b578c4959a1c90f5bb901a660-6" name="rest_code_b5111f8b578c4959a1c90f5bb901a660-6" href="posts/baremetal-part-one.html#rest_code_b5111f8b578c4959a1c90f5bb901a660-6"></a>        <span class="k">$(</span>CROSS<span class="k">)</span>as.exe -g -c $&lt; -o <span class="nv">$@</span>
<a id="rest_code_b5111f8b578c4959a1c90f5bb901a660-7" name="rest_code_b5111f8b578c4959a1c90f5bb901a660-7" href="posts/baremetal-part-one.html#rest_code_b5111f8b578c4959a1c90f5bb901a660-7"></a>
<a id="rest_code_b5111f8b578c4959a1c90f5bb901a660-8" name="rest_code_b5111f8b578c4959a1c90f5bb901a660-8" href="posts/baremetal-part-one.html#rest_code_b5111f8b578c4959a1c90f5bb901a660-8"></a><span class="nf">kernel.elf</span><span class="o">:</span> <span class="n">kernel</span>.<span class="n">o</span>
<a id="rest_code_b5111f8b578c4959a1c90f5bb901a660-9" name="rest_code_b5111f8b578c4959a1c90f5bb901a660-9" href="posts/baremetal-part-one.html#rest_code_b5111f8b578c4959a1c90f5bb901a660-9"></a>        <span class="k">$(</span>CROSS<span class="k">)</span>ld.exe -Tkernel.ld $^ -o <span class="nv">$@</span>
</pre></div>
<p>This will produce an object file out of the assembly source,
and then use the linker script to produce an ELF executable
with the proper section offsets.</p>
<p>All we have left is to write our first assembly file and
we're good to go. The most barebones stub we'll be using
for now is:</p>
<div class="code"><pre class="code asm"><a id="rest_code_2f218113ad8944e08c201f81bcc465d9-1" name="rest_code_2f218113ad8944e08c201f81bcc465d9-1" href="posts/baremetal-part-one.html#rest_code_2f218113ad8944e08c201f81bcc465d9-1"></a><span class="na">.section</span><span class="w"> </span><span class="no">.text.startup</span><span class="w"></span>
<a id="rest_code_2f218113ad8944e08c201f81bcc465d9-2" name="rest_code_2f218113ad8944e08c201f81bcc465d9-2" href="posts/baremetal-part-one.html#rest_code_2f218113ad8944e08c201f81bcc465d9-2"></a><span class="na">.global</span><span class="w"> </span><span class="no">_Reset</span><span class="w"></span>
<a id="rest_code_2f218113ad8944e08c201f81bcc465d9-3" name="rest_code_2f218113ad8944e08c201f81bcc465d9-3" href="posts/baremetal-part-one.html#rest_code_2f218113ad8944e08c201f81bcc465d9-3"></a><span class="nl">_Reset:</span><span class="w"></span>
<a id="rest_code_2f218113ad8944e08c201f81bcc465d9-4" name="rest_code_2f218113ad8944e08c201f81bcc465d9-4" href="posts/baremetal-part-one.html#rest_code_2f218113ad8944e08c201f81bcc465d9-4"></a><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x40</span><span class="w"></span>
<a id="rest_code_2f218113ad8944e08c201f81bcc465d9-5" name="rest_code_2f218113ad8944e08c201f81bcc465d9-5" href="posts/baremetal-part-one.html#rest_code_2f218113ad8944e08c201f81bcc465d9-5"></a><span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="p">.</span><span class="w"></span>
</pre></div>
<p>Save that as <code class="docutils literal">kernel.s</code> and finally run the makefile. This
should produce the file <code class="docutils literal">kernel.elf</code>, as we specified in the
makefile, and you almost certainly won't be able to run this
executable natively on your machine. That's alright. Run it
through QEMU (remember the error you got last time?) and it should
freeze instead of error out! This is actually <em>good</em>, because
it means the code we wrote is actually doing what we wrote (we
told the CPU to do an infinite loop).</p>
<p>If you want to <em>see</em> the CPU's current instructions, you can
pass a further commandline argument <code class="docutils literal"><span class="pre">-d</span> in_asm</code> and it'll
blit out the instructions to the console as they're being executed.
For our trashfire kernel up there, it generates the following:</p>
<div class="code"><pre class="code text"><a id="rest_code_ab8dead442c642529edd84609c62fcaa-1" name="rest_code_ab8dead442c642529edd84609c62fcaa-1" href="posts/baremetal-part-one.html#rest_code_ab8dead442c642529edd84609c62fcaa-1"></a>IN:
<a id="rest_code_ab8dead442c642529edd84609c62fcaa-2" name="rest_code_ab8dead442c642529edd84609c62fcaa-2" href="posts/baremetal-part-one.html#rest_code_ab8dead442c642529edd84609c62fcaa-2"></a>0x40000000:  d2800800  movz     x0, #0x40
<a id="rest_code_ab8dead442c642529edd84609c62fcaa-3" name="rest_code_ab8dead442c642529edd84609c62fcaa-3" href="posts/baremetal-part-one.html#rest_code_ab8dead442c642529edd84609c62fcaa-3"></a>0x40000004:  14000000  b        #0x40000004
<a id="rest_code_ab8dead442c642529edd84609c62fcaa-4" name="rest_code_ab8dead442c642529edd84609c62fcaa-4" href="posts/baremetal-part-one.html#rest_code_ab8dead442c642529edd84609c62fcaa-4"></a>
<a id="rest_code_ab8dead442c642529edd84609c62fcaa-5" name="rest_code_ab8dead442c642529edd84609c62fcaa-5" href="posts/baremetal-part-one.html#rest_code_ab8dead442c642529edd84609c62fcaa-5"></a>----------------
<a id="rest_code_ab8dead442c642529edd84609c62fcaa-6" name="rest_code_ab8dead442c642529edd84609c62fcaa-6" href="posts/baremetal-part-one.html#rest_code_ab8dead442c642529edd84609c62fcaa-6"></a>IN:
<a id="rest_code_ab8dead442c642529edd84609c62fcaa-7" name="rest_code_ab8dead442c642529edd84609c62fcaa-7" href="posts/baremetal-part-one.html#rest_code_ab8dead442c642529edd84609c62fcaa-7"></a>0x40000004:  14000000  b        #0x40000004
</pre></div>
<p>Which is exactly what we told it to do. If you noticed <code class="docutils literal">movz</code> there
instead of plain <code class="docutils literal">mov</code>, that's just because there's no such
<code class="docutils literal">mov</code> instruction in Aarch64 to begin with, it's just an
assembler mnemonic, and <code class="docutils literal">movz</code> is one of the instructions
that replaces it.</p>
<p>At this point, I'd make the following files:</p>
<dl class="simple">
<dt>run.bat</dt>
<dd>
<p><code class="docutils literal"><span class="pre">qemu-system-aarch64.exe</span> <span class="pre">-M</span> virt <span class="pre">-cpu</span> <span class="pre">cortex-a57</span> <span class="pre">-m</span> 256 <span class="pre">-kernel</span> kernel.elf <span class="pre">-nographic</span> <span class="pre">-serial</span> stdio</code></p>
</dd>
<dt>run-debug.bat</dt>
<dd>
<p><code class="docutils literal"><span class="pre">qemu-system-aarch64.exe</span> <span class="pre">-M</span> virt <span class="pre">-cpu</span> <span class="pre">cortex-a57</span> <span class="pre">-m</span> 256 <span class="pre">-kernel</span> kernel.elf <span class="pre">-nographic</span> <span class="pre">-serial</span> stdio <span class="pre">-d</span> in_asm</code></p>
</dd>
<dt>run-dtb.bat</dt>
<dd>
<p><code class="docutils literal"><span class="pre">qemu-system-aarch64.exe</span> <span class="pre">-M</span> virt <span class="pre">-cpu</span> <span class="pre">cortex-a57</span> <span class="pre">-m</span> 256 <span class="pre">-machine</span> dumpdtb=out.dtb</code></p>
</dd>
</dl>
<p>These three files will make up most of my commandline use (other
than, of course, calling <code class="docutils literal">make</code>), and I feel that's what you'll
also need yourself for evaluation, debugs and dumps.</p>
</section><section id="hello-world"><h2>Hello, World?</h2>
<p>If you've read the <a class="reference external" href="posts/accidental-kernel.html">previous</a> post, you'll have had it drilled into
your head that nothing comes for free in baremetal land. There is
no kernel and no bootloader: <em>you</em> are the kernel and bootloader
and the kitchen sink, too. There is no BIOS to handle your syscalls
like you'd get in x86 territory. You will not be able to do <em>anything</em>
until you write more drivers than you really thought was possible
in a week. Paradoxically, thus, to get anything like the legendary
<em>Hello, World!</em>, the simplest of programs, working on bare metal,
you'll have to first write a driver for whatever device gets us
serial output.</p>
<p>For the <code class="docutils literal">virt</code> board, your first output will be passed through
the UART device <a class="footnote-reference brackets" href="posts/baremetal-part-one.html#footnote-7" id="footnote-reference-7" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a> and since we redirected serial output
to the console, this means that anything the UART device passes
from the CPU will be passed to the console. This is the way
we'll handle the first print.</p>
<p>The UART is the simplest possible device that we can use for this
purpose. Literally all you have to do is perform a tiny setup
dance and it's ready to go blitting bytes to your console like it
means business. The specific model that the <code class="docutils literal">virt</code> board implements
is the PrimeCell UART module PL011, which is also one of the UARTs
that are present on the Raspi3b. It's a dead simple device that
offers both serial and queued input and output modes, but we
have to ensure it's serial and set up for both transmission
and reception. Like actually everything on the board, it's a
memory mapped device, which means the MMU has conveniently remapped
the UART's internal registers to pretend-RAM locations.</p>
<p>To find out where the device got mapped to in memory, we need
to go revisit the device tree and scroll quite a bit down. Remember
we're looking for the 'PL011', and in my device tree the memory map
is like so:</p>
<div class="code"><pre class="code text"><a id="rest_code_eb897dcfa10b40d18a2f3349300b219f-1" name="rest_code_eb897dcfa10b40d18a2f3349300b219f-1" href="posts/baremetal-part-one.html#rest_code_eb897dcfa10b40d18a2f3349300b219f-1"></a>pl011@9000000 {
<a id="rest_code_eb897dcfa10b40d18a2f3349300b219f-2" name="rest_code_eb897dcfa10b40d18a2f3349300b219f-2" href="posts/baremetal-part-one.html#rest_code_eb897dcfa10b40d18a2f3349300b219f-2"></a>        clock-names = "uartclk\0apb_pclk";
<a id="rest_code_eb897dcfa10b40d18a2f3349300b219f-3" name="rest_code_eb897dcfa10b40d18a2f3349300b219f-3" href="posts/baremetal-part-one.html#rest_code_eb897dcfa10b40d18a2f3349300b219f-3"></a>        clocks = &lt;0x8000 0x8000&gt;;
<a id="rest_code_eb897dcfa10b40d18a2f3349300b219f-4" name="rest_code_eb897dcfa10b40d18a2f3349300b219f-4" href="posts/baremetal-part-one.html#rest_code_eb897dcfa10b40d18a2f3349300b219f-4"></a>        interrupts = &lt;0x00 0x01 0x04&gt;;
<a id="rest_code_eb897dcfa10b40d18a2f3349300b219f-5" name="rest_code_eb897dcfa10b40d18a2f3349300b219f-5" href="posts/baremetal-part-one.html#rest_code_eb897dcfa10b40d18a2f3349300b219f-5"></a>        reg = &lt;0x00 0x9000000 0x00 0x1000&gt;;
<a id="rest_code_eb897dcfa10b40d18a2f3349300b219f-6" name="rest_code_eb897dcfa10b40d18a2f3349300b219f-6" href="posts/baremetal-part-one.html#rest_code_eb897dcfa10b40d18a2f3349300b219f-6"></a>        compatible = "arm,pl011\0arm,primecell";
<a id="rest_code_eb897dcfa10b40d18a2f3349300b219f-7" name="rest_code_eb897dcfa10b40d18a2f3349300b219f-7" href="posts/baremetal-part-one.html#rest_code_eb897dcfa10b40d18a2f3349300b219f-7"></a>};
</pre></div>
<p>The device tree is telling us that our UART device, called PL011,
starts at memory location <code class="docutils literal">0x09000000</code> and is 4kb (<code class="docutils literal">0x1000</code>) long. Reads from
and writes to this area get remapped to the device. To figure
out how it works, we need to hit the <a class="reference external" href="https://developer.arm.com/documentation/ddi0183/f/preface?lang=en">specs</a> and slough through a <em>lot</em>
of boring shit.</p>
<p>I'll sum the important bits up for you:</p>
<ol class="arabic simple">
<li><p>PL011 UART has a controllable FIFO buffer (that we want to disable)</p></li>
<li><p>it can generate maskable and aggregate interrupts</p></li>
<li><p>there are signal and error bits in its status/flag registers (e.g. busy bit)</p></li>
<li><p>you must disable the UART when reprogramming control registers <a class="footnote-reference brackets" href="posts/baremetal-part-one.html#footnote-8" id="footnote-reference-8" role="doc-noteref"><span class="fn-bracket">[</span>8<span class="fn-bracket">]</span></a></p></li>
<li><p>some memory areas are reserved, some are turbo reserved</p></li>
<li><p>the forbidden areas are at <code class="docutils literal">0x008</code>—<code class="docutils literal">0x014</code>, and at <code class="docutils literal">0x1c</code>; writing to them bricks the device</p></li>
<li><p>the UART <em>should</em> be enabled manually, because you can't guarantee it's enabled on reset</p></li>
<li><p>control registers should also be set manually because their values can be unpredictable</p></li>
</ol>
<p>We don't actually care about most of the functionality of
this device and some of it is actively detrimental to our
needs, so we have to deactivate them just in case.</p>
<p>The relevant registers of the PL011 UART:</p>
<div class="bs-example">
  <table style="width:50%" class="table table-striped table-bordered table-hover">
<thead><tr>
<th>Register</th>
        <th>Offset</th>
      </tr></thead>
<tbody>
<tr>
<td><b>Data</b></td>
        <td>+0x0</td>
      </tr>
<tr>
<td><b>Flags</b></td>
        <td>+0x18</td>
      </tr>
<tr>
<td><b>Control</b></td>
        <td>+0x30</td>
      </tr>
<tr>
<td><b>FIFO Interrupts</b></td>
        <td>+0x34</td>
      </tr>
<tr>
<td><b>Interrupt clear</b></td>
        <td>+0x44</td>
      </tr>
</tbody>
</table>
<p>With this in mind, we start by clearing the control register,
then setting the transmit mode, enabling the UART,
clearing all interrupts and disabling FIFO interrupts. Even though
the PL011 schematics say that, on reset, the value in the control
register is <code class="docutils literal">0x0300</code> (p47 of the schematic PDF), we do this
for extra safety reasons. Never hurts to be safe. The code we'll
be running:</p>
<div class="code"><pre class="code asm"><a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-1" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-1" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-1"></a><span class="na">.section</span><span class="w"> </span><span class="no">.text.startup</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-2" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-2" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-2"></a><span class="na">.global</span><span class="w"> </span><span class="no">_Reset</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-3" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-3" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-3"></a><span class="nl">_Reset:</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-4" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-4" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-4"></a><span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="mi">1</span><span class="no">f</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-5" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-5" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-5"></a><span class="w">    </span><span class="na">.skip</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-6" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-6" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-6"></a>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-7" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-7" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-7"></a><span class="c1">//      UART_BASE: .word 0x09000000</span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-8" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-8" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-8"></a><span class="c1">//      UART_DATA: .byte 0x00</span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-9" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-9" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-9"></a><span class="c1">//      UART_FLAG: .byte 0x18</span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-10" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-10" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-10"></a><span class="c1">//      UART_CNTL: .byte 0x30</span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-11" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-11" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-11"></a><span class="c1">//      UART_FIFO: .byte 0x34</span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-12" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-12" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-12"></a><span class="c1">//      UART_INTC: .byte 0x44</span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-13" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-13" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-13"></a>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-14" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-14" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-14"></a><span class="na">.section</span><span class="w"> </span><span class="no">.text</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-15" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-15" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-15"></a><span class="err">1:</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-16" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-16" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-16"></a><span class="w">        </span><span class="nf">ldr</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="err">=</span><span class="mi">0x09000030</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-17" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-17" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-17"></a><span class="w">        </span><span class="c1">// we're not actually loading these from memory</span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-18" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-18" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-18"></a><span class="w">        </span><span class="c1">// though we probably should; for now we just want output</span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-19" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-19" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-19"></a>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-20" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-20" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-20"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-21" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-21" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-21"></a><span class="w">        </span><span class="nf">str</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w">            </span><span class="c1">// set bit 0 = enable</span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-22" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-22" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-22"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x101</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-23" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-23" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-23"></a><span class="w">        </span><span class="nf">str</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-24" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-24" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-24"></a>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-25" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-25" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-25"></a><span class="w">        </span><span class="nf">add</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x4</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-26" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-26" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-26"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x03ff</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-27" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-27" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-27"></a><span class="w">        </span><span class="nf">str</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w">            </span><span class="c1">// disable FIFO interrupts</span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-28" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-28" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-28"></a>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-29" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-29" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-29"></a><span class="w">        </span><span class="nf">add</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x10</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-30" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-30" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-30"></a><span class="w">        </span><span class="nf">str</span><span class="w"> </span><span class="no">xzr</span><span class="p">,[</span><span class="no">x0</span><span class="p">]</span><span class="w">            </span><span class="c1">// clear all interrupts</span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-31" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-31" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-31"></a>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-32" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-32" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-32"></a><span class="w">        </span><span class="nf">sub</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x14</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-33" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-33" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-33"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x301</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-34" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-34" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-34"></a><span class="w">        </span><span class="nf">str</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w">            </span><span class="c1">// and finally enable the receive flag</span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-35" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-35" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-35"></a>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-36" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-36" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-36"></a><span class="w">        </span><span class="c1">// now the UART should be barebones functional</span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-37" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-37" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-37"></a><span class="w">        </span><span class="c1">// we can test it by blasting its memory location w bytes</span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-38" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-38" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-38"></a>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-39" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-39" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-39"></a><span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x48</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-40" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-40" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-40"></a>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-41" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-41" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-41"></a><span class="w">        </span><span class="nf">sub</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x44</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-42" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-42" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-42"></a><span class="w">        </span><span class="err">2:</span><span class="w"></span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-43" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-43" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-43"></a><span class="w">        </span><span class="nf">str</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w">            </span><span class="c1">// and we see if it works!</span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-44" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-44" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-44"></a><span class="w">        </span><span class="c1">// you should be seeing a wall of H on your console right about now</span>
<a id="rest_code_25b8cd08ad974c8cb289d8b0886ab678-45" name="rest_code_25b8cd08ad974c8cb289d8b0886ab678-45" href="posts/baremetal-part-one.html#rest_code_25b8cd08ad974c8cb289d8b0886ab678-45"></a><span class="w">        </span><span class="nf">b</span><span class="w"> </span><span class="mi">2</span><span class="no">b</span><span class="w"></span>
</pre></div>
<p>And a whole lot of bullshit later, you've got <em>single character</em> output
to the console, repeatedly! It's probably still quite buggy, you might
need to hit a key to get output to display or whatever if it jams, but we'll
handle that later when we start writing actual printing procedures down the line.</p>

<section id="what-s-next"><h2>What's next?</h2>
<p>With the UART enabled, the next part should be writing actual print
routines, figuring out how we're gonna call procedures, and getting
<em>input</em> into our machine (interactivity woo).</p>
<hr class="docutils">
<aside class="footnote-list brackets"><aside class="footnote brackets" id="footnote-1" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/baremetal-part-one.html#footnote-reference-1">1</a><span class="fn-bracket">]</span></span>
<p>You don't need to install the 32-bit Arm
emulators, since the Aarch64 emu also covers the 32-bit instruction
set, and the Thumb set, if you ever feel like using that. We won't
be using it, though it's a totally interesting target on its own;
did you know that the 32-bit Arm ISA includes conditional instructions
so that you don't even have to do any jumps in your code at all?
You can just write <code class="docutils literal">addle</code> and your <code class="docutils literal">add</code> will execute only
if the condition flag is set for less-than-or-equal. How neat! This
didn't transfer over into Aarch64, sadly, because they doubled
the amount of registers and did all sorts of other bonus wacky shit,
but the instructions remained 32 bits wide.</p>
</aside><aside class="footnote brackets" id="footnote-2" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/baremetal-part-one.html#footnote-reference-2">2</a><span class="fn-bracket">]</span></span>
<p>Specifically, the exact Win build I'm using is
<code class="docutils literal">QEMU emulator version 7.0.0 <span class="pre">(v7.0.0-11902-g1d935f4a02-dirty)</span></code> if
that matters to you. You can check your version by running the
executable with the commandline option <code class="docutils literal"><span class="pre">--version</span></code> fwiw.</p>
</aside><aside class="footnote brackets" id="footnote-3" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/baremetal-part-one.html#footnote-reference-3">3</a><span class="fn-bracket">]</span></span>
<p>Obligatory reading: <a class="reference external" href="https://wiki.osdev.org/Target_Triplet">https://wiki.osdev.org/Target_Triplet</a></p>
</aside><aside class="footnote brackets" id="footnote-4" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/baremetal-part-one.html#footnote-reference-4">4</a><span class="fn-bracket">]</span></span>
<p>I'm using <code class="docutils literal">GCC 11.2</code> for this, specifically
the <code class="docutils literal"><span class="pre">gcc-arm-11.2-2022.02-mingw-w64-i686-aarch64-none-elf</span></code>
toolchain. Any reasonably modern GCC should work, I think.</p>
</aside><aside class="footnote brackets" id="footnote-5" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/baremetal-part-one.html#footnote-reference-5">5</a><span class="fn-bracket">]</span></span>
<p>From <a class="reference external" href="https://qemu-project.gitlab.io/qemu/system/arm/virt.html">https://qemu-project.gitlab.io/qemu/system/arm/virt.html</a></p>
</aside><aside class="footnote brackets" id="footnote-6" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/baremetal-part-one.html#footnote-reference-6">6</a><span class="fn-bracket">]</span></span>
<p>If you want to read more about the CPUs that the <code class="docutils literal">virt</code> board
supports, as well as all the intricacies of the board itself, go
visit <a class="reference external" href="https://www.qemu.org/docs/master/system/arm/virt.html">https://www.qemu.org/docs/master/system/arm/virt.html</a>; but note
that either the docs or the QEMU application itself are lying somewhere
along the line. If you pass the options  <code class="docutils literal"><span class="pre">-M</span> virt <span class="pre">-cpu</span> help</code> to the
QEMU application, you'll find that the app is reporting support for
processors like the old Arm Cortex-A7, the tiny Arm Cortex-M0 and
Cortex-R5, and actually decades old <code class="docutils literal">sa1110</code> aka Intel's late-90ies
<em>StrongARM</em> microprocessors implementing the motherfucking Armv4 ISA,
as in the thing powering the fucking <em>Game Boy Advance</em>. I don't know
whether these are <em>actually</em> supported, if the docs are outdated,
or whatever other explanation there is. For 'safety' purposes I'd
much rather stick to things like the Cortex-A53, which I've been using
to run all this code.</p>
</aside><aside class="footnote brackets" id="footnote-7" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/baremetal-part-one.html#footnote-reference-7">7</a><span class="fn-bracket">]</span></span>
<p>Meaning the 'Universal asynchronous receiver-transmitter' device</p>
</aside><aside class="footnote brackets" id="footnote-8" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/baremetal-part-one.html#footnote-reference-8">8</a><span class="fn-bracket">]</span></span>
<p>Fun fact I've found actual honest to God Google code that violates
this requirement and reprograms the UART on the fly, going against the
obligation in the specs. See here:
<a class="reference external" href="https://github.com/google/early-bringup-tool/blob/main/examples/qemu-armv8A-64/platform/uart/uart.c">https://github.com/google/early-bringup-tool/blob/main/examples/qemu-armv8A-64/platform/uart/uart.c</a></p>
</aside></aside></section>
</div></section>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/accidental-kernel.html" class="u-url">Accidentally becoming a bootloader dev</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                enn
            </span></p>
            <p class="dateline">
            <a href="posts/accidental-kernel.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-07-07T21:10:56+02:00" itemprop="datePublished" title="2022-07-07 21:10">2022-07-07 21:10</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>Figured I'd start off my first proper blogpost with the problem
I recently found myself developing around. Over the years I've been
getting into more and more esoteric shit; I started programming
for real using some spinoff dialect of <code class="docutils literal">BASIC</code>, then hit it off
seriously with <code class="docutils literal">QB64</code> (another, more mainstream dialect), and then
jumped into the deep end with just raw <code class="docutils literal">C++</code> and then <code class="docutils literal">C</code> and a
smattering of other languages.</p>
<p>And you know how it goes, one thing leads to another and you get
caught up in the most fucked up of shit­ <a class="footnote-reference brackets" href="posts/accidental-kernel.html#footnote-1" id="footnote-reference-1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> known to programming
man just because you weren't careful enough to know better. Over
time (say, over the last 18 months) I settled into a weird cycle
of going back and forth between <code class="docutils literal">C</code> and assembly language, and now
I'm feverishly coding in <code class="docutils literal">Aarch64</code>.</p>
<p>So, when a boy meets the unbridled and toxic power of a programming
'language' that is geared towards pain and bitbanging, it's inevitable
that he fall in love, and that love breeds monsters.</p>
<section id="the-first-sin"><h2>The First Sin</h2>
<p>Anyone who's ever programmed in the kernel knows that it's a bit
of a pickle to work with. Unlike in user-space, you're very very
close to the metal, you're working with raw memory addresses,
you're fucking around and abusing the <code class="docutils literal"><span class="pre">alloca()­</span></code> function­ <a class="footnote-reference brackets" href="posts/accidental-kernel.html#footnote-2" id="footnote-reference-2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> and unwinding your
stacks manually to save three cycles on some signal return code
that your compiler foolishly tried to play it safe with. This is
all really cool stuff that you can tell your friends and they'll be
really impressed (if they're absolute geek fucks who have never seen
a titty in their lives), and you'd be the star of the evening.</p>
<p>After three good mouthfuls of whisky you're starting to feel
a bit doozy, and you notice the man in the corner of the room. Who
is he? How did he get here? If you had any bitches, he'd be scaring
them away right this fucking now. You don't have hoes, and the booze
has made sure you definitely have no inhibitions either, so you
come up to him and strike up a conversation.</p>
<p>'Hey, kiddo', he goes, 'do you want to learn about the <em>dark</em> dark
arts, or are you just forever gonna be a cuck and live in the
<em>high-level</em> lands?'</p>
<p>The way he says it oozes with testosterone and the smell of stale
sweat, and you just know you've sold your soul to the devil.</p>
<section id="calling-conventions"><h3>Calling conventions</h3>
<p>An operating system is no good if it can run only one process at
any one time inside only one function. To facilitate the generation of
function intercommunication, compiler vendors figured out that they
should make it so that each individual snippet of code could
be compiled independently after the preprocessor was done with its
thing. All code should have an agreed-upon way of dealing with
the stack and registers the CPU provides, and this means that a form
of convention for calling a function came to be. A calling convention
is basically the agreed-upon way that a caller and its subroutine
deal with memory. On the calling side, the procedure has to deal with
registers and passing arguments when calling a subroutine, how it
gets them returned from the subroutine, and so on. On the called side,
the subroutine handles receiving the args, managing the registers
that its caller did not save, and then returning the result, and all
this in a very rigid very consistent way.</p>
<p>Apart from there necessarily being a calling convention for every
architecture your code runs on (duh), the funny part is that there's
a calling convention for <em>each compiler, vendor</em> and <em>operating system</em>
you're compiling for. This is one of the reasons that, in the old
days of the Wild DOS West, calling a function compiled with a different
compiler than yours would mysteriously return garbage or nonsense
values <a class="footnote-reference brackets" href="posts/accidental-kernel.html#footnote-3" id="footnote-reference-3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a> even though you did absolutely nothing wrong (as far as
you knew). One hairpull trigger for people working on Linux-Windows
interop is also calling convention mismatch: Linux kernel code uses the
<code class="docutils literal">SystemV</code> calling convention expecting the order of arguments to
be <code class="docutils literal">RDI, RSI, RDX, R10, R8, R9</code> and Windows uses Microsoft's x86-64
calling convention that goes <code class="docutils literal">RCX, RDX, R8, R9</code>, and handles
the stack differently (every function call always wastes 32 bytes on Windows).</p>
<p>But calling conventions are a myth. You don't have to use them,
you don't have to care about them, you don't have to respect who saves
what.</p>
<p>But how?</p>
</section><section id="assembly-programming-within-an-operating-system"><h3>Assembly programming within an operating system</h3>
<p>A good and polite compiler like GCC not only looks away when you shoot
yourself in the foot, it politely gives you more ammo to do it when you
run out. One of those footgun bullets is every major compiler letting you
blast raw assembly inline into your code. For example, GCC pretends you're
writing <em>strings</em> for your <em>assembler</em>, and lets you do the following shitfest: <a class="footnote-reference brackets" href="posts/accidental-kernel.html#footnote-4" id="footnote-reference-4" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a></p>
<div class="code"><pre class="code c"><a id="rest_code_82a2088209f741efbb6a9f1c09867b88-1" name="rest_code_82a2088209f741efbb6a9f1c09867b88-1" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-2" name="rest_code_82a2088209f741efbb6a9f1c09867b88-2" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-2"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">;</span><span class="w">  </span><span class="c1">// dummy output spill slots</span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-3" name="rest_code_82a2088209f741efbb6a9f1c09867b88-3" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">;</span><span class="w">  </span><span class="c1">// dummy output tmp registers</span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-4" name="rest_code_82a2088209f741efbb6a9f1c09867b88-4" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-5" name="rest_code_82a2088209f741efbb6a9f1c09867b88-5" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-5"></a>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-6" name="rest_code_82a2088209f741efbb6a9f1c09867b88-6" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-6"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span><span class="s">"# operands: %0  %1  %2  %3  %4  %5  %6  %7  %8</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-7" name="rest_code_82a2088209f741efbb6a9f1c09867b88-7" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-7"></a><span class="w">         </span><span class="s">"imull  $123, %[b], %[res]</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-8" name="rest_code_82a2088209f741efbb6a9f1c09867b88-8" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-8"></a><span class="w">         </span><span class="s">"mov   %[res], %[spill1]</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-9" name="rest_code_82a2088209f741efbb6a9f1c09867b88-9" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-9"></a><span class="w">         </span><span class="s">"mov   %[a], %%ecx</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-10" name="rest_code_82a2088209f741efbb6a9f1c09867b88-10" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-10"></a><span class="w">         </span><span class="s">"mov   %[b], %[tmp1]</span><span class="se">\n\t</span><span class="s">"</span><span class="w">  </span><span class="c1">// let the compiler allocate tmp regs, unless you need specific regs e.g. for a shift count</span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-11" name="rest_code_82a2088209f741efbb6a9f1c09867b88-11" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-11"></a><span class="w">         </span><span class="s">"mov   %[spill1], %[res]</span><span class="se">\n\t</span><span class="s">"</span><span class="w"></span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-12" name="rest_code_82a2088209f741efbb6a9f1c09867b88-12" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-12"></a><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">res</span><span class="p">]</span><span class="w"> </span><span class="s">"=&amp;r"</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="p">),</span><span class="w"></span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-13" name="rest_code_82a2088209f741efbb6a9f1c09867b88-13" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-13"></a><span class="w">      </span><span class="p">[</span><span class="n">tmp1</span><span class="p">]</span><span class="w"> </span><span class="s">"=&amp;r"</span><span class="w"> </span><span class="p">(</span><span class="n">r1</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="n">tmp2</span><span class="p">]</span><span class="w"> </span><span class="s">"=&amp;r"</span><span class="w"> </span><span class="p">(</span><span class="n">r2</span><span class="p">),</span><span class="w">  </span><span class="c1">// early-clobber</span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-14" name="rest_code_82a2088209f741efbb6a9f1c09867b88-14" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-14"></a><span class="w">      </span><span class="p">[</span><span class="n">spill1</span><span class="p">]</span><span class="w"> </span><span class="s">"=m"</span><span class="w"> </span><span class="p">(</span><span class="n">t1</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="n">spill2</span><span class="p">]</span><span class="w"> </span><span class="s">"=&amp;rm"</span><span class="w"> </span><span class="p">(</span><span class="n">t2</span><span class="p">)</span><span class="w">  </span><span class="c1">// allow spilling to a register if there are spare regs</span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-15" name="rest_code_82a2088209f741efbb6a9f1c09867b88-15" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-15"></a><span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="w"> </span><span class="s">"+&amp;r"</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"></span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-16" name="rest_code_82a2088209f741efbb6a9f1c09867b88-16" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-16"></a><span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="s">"+m"</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)[])</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="c1">// dummy in/output instead of memory clobber</span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-17" name="rest_code_82a2088209f741efbb6a9f1c09867b88-17" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-17"></a><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="s">"rmi"</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="w"> </span><span class="s">"rm"</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w">  </span><span class="c1">// a can be an immediate, but b can't</span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-18" name="rest_code_82a2088209f741efbb6a9f1c09867b88-18" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-18"></a><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="s">"ecx"</span><span class="w"></span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-19" name="rest_code_82a2088209f741efbb6a9f1c09867b88-19" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-19"></a><span class="w">    </span><span class="p">);</span><span class="w"></span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-20" name="rest_code_82a2088209f741efbb6a9f1c09867b88-20" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-20"></a>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-21" name="rest_code_82a2088209f741efbb6a9f1c09867b88-21" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-21"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"></span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-22" name="rest_code_82a2088209f741efbb6a9f1c09867b88-22" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-22"></a>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-23" name="rest_code_82a2088209f741efbb6a9f1c09867b88-23" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-23"></a><span class="w">    </span><span class="c1">// p unused in the rest of the function</span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-24" name="rest_code_82a2088209f741efbb6a9f1c09867b88-24" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-24"></a><span class="w">    </span><span class="c1">// so it's really just an input to the asm,</span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-25" name="rest_code_82a2088209f741efbb6a9f1c09867b88-25" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-25"></a><span class="w">    </span><span class="c1">// which the asm is allowed to destroy</span>
<a id="rest_code_82a2088209f741efbb6a9f1c09867b88-26" name="rest_code_82a2088209f741efbb6a9f1c09867b88-26" href="posts/accidental-kernel.html#rest_code_82a2088209f741efbb6a9f1c09867b88-26"></a><span class="p">}</span><span class="w"></span>
</pre></div>
<p>Furthermore, and what's really the funniest jokermode part of this, is that
you can just call (well, <code class="docutils literal">jmp</code> to) functions from within your assembly,
and these other functions can be other assembly, and this lets you bypass the
pesky calling convention, ignore setting up the stack and saving registers
and, the actual Apple of Eden here, gives you a taste of how life is like
when even <code class="docutils literal">C</code> is a <em>high-level</em>, restrained language.</p>
<p>This still means you have to abide by the rules the OS has set out
for you, since the kernel does a lot of scheduling, doesn't let you touch
memory pages that you 'should avoid' and 'are sensitive', and in general
just gets in your way. If you're a Linux bro, you can 'just' go into the
kernel, modify the guards you need or don't need, and rebuild the shit from
source. If you're in Windows land, half the things are locked up tighter
than a nun's cunt, so you're stuck with hacky injections and disassembling
Microsoft's <code class="docutils literal">.dll</code> files.</p>
<p>The real benefits of this approach is when you're really juicing blood from
a stone and trying to optimise the last cycle out of code. Sometimes this
does pay off <a class="footnote-reference brackets" href="posts/accidental-kernel.html#footnote-5" id="footnote-reference-5" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a> and sometimes the compiler is really, truly smarter than
you and the best case code is, in fact, the dumb shit it bleeted out. Admit
defeat.</p>
</section><section id="assembly-programming-deep-in-kernel-land"><h3>Assembly programming deep in kernel land</h3>
<p>Nobody does this one, and for a reason. Code this deep down gets really
nasty and convoluted (at least judging from Linux internals), and you're
doing away with hundreds of manyears of tradition and whatnot. You know
that there's no data types in assembly? It's just chains of bytes, in
an orientation you don't actually know (is it big or little endian?),
without anything to actually tell you what's what. You can just pop a float
from the stack into an integer register, and treat it like a really funky
<code class="docutils literal">int</code>. Nobody will know, nobody will care, and you can do the Quake
square root without any typecasts in mind.</p>
<p>The people who live in this layer are usually the real chads of code dev.
You can tell by how few Rustaceans actually poke their head below the '''systems'''
layer. There really isn't any fun to be had here, and the main places
the Linux kernel uses inline assembly over C code is when doing syscalls,
for checking register states, doing atomic operations and all sorts of
nasty barriers that tell a CPU to stop being smart about its memory or
execution order and to do the things we told it to do in the <em>exact</em> order
we tell it to.</p>
</section></section><section id="the-second-sin"><h2>The Second Sin</h2>
<p>But this wasn't enough. I lived a bit in assembly land but generally
avoided it because I hated recalling the exact sequence of jumping
through hoops every time I wanted to do anything useful with my assembly.
Did you know that inline assembly from within <code class="docutils literal">C++</code> used what's realistically,
but not theoretically, a different calling convention than <code class="docutils literal">C</code> code, except
in the most trivial of cases? <a class="footnote-reference brackets" href="posts/accidental-kernel.html#footnote-6" id="footnote-reference-6" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a> Did you also know that the OS will also
execute your code in a nondeterministic way? <a class="footnote-reference brackets" href="posts/accidental-kernel.html#footnote-7" id="footnote-reference-7" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a></p>
<p>Calling <code class="docutils literal">printf()</code> was a chore, using BIOS interrupts to write text with
was a different chore (who knew that <code class="docutils literal">int 10h</code> was so messy on <code class="docutils literal">x86</code>?),
and don't you even dare think about doing anything graphical with
modern hardware.</p>
<p>No, my second sin was getting a simpler piece of hardware—I got an Arduino
Due and, unfortunately, decided to play with it in assembly. Things got
really fun and I ended up absorbing more knowledge about the board specs
than I really should have (who knew that it was that easy to use clock
mismatches as a RNG that's better than the one provided by the manufacturer?).</p>
<p>The Due is a 'simple' board controlled by a <code class="docutils literal">ATSAM3X8E</code> chip based off
the Arm Cortex-M3 core, running on the ARMv7-M instruction set. The 32-bit ARM
instruction set comes with a whole bunch of goodies that you wouldn't see
the <code class="docutils literal">x86</code> be caught dead with: all instructions work with all registers
(cf. the <code class="docutils literal">x86</code> trying to do <code class="docutils literal">mul</code>), instructions are <em>fixed-width</em>
(meaning you can reason about code size even without assembling!),
and conditional code does not require any jumps since practically
all the instructions have a large number of conditional variants.</p>
<p>But to program the Due you needed practically no fancy magic, you
can just get the board, write absolutely tiny code (as in, your programs
will rarely pop a couple of kilobytes in <code class="docutils literal">C</code> mode), flash it with
your junk code, and just power it up. Unlike the <code class="docutils literal">x86</code> platform,
the startup sequence quite literally is 'start at <code class="docutils literal">0x0</code>, execute
code, interrupt vectors are in the words immediately after the start position'.
There's no juggling with real, unreal or protected mode, no boot sectors,
no trying to claw your way out of 16-bit space to 32-bit.</p>
<p>The compiler the development suite gives you handles most of the work
for you admittedly, but if you pilfer the headers for a few magic numbers
and the correct sequence of memory positions to blast, you can actually
get the Arduino going doing genuine work off an assembly file.</p>
<p>But getting output going beyond 'turn LED on' and input beyond
'button was pressed' was both going to be an electrical chore to wire,
and a bit expensive (screens and whatnot compatible with the
Arduino didn't come cheap at the time), so in my majestic
foolishness I decided I wanted to do Arm assembly programming
on my <code class="docutils literal">x86</code> desktop. This necessitated downloading, installing,
using QEMU.</p>
</section><section id="the-third-sin"><h2>The Third Sin</h2>
<p>So, QEMU is an emulator suite for a bunch of architectures, and a bunch
of computers based off them. In the Arm family it emulates a couple dozen
boards, all of them imperfectly and partially, and all of them in
a very underdocumented way: to get your bearings you have to read
things like the actual source comments (usually outdated), the RedHat
mailing list (—''—), schematics of the boards (sometimes just missing),
of the devices those boards include (...) etc.</p>
<p>So I decided that the next best thing would be to do raw, bare-metal
programming on the <code class="docutils literal">virt</code> board—a fake QEMU platform whose components
you can pick and choose yourself, and that's guaranteed to have the best
emulation experience because it's not tied to actual hardware demands
(did you know that the Raspi boards are booted through their black-box
GPU that runs a binary blob kernel that we have no idea as to how it works?)
and you can just pick and choose parts and QEMU will try and make them work.
The <code class="docutils literal">virt</code> board comes with some predetermined parts as well so you
don't have to do <em>all</em> the picking and choosing, which is cool.</p>
<p>And then you realise, again, that there is absolutely no documentation
for anything you want to do, that nobody's publicly written about what
they did to enable the things you want, and that there is between
'practically no' code and 'no' code out there that does what you want to do.</p>
<p>So the first thing I wanted to do was to write a sort of Hello World
to see any output being displayed. This meant <em>any</em> sort of output
whatsoever from the board to the 'outside world', which for now meant
getting it to write to console.</p>
<p>At this point I was still oblivious.</p>
<p>The way that these kinds of boards communicate with the outside
world is, at its most basic level, just getting a hose of bytes and
blasting a memory location in a specific way until something you want
to happen happens. To get the <code class="docutils literal">virt</code> to shit out text, I had to
talk to the <code class="docutils literal">UART</code> device which QEMU helpfully semiautomatically
maps to <code class="docutils literal">stdout</code> / the console. So you go and read the documentation,
realise you're out of your depth, the links slowly turn from blue
to purple, and it takes you three days to realise what a mess it all is.</p>
<p>The UART is a memory-mapped input-output device (MMIO) that's mapped
to a special memory address somewhere between the flash space (<code class="docutils literal">0x0</code>) and
start of RAM (here that's <code class="docutils literal">0x40000000</code>) and the MMU pretends that
it's a real memory location and not a fake cop-out redirection. So,
to get the thing going I had to:</p>
<ol class="arabic simple">
<li><p>figure out how the fake MMU maps devices</p></li>
<li><p>learn about the <code class="docutils literal">dtb</code> (device-tree blob)</p></li>
<li><p>learn how the UART device works in the real world</p></li>
<li><p>look at UART set-up code for the Raspi3</p></li>
<li><p>translate this into the <code class="docutils literal">virt</code> UART specs</p></li>
<li><p>figure out the location of the <code class="docutils literal">virt</code> UART</p></li>
<li><p>???</p></li>
<li><p>profit?</p></li>
</ol>
<p>One of the first iterations of this code looked give-or-take like this
(magic numbers not included):</p>
<div class="code"><pre class="code asm"><a id="rest_code_9cfb025226844ef69079b8280250db87-1" name="rest_code_9cfb025226844ef69079b8280250db87-1" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-1"></a><span class="nf">ldr</span><span class="w">             </span><span class="no">x0</span><span class="p">,</span><span class="w">  </span><span class="err">=</span><span class="no">AUX_ENABLE</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-2" name="rest_code_9cfb025226844ef69079b8280250db87-2" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-2"></a><span class="nf">ldr</span><span class="w">             </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-3" name="rest_code_9cfb025226844ef69079b8280250db87-3" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-3"></a><span class="nf">and</span><span class="w">             </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-4" name="rest_code_9cfb025226844ef69079b8280250db87-4" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-4"></a><span class="nf">str</span><span class="w">             </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-5" name="rest_code_9cfb025226844ef69079b8280250db87-5" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-5"></a><span class="nf">ldr</span><span class="w">             </span><span class="no">x0</span><span class="p">,</span><span class="w">  </span><span class="err">=</span><span class="no">AUX_MU_CNTL</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-6" name="rest_code_9cfb025226844ef69079b8280250db87-6" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-6"></a><span class="nf">str</span><span class="w">             </span><span class="no">xzr</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-7" name="rest_code_9cfb025226844ef69079b8280250db87-7" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-7"></a><span class="nf">ldr</span><span class="w">             </span><span class="no">x0</span><span class="p">,</span><span class="w">  </span><span class="err">=</span><span class="no">AUX_MU_MCR</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-8" name="rest_code_9cfb025226844ef69079b8280250db87-8" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-8"></a><span class="nf">str</span><span class="w">             </span><span class="no">xzr</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-9" name="rest_code_9cfb025226844ef69079b8280250db87-9" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-9"></a><span class="nf">ldr</span><span class="w">             </span><span class="no">x0</span><span class="p">,</span><span class="w">  </span><span class="err">=</span><span class="no">AUX_MU_IER</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-10" name="rest_code_9cfb025226844ef69079b8280250db87-10" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-10"></a><span class="nf">str</span><span class="w">             </span><span class="no">xzr</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-11" name="rest_code_9cfb025226844ef69079b8280250db87-11" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-11"></a><span class="nf">mov</span><span class="w">             </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="mi">0x3</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-12" name="rest_code_9cfb025226844ef69079b8280250db87-12" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-12"></a><span class="nf">ldr</span><span class="w">             </span><span class="no">x0</span><span class="p">,</span><span class="w">  </span><span class="err">=</span><span class="no">AUX_MU_LCR</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-13" name="rest_code_9cfb025226844ef69079b8280250db87-13" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-13"></a><span class="nf">str</span><span class="w">             </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-14" name="rest_code_9cfb025226844ef69079b8280250db87-14" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-14"></a><span class="nf">mov</span><span class="w">             </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="mi">0xc6</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-15" name="rest_code_9cfb025226844ef69079b8280250db87-15" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-15"></a><span class="nf">ldr</span><span class="w">             </span><span class="no">x0</span><span class="p">,</span><span class="w">  </span><span class="err">=</span><span class="no">AUX_MU_IIR</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-16" name="rest_code_9cfb025226844ef69079b8280250db87-16" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-16"></a><span class="nf">str</span><span class="w">             </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-17" name="rest_code_9cfb025226844ef69079b8280250db87-17" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-17"></a><span class="nf">mov</span><span class="w">             </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="mi">0x48</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-18" name="rest_code_9cfb025226844ef69079b8280250db87-18" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-18"></a><span class="nf">mov</span><span class="w">             </span><span class="no">x0</span><span class="p">,</span><span class="w">  </span><span class="err">=</span><span class="no">AUX_MU_BAUD</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-19" name="rest_code_9cfb025226844ef69079b8280250db87-19" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-19"></a><span class="nf">str</span><span class="w">             </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-20" name="rest_code_9cfb025226844ef69079b8280250db87-20" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-20"></a>
<a id="rest_code_9cfb025226844ef69079b8280250db87-21" name="rest_code_9cfb025226844ef69079b8280250db87-21" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-21"></a><span class="nf">ldr</span><span class="w">             </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="err">=</span><span class="no">GPFSEL1</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-22" name="rest_code_9cfb025226844ef69079b8280250db87-22" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-22"></a><span class="nf">mov</span><span class="w">             </span><span class="no">x2</span><span class="p">,</span><span class="w">  </span><span class="mi">0x3F000</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-23" name="rest_code_9cfb025226844ef69079b8280250db87-23" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-23"></a><span class="nf">and</span><span class="w">             </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-24" name="rest_code_9cfb025226844ef69079b8280250db87-24" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-24"></a><span class="nf">mov</span><span class="w">             </span><span class="no">x2</span><span class="p">,</span><span class="w">  </span><span class="mi">#1152</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-25" name="rest_code_9cfb025226844ef69079b8280250db87-25" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-25"></a><span class="nf">mov</span><span class="w">             </span><span class="no">x3</span><span class="p">,</span><span class="w">  </span><span class="mi">#64</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-26" name="rest_code_9cfb025226844ef69079b8280250db87-26" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-26"></a><span class="nf">mul</span><span class="w">             </span><span class="no">x2</span><span class="p">,</span><span class="w">  </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-27" name="rest_code_9cfb025226844ef69079b8280250db87-27" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-27"></a><span class="nf">orr</span><span class="w">             </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-28" name="rest_code_9cfb025226844ef69079b8280250db87-28" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-28"></a><span class="nf">ldr</span><span class="w">             </span><span class="no">x0</span><span class="p">,</span><span class="w">  </span><span class="err">=</span><span class="no">GPFSEL1</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-29" name="rest_code_9cfb025226844ef69079b8280250db87-29" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-29"></a><span class="nf">str</span><span class="w">             </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-30" name="rest_code_9cfb025226844ef69079b8280250db87-30" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-30"></a><span class="nf">ldr</span><span class="w">             </span><span class="no">x0</span><span class="p">,</span><span class="w">  </span><span class="err">=</span><span class="no">GPPUD</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-31" name="rest_code_9cfb025226844ef69079b8280250db87-31" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-31"></a><span class="nf">str</span><span class="w">             </span><span class="no">xzr</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-32" name="rest_code_9cfb025226844ef69079b8280250db87-32" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-32"></a>
<a id="rest_code_9cfb025226844ef69079b8280250db87-33" name="rest_code_9cfb025226844ef69079b8280250db87-33" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-33"></a><span class="nf">mov</span><span class="w">     </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0xA0</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-34" name="rest_code_9cfb025226844ef69079b8280250db87-34" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-34"></a><span class="nl">_loop_1:</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-35" name="rest_code_9cfb025226844ef69079b8280250db87-35" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-35"></a><span class="w">        </span><span class="nf">sub</span><span class="w">             </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-36" name="rest_code_9cfb025226844ef69079b8280250db87-36" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-36"></a><span class="w">        </span><span class="nf">nop</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-37" name="rest_code_9cfb025226844ef69079b8280250db87-37" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-37"></a><span class="w">        </span><span class="nf">cbnz</span><span class="w">            </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">_loop_1</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-38" name="rest_code_9cfb025226844ef69079b8280250db87-38" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-38"></a>
<a id="rest_code_9cfb025226844ef69079b8280250db87-39" name="rest_code_9cfb025226844ef69079b8280250db87-39" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-39"></a><span class="nf">mov</span><span class="w">     </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="mi">0xC000</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-40" name="rest_code_9cfb025226844ef69079b8280250db87-40" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-40"></a><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w">  </span><span class="err">=</span><span class="no">GPPUDCLK0</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-41" name="rest_code_9cfb025226844ef69079b8280250db87-41" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-41"></a><span class="nf">str</span><span class="w">     </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-42" name="rest_code_9cfb025226844ef69079b8280250db87-42" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-42"></a>
<a id="rest_code_9cfb025226844ef69079b8280250db87-43" name="rest_code_9cfb025226844ef69079b8280250db87-43" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-43"></a><span class="nf">mov</span><span class="w">     </span><span class="no">x2</span><span class="p">,</span><span class="w">  </span><span class="mi">0xA0</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-44" name="rest_code_9cfb025226844ef69079b8280250db87-44" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-44"></a><span class="nl">_loop_2:</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-45" name="rest_code_9cfb025226844ef69079b8280250db87-45" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-45"></a><span class="w">        </span><span class="nf">sub</span><span class="w">  </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-46" name="rest_code_9cfb025226844ef69079b8280250db87-46" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-46"></a><span class="w">        </span><span class="nf">nop</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-47" name="rest_code_9cfb025226844ef69079b8280250db87-47" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-47"></a><span class="w">        </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">_loop_2</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-48" name="rest_code_9cfb025226844ef69079b8280250db87-48" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-48"></a>
<a id="rest_code_9cfb025226844ef69079b8280250db87-49" name="rest_code_9cfb025226844ef69079b8280250db87-49" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-49"></a><span class="nf">str</span><span class="w">     </span><span class="no">xzr</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-50" name="rest_code_9cfb025226844ef69079b8280250db87-50" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-50"></a><span class="nf">mov</span><span class="w">     </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="mi">0x3</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-51" name="rest_code_9cfb025226844ef69079b8280250db87-51" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-51"></a><span class="nf">ldr</span><span class="w">     </span><span class="no">x0</span><span class="p">,</span><span class="w">  </span><span class="err">=</span><span class="no">AUX_MU_CNTL</span><span class="w"></span>
<a id="rest_code_9cfb025226844ef69079b8280250db87-52" name="rest_code_9cfb025226844ef69079b8280250db87-52" href="posts/accidental-kernel.html#rest_code_9cfb025226844ef69079b8280250db87-52"></a><span class="nf">str</span><span class="w">     </span><span class="no">x1</span><span class="p">,</span><span class="w">  </span><span class="p">[</span><span class="no">x0</span><span class="p">]</span><span class="w"></span>
</pre></div>
<p>Basically, you 'have' to make sure the device
is enabled and ready to accept data from you,
you need to map its 'pins' to MMIO addresses
the MMU exposed to you, etc etc etc. This specific
snippet crashed and burned, so I spun the wheels for like a week
and eventually settled on like 3x the amount of code
only to get the ability to blit a <em>single byte</em> at a
time at this device, passing its contents to the <code class="docutils literal">stdout</code>
in the dumbest and most unsafe possible way since
I think I just stopped caring about things at that point:</p>
<div class="code"><pre class="code asm"><a id="rest_code_86988ab8a5e8462b91ea2de14ca89861-1" name="rest_code_86988ab8a5e8462b91ea2de14ca89861-1" href="posts/accidental-kernel.html#rest_code_86988ab8a5e8462b91ea2de14ca89861-1"></a><span class="nf">mov</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x40</span><span class="w"></span>
<a id="rest_code_86988ab8a5e8462b91ea2de14ca89861-2" name="rest_code_86988ab8a5e8462b91ea2de14ca89861-2" href="posts/accidental-kernel.html#rest_code_86988ab8a5e8462b91ea2de14ca89861-2"></a><span class="nf">ldr</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="err">=</span><span class="no">AUX_MU_IO</span><span class="w"></span>
<a id="rest_code_86988ab8a5e8462b91ea2de14ca89861-3" name="rest_code_86988ab8a5e8462b91ea2de14ca89861-3" href="posts/accidental-kernel.html#rest_code_86988ab8a5e8462b91ea2de14ca89861-3"></a><span class="nf">str</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x1</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_86988ab8a5e8462b91ea2de14ca89861-4" name="rest_code_86988ab8a5e8462b91ea2de14ca89861-4" href="posts/accidental-kernel.html#rest_code_86988ab8a5e8462b91ea2de14ca89861-4"></a><span class="nf">add</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span><span class="w"></span>
<a id="rest_code_86988ab8a5e8462b91ea2de14ca89861-5" name="rest_code_86988ab8a5e8462b91ea2de14ca89861-5" href="posts/accidental-kernel.html#rest_code_86988ab8a5e8462b91ea2de14ca89861-5"></a><span class="nf">str</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x1</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_86988ab8a5e8462b91ea2de14ca89861-6" name="rest_code_86988ab8a5e8462b91ea2de14ca89861-6" href="posts/accidental-kernel.html#rest_code_86988ab8a5e8462b91ea2de14ca89861-6"></a><span class="nf">add</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span><span class="w"></span>
<a id="rest_code_86988ab8a5e8462b91ea2de14ca89861-7" name="rest_code_86988ab8a5e8462b91ea2de14ca89861-7" href="posts/accidental-kernel.html#rest_code_86988ab8a5e8462b91ea2de14ca89861-7"></a><span class="nf">str</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x1</span><span class="p">]</span><span class="w"></span>
<a id="rest_code_86988ab8a5e8462b91ea2de14ca89861-8" name="rest_code_86988ab8a5e8462b91ea2de14ca89861-8" href="posts/accidental-kernel.html#rest_code_86988ab8a5e8462b91ea2de14ca89861-8"></a><span class="nf">b.</span><span class="w"></span>
</pre></div>
<p>No checking whether the device is ready to accept another byte, no
checking if it's written or has errored, no gods no kings.</p>
<p>I was still oblivious, yeah?</p>
<p>So having enabled the UART and gotten the proverbial Hello World out
(though ofc I hadn't wrtten a string printer just yet, it would've
been trivial though), I figured might as well figure out the other
devices and see how they get set up.</p>
<p>The first one on the list was the framebuffer. Basically, the dumbest
possible way to blit pixels onto a surface is to set up a framebuffer
device with the appropriate dimensions, pitch (how many bytes per
row of pixels), pixel format (i.e. bits per colour and order of colours)
and give it a chunk of RAM to read from to the screen.</p>
<p>The setup for this was even more hellish than the above, since the
documentation was actually <em>totally absent</em>, so I had to resort
to the aforementioned RedHat mailing list, and reading the source
for SeaBIOS and the U-Boot bootloader, and then read some more
QEMU source code (why does the documentation actually suck so much?)
etc etc. In short:</p>
<ol class="arabic simple">
<li><p>to set up the image, the framebuffer device needs to be set up</p></li>
<li><p>the way to set up the device is using QEMU's wonderfully underdocumented <code class="docutils literal">fw_cfg</code></p></li>
<li><p>you need to also verify whether your CPU has something called the 'dma' via the magic number <code class="docutils literal">0x51454d5520434647</code></p></li>
<li><p>it works by going through the configuration zone looking for a honest to God <em>string</em> value</p></li>
<li><p>when you find it, you then write a bunch of shit to the config object</p></li>
<li><p>specifically, you need the dimensions, format, pitch and address</p></li>
<li><p>voilà! works magically</p></li>
</ol>
<p>This took like a week I think. But then, I could just write raw bytes to
the designated RAM space and things ~just worked~, and I got my dumb little
images to display with actually no difficulty at all. Godless magic, and I
still didn't see the error of my ways.</p>
</section><section id="moment-of-truth"><h2>Moment of Truth</h2>
<p>The moment where I cracked was when I tried to get
persistent storage set up, and then I realised what a fucking
fool I'd been for genuine weeks then.</p>
<p>The way I wanted to do storage was via a <code class="docutils literal"><span class="pre">virtio-blk-device</span></code>
which was a simple, abstract interface device for reading and
writing to an image file for board emulator developers, and the
interface it provides is, allegedly, a very decent scheme that
gives <em>bootloader</em> coders another option for storage schemes.
As a wise man once said: 'The intent of virtio devices is to be
implemented by hypervisors (such as QEMU). They simplify things a bit,
so that it’s easier and more efficient for hypervisors and guests to
communicate, without having to emulate any quirks of real hardware devices.' <a class="footnote-reference brackets" href="posts/accidental-kernel.html#footnote-8" id="footnote-reference-8" role="doc-noteref"><span class="fn-bracket">[</span>8<span class="fn-bracket">]</span></a></p>
<p>It reads and writes in 512-byte sectors, is of course also
memory-mapped in its own specific funny way, and to get the device
set up you need to first <em>discover its secret!! location o:</em> by
checking more magic numbers (in this case we want <code class="docutils literal">0x74726976</code>)
and then the device type, and then finally you have to
actually <em>talk to the device</em> to tell it that it's been
discovered and that you have a driver for it, and then you
have to <em>negotiate</em> (yes, that's apparently the term) with it
to see what intersection of features is supported by both
your driver and the device <img alt="BroFrustration" src="emoji/brofrustration.png" style="width: 32px;"></p>
<p>And this is where I broke. After a knee-deep slough through
the code in the SeaBIOS repository, <em>again</em>, I ended up
on the fucking <em>OSDev</em> bootloader page, which is where
I realised that the monkey business I've been blindly doing has,
all this time, been writing drivers in a primitive retarded
bootloader that I never wanted or needed.</p>
<p>And all I ever fucking wanted was a simple platform to write
some funny <code class="docutils literal">armasm</code> and get haha clown results back, not this
level of convoluted hoopjumping that once again revealed how genuinely
rancid software development is once you get to talk to your devices
on your own terms. The amount of fucky code I had to write, bin,
rewrite over the past months, and the amount of hoops I had to
jump and <em>will</em> have to jump if I want persistent storage, is
making me start to reconsider writing at least some of this
code in <code class="docutils literal">C</code>—but then what's the point?</p>
<p>I started this
to avoid doing that, so I'm at the fucked up crossroads of
damned if I do, damned if I don't.</p>
<hr class="docutils">
<aside class="footnote-list brackets"><aside class="footnote brackets" id="footnote-1" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/accidental-kernel.html#footnote-reference-1">1</a><span class="fn-bracket">]</span></span>
<p>Specifically, here I mean I fucked up
and got <em>really really</em> into Brainfuck
programming and algorithmics. Yeah.</p>
</aside><aside class="footnote brackets" id="footnote-2" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/accidental-kernel.html#footnote-reference-2">2</a><span class="fn-bracket">]</span></span>
<p>A dear friend introduced plebian me
to this monster of a function. So,
<code class="docutils literal">malloc()</code> pings the OS to give
you a <code class="docutils literal">void</code> pointer to memory of a
certain size on the heap expecting you
to behave really nicely; if <code class="docutils literal">malloc()</code>
is a function for boys, <code class="docutils literal">alloca()</code>
is a function for men: it allocates a
block of memory <em>on the stack</em>, and you
can't know if there's enough room for it
because, unlike <code class="docutils literal">malloc()</code> which politely
tells you it failed in the return value,
a fail in <code class="docutils literal">alloca()</code> just means you
overflowed the stack and, since we're
in kernel space, are overwriting operating
system code or memory as we speak unopposed.
At least user-space is polite enough to
segfault you out of this misery.</p>
</aside><aside class="footnote brackets" id="footnote-3" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/accidental-kernel.html#footnote-reference-3">3</a><span class="fn-bracket">]</span></span>
<p>Specifically, this would occur when
using a program compiled for <code class="docutils literal">Win95</code> and
calling a <code class="docutils literal">Win3.x</code> function with more than
two arguments in it; the <code class="docutils literal">Pascal</code> calling
convention that was set up by Borland
Pascal was the convention common in <code class="docutils literal">Win3.x</code>
API, and the later <code class="docutils literal">Win32</code> API used
the <code class="docutils literal">stdcall</code> calling convention that
was register-compatible and stack-compatible
with <code class="docutils literal">Pascal</code>'s, but <em>reversed the fucking</em>
<em>order of arguments</em> for some reason.</p>
</aside><aside class="footnote brackets" id="footnote-4" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/accidental-kernel.html#footnote-reference-4">4</a><span class="fn-bracket">]</span></span>
<p>from <a class="reference external" href="https://stackoverflow.com/a/48877683/">https://stackoverflow.com/a/48877683/</a></p>
</aside><aside class="footnote brackets" id="footnote-5" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/accidental-kernel.html#footnote-reference-5">5</a><span class="fn-bracket">]</span></span>
<p>There's this dude that managed to squeeze
just <em>so</em> much blood out of a stone that he made
a <a class="reference external" href="https://tech.marksblogg.com/fastest-fizz-buzz.html">Fizz-Buzz</a> impementation that produced 16 bytes
of fizz per CPU cycle, at a rate of 56 GB/s.</p>
</aside></aside><aside class="footnote-list brackets"><aside class="footnote brackets" id="footnote-6" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/accidental-kernel.html#footnote-reference-6">6</a><span class="fn-bracket">]</span></span>
<p>Specifically, the <code class="docutils literal">C++</code> compiler passes
a hidden pointer to <code class="docutils literal">this</code> in the first available
register, meaning that now instead of <code class="docutils literal">RDI</code> your
first argument is passed in through <code class="docutils literal">RSI</code> if you're
on Linux.</p>
</aside><aside class="footnote brackets" id="footnote-7" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/accidental-kernel.html#footnote-reference-7">7</a><span class="fn-bracket">]</span></span>
<p>You can use the task scheduler as a funky RNG if
you're feeling wicked enough.</p>
</aside><aside class="footnote brackets" id="footnote-8" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/accidental-kernel.html#footnote-reference-8">8</a><span class="fn-bracket">]</span></span>
<p>from <a class="reference external" href="https://brennan.io/2020/03/22/sos-block-device/">https://brennan.io/2020/03/22/sos-block-device/</a>, which
I wish I'd read before spending three days on this in vain.</p>
</aside></aside></section>
</div>
    </article>
</div>



    





        <!--End of body content-->

        <footer id="footer">
            Contents © 2025         <a href="mailto:whocares0@gmail.com">enn</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
